<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Lan√ßamento - F√°brica de Massa</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <style>
/* ================================================================ */
/* =========== LAYOUT MODERNO PARA A F√ÅBRICA DE MASSA =========== */
/* ================================================================ */

        /* ================================================================ */
/* =========== ESTILO PLANILHA PARA TABELAS DA P√ÅGINA =========== */
/* ================================================================ */

/* Remove a borda inferior do estilo moderno para estas tabelas */
#tabProducao table th, #tabProducao table td,
#tabPesagem table th, #tabPesagem table td,
#tabMoagem table th, #tabMoagem table td,
#tabOperadores table th, #tabOperadores table td { /* <-- ADICIONADO #tabOperadores */
    border-bottom: none;
}

/* Aplica o estilo de borda e centraliza√ß√£o nas tabelas de hist√≥rico e pesagem */
#tabProducao table th, #tabProducao table td,
#tabPesagem table th, #tabPesagem table td,
#tabMoagem table th, #tabMoagem table td,
#tabOperadores table th, #tabOperadores table td { /* <-- ADICIONADO #tabOperadores */
    border: 1px solid var(--border-color);
    text-align: center;
    white-space: normal; /* Permite que o texto quebre a linha */
    padding: 0.5rem;
}

/* Estiliza o cabe√ßalho para ter fundo azul e texto branco */
#tabProducao table th,
#tabPesagem table th,
#tabMoagem table th,
#tabOperadores table th { /* <-- ADICIONADO #tabOperadores */
    background-color: var(--primary);
    color: white;
    font-weight: bold;
}

/* Adiciona o efeito de "zebra" (linhas alternadas) no corpo da tabela */
#tabProducao tbody tr:nth-child(2n),
#tabPesagem tbody tr:nth-child(2n),
#tabMoagem tbody tr:nth-child(2n),
#tabOperadores tbody tr:nth-child(2n) { /* <-- ADICIONADO #tabOperadores */
    background-color: var(--bg-color);
}

/* Mant√©m o efeito hover, exceto na linha de detalhes */
#tabProducao tbody tr:not(.linha-detalhes):hover,
#tabPesagem tbody tr:hover,
#tabMoagem tbody tr:not(.linha-detalhes):hover,
#tabOperadores tbody tr:hover { /* <-- ADICIONADO #tabOperadores */
    background-color: hsl(var(--primary-hue), 80%, 90%);
}

:root {
    --primary-hue: 210; /* Tom de azul */
    --primary: hsl(var(--primary-hue), 80%, 55%);
    --primary-light: hsl(var(--primary-hue), 80%, 97%);
    --primary-dark: hsl(var(--primary-hue), 80%, 45%);
    --accent: #ff9900;
    --danger: #dc3545;
    --success: #28a745;
    --text-dark: #2c3e50;
    --text-light: #7f8c8d;
    --bg-color: #f8f9fa;
    --card-bg: #ffffff;
    --border-color: #e0e6ef;
    --shadow-color: rgba(149, 157, 165, 0.2);
}

* { box-sizing: border-box; }

body {
    font-family: 'Inter', sans-serif; /* <-- NOVA FONTE */
    margin: 0;
    background: var(--bg-color);
    color: var(--text-dark);
    line-height: 1.6;
}

header {
    background: var(--primary);
    color: white;
    padding: 1rem 1.25rem;
    text-align: center;
    border-bottom: 4px solid var(--primary-dark);
}

h1, h2, h3 { margin: 0 0 1rem; }
h1 { font-size: 1.75rem; }
h2 { 
    font-size: 1.5rem; padding-bottom: 0.5rem; 
    border-bottom: 1px solid var(--border-color);
    display: flex; /* Para alinhar o bot√£o de config */
    justify-content: space-between;
    align-items: center;
}
h3 { font-size: 1.1rem; color: var(--text-light); }

.container {
    max-width: 1100px;
    margin: 2rem auto;
    padding: 2rem;
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 8px 24px var(--shadow-color);
    position: relative;
}

/* --- NAVEGA√á√ÉO SUPERIOR E ABAS --- */
.nav-container {
    max-width: 1100px; margin: 1rem auto; padding: 0 2rem;
}
.back-link {
    display: inline-block;
    background: var(--success);
    color: white;
    text-decoration: none;
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    font-weight: 700;
    transition: all 0.2s ease-in-out;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.back-link:hover {
    background: #218838;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}
.tab-nav {
    display: flex; flex-wrap: wrap; /* Permite quebra de linha em telas pequenas */
    gap: 1rem; margin-bottom: 2rem;
    border-bottom: 1px solid var(--border-color);
}
.tab-link {
    color: var(--text-light);
    cursor: pointer;
    background: none; border: none;
    font-size: 1rem; font-weight: 500;
    padding: 0.75rem 0.25rem;
    border-bottom: 3px solid transparent;
    transition: all 0.2s ease-in-out;
}
.tab-link:hover { color: var(--primary); }
.tab-link.active {
    color: var(--primary); font-weight: 700;
    border-bottom-color: var(--primary);
}
.tab-content { display: none; }
.tab-content.active { display: block; }

/* --- FORMUL√ÅRIOS E BOT√ïES --- */
form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}
/* ================================================================ */
/* ============= NOVO: AJUSTE PARA 2 COLUNAS NOS FORMS ============ */
/* ================================================================ */

  /* #formMassa, #formPesagem, #formOperador com 2 colunas */
  #formMassa, #formPesagem, #formOperador {
    grid-template-columns: repeat(2, 1fr);
  }
  
  /* #formMoagem com 3 colunas para melhor distribui√ß√£o */
  #formMoagem {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.25rem;
  }
        
label {
    font-size: 0.8rem; font-weight: 700; margin-bottom: 0.5rem;
    display: block; color: var(--text-light); text-transform: uppercase;
}
input, select, textarea {
    width: 100%; padding: 0.8rem; border: 1px solid var(--border-color);
    border-radius: 8px; font-size: 1rem; background-color: var(--bg-color);
    transition: border-color 0.2s, box-shadow 0.2s;
}
input:focus, select:focus, textarea:focus {
    outline: none; border-color: var(--primary); background-color: var(--card-bg);
    box-shadow: 0 0 0 3px hsla(var(--primary-hue), 80%, 55%, 0.2);
}
textarea { min-height: 80px; resize: vertical; }
.full-width { grid-column: 1 / -1; }
.form-actions {
    grid-column: 1 / -1; display: flex;
    justify-content: flex-end; gap: 0.75rem; margin-top: 1rem;
}
button {
    background: var(--primary); color: white; border: none;
    padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer;
    font-weight: 700; font-size: 0.9rem;
    transition: all 0.2s ease-in-out;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
button:hover {
    filter: none; background: var(--primary-dark);
    transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}
button:active { transform: translateY(0); }
button.secondary { background: #e0e6ef; color: var(--text-dark); }
button.secondary:hover { background: #cfd8e3; }
button.delete-btn { background: var(--danger); }
button.edit-btn { background: var(--accent); margin-right: 5px; }
button.excel-btn { background: var(--success); }

/* --- TABELAS --- */
.history-section { margin-top: 2.5rem; }
.filters, .dashboard-filters {
    display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: flex-end;
    margin-bottom: 1.5rem; padding: 1rem;
    background-color: var(--primary-light); border-radius: 12px;
}
table {
    width: 100%; border-collapse: collapse; margin-top: 1.5rem;
}
th, td {
    padding: 1rem; text-align: left; font-size: 0.9rem;
    border: none; border-bottom: 1px solid var(--border-color);
}
th {
    background: none; color: var(--text-light); font-weight: 700;
    text-transform: uppercase; font-size: 0.75rem;
}
tbody tr:not(.linha-detalhes):hover { background-color: var(--primary-light); }
.efficiency-good { color: var(--success); font-weight: bold; }
.efficiency-ok { color: var(--accent); font-weight: bold; }
.efficiency-bad { color: var(--danger); font-weight: bold; }

/* --- SE√á√ÉO DE PALETES (Filtro Prensa) --- */
.paletes-fieldset {
    grid-column: 1 / -1; border: 1px solid var(--border-color);
    border-radius: 12px; padding: 1.5rem; margin-top: 1rem;
}
.paletes-fieldset legend,
.moagem-fieldset legend { /* <-- Estilo para fieldset moagem */
    font-weight: 700; color: var(--primary);
    padding: 0 0.5rem; font-size: 1rem; text-transform: uppercase;
}
.palete-entry-row {
    display: grid; grid-template-columns: 2fr 1fr auto;
    gap: 1rem; align-items: center; margin-bottom: 1rem;
}
#kgPalete {
    background-color: var(--primary-light); font-weight: bold; color: var(--primary);
}

/* --- SE√á√ÉO MOAGEM --- */
.moagem-fieldset {
    grid-column: 1 / -1; border: 1px solid var(--border-color);
    border-radius: 12px; padding: 1.5rem; margin-top: 1rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.25rem;
}
/* Container para cargas din√¢micas */
#cargasContainerMoagem {
    grid-column: 1 / -1;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    border-top: 1px solid var(--border-color);
    padding-top: 1rem;
    margin-top: 0.5rem;
}
.carga-moagem-row {
    display: grid;
    grid-template-columns: 100px 1fr;
    gap: 0.5rem;
    align-items: center;
}
.carga-moagem-row label {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-dark);
    margin: 0;
    text-transform: none;
    text-align: right;
}
/* Campos condicionais */
.campo-condicional {
    display: none; /* Oculto por padr√£o */
}
/* Estilo para input "Sim/N√£o" e campo condicional lado a lado */
.campo-com-condicional {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    align-items: flex-end;
}


/* --- DETALHES EXPANS√çVEIS --- */
.linha-detalhes { display: none; background-color: var(--primary-light); }
.linha-detalhes td { padding: 1rem 1.5rem; text-align: left !important; }
.detalhe-grid {¬†
    display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1rem;¬†
}
.detalhe-grid span {¬†
    font-weight: bold; color: var(--primary);
    display: block; margin-bottom: 0.25rem;
}
/* --- NOVO ESTILO PARA O BOT√ÉO EXPANDIR --- */
.expand-btn {
    background: transparent;
    border: none;
    padding: 4px;
    cursor: pointer;
    display: flex; /* Essencial para alinhar o √≠cone SVG */
    align-items: center;
    justify-content: center;
    margin: 0 auto; /* Centraliza o bot√£o na c√©lula da tabela */
    transition: transform 0.2s ease-in-out; /* Anima√ß√£o de rota√ß√£o */
}
.expand-btn svg {
    width: 14px; /* Tamanho do √≠cone (voc√™ pode diminuir aqui se quiser) */
    height: 14px;
    color: var(--text-light); /* Cor padr√£o do √≠cone */
}
.expand-btn:hover svg {
    color: var(--primary); /* Cor do √≠cone ao passar o mouse */
}
.expand-btn.open {
    transform: rotate(90deg); /* Gira o √≠cone 90 graus quando a classe 'open' √© adicionada */
}

/* --- DASHBOARD E GR√ÅFICOS --- */
.kpi-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.25rem; margin-bottom: 2.5rem;
}
.kpi-card {
    background: var(--card-bg); padding: 1.5rem; border-radius: 12px;
    border: 1px solid var(--border-color);
    transition: all 0.2s ease-in-out;
}
.kpi-card:hover {
    transform: translateY(-4px); box-shadow: 0 8px 24px var(--shadow-color);
}
.kpi-card h3 {
    font-size: 0.9rem; color: var(--text-light); margin: 0 0 0.5rem;
    font-weight: 500;
}
.kpi-card .value {
    font-size: 2.25rem; font-weight: 700; color: var(--text-dark);
}
.kpi-card.efficiency .value.good { color: var(--success); }
.kpi-card.efficiency .value.bad { color: var(--danger); }
.chart-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
}
.chart-container {
    background-color: var(--card-bg); padding: 1.5rem;
    border-radius: 12px; border: 1px solid var(--border-color);
}
.chart-container h3 { margin-top: 0; text-align: center; }

/* --- MODAL DE CONFIGURA√á√ÉO --- */
#openConfigBtn {
    position: absolute; top: 1.5rem; right: 1.5rem;
    background: none; border: none; color: var(--text-light); font-size: 1.5rem;
    padding: 0.4rem 0.7rem; cursor: pointer; transition: all 0.2s;
}
#openConfigBtn:hover { color: var(--primary); transform: rotate(15deg); }

/* Bot√£o de config da Moagem */
#openConfigMoagemBtn {
    background: none; border: none; color: var(--text-light); font-size: 1.2rem;
    padding: 0.2rem 0.5rem; cursor: pointer; transition: all 0.2s;
    margin-left: auto; /* Joga para a direita */
}
#openConfigMoagemBtn:hover { color: var(--primary); transform: rotate(15deg); }


.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); display: none;
    justify-content: center; align-items: center; z-index: 1000;
    padding: 1rem;
}
.modal-content {
    background: white; padding: 2rem; border-radius: 16px;
    width: 90%; max-width: 700px;
    max-height: 90vh; /* Altura m√°xima */
    overflow-y: auto; /* Scroll se conte√∫do for maior */
}
.modal-content h3 {
    margin-top: 0;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}
/* Grid para modais */
.config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.25rem;
}
.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-color);
}
.modal-actions input[type="password"] {
    margin-right: auto; /* Empurra senha para esquerda */
}


/* --- Estilos de Impress√£o (Mantidos) --- */
@page { size: landscape; margin: 15mm; }
@media print {
    body { background: #fff !important; font-size: 10pt; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    body > header, .nav-container, #openConfigBtn, #openConfigMoagemBtn, .tab-nav, #tabProducao, #tabPesagem, #tabMoagem, #tabOperadores, .dashboard-filters, .expand-btn, .delete-btn, .edit-btn, .excel-btn, .form-actions, #printDashboardBtn { /* <-- ADICIONADO #tabOperadores */
        display: none !important;
    }
    .tab-content, #tabDashboard { display: block !important; }
    .container {
        box-shadow: none !important; border: none !important; padding: 0 !important;
        margin: 0 !important; width: 100% !important; max-width: 100% !important;
    }
    #tabDashboard::before {
        content: 'Relat√≥rio de Produ√ß√£o - F√°brica de Massa';
        display: block; text-align: center; font-size: 1.4rem; font-weight: bold;
        margin-bottom: 1.5rem; border-bottom: 2px solid #333; padding-bottom: 1rem;
    }
    h2 { display: none; }
    .kpi-grid { margin-bottom: 1rem; gap: 1rem; }
    .kpi-card { padding: 0.8rem; border: 1px solid var(--border-color) !important; box-shadow: none !important; }
    .kpi-card h3 { font-size: 0.8rem; margin-bottom: 0.2rem; }
    .kpi-card .value { font-size: 1.8rem; }
    .chart-grid { grid-template-columns: 1fr 1fr; gap: 1rem; }
    .chart-container { padding: 1rem; page-break-inside: avoid; box-shadow: none !important; border: 1px solid var(--border-color) !important;}
    .chart-container h3 { font-size: 1rem; margin-bottom: 0.5rem; }
}
        /* ================================================================ */
/* ============== REDU√á√ÉO DE TAMANHO BOT√ïES DE A√á√ÉO =============== */
/* ================================================================ */

/* Alvo: Bot√µes de Editar e Excluir */
.edit-btn, .delete-btn {
    padding: 0.3rem 0.8rem; /* Padding vertical e horizontal reduzido */
    font-size: 0.75rem;     /* Tamanho da fonte um pouco menor */
}

/* --- NOVO ESTILO PARA O BOT√ÉO EXPANDIR --- */
.expand-btn {
    background: transparent;
    border: none;
    padding: 4px;
    cursor: pointer;
    display: flex; /* Essencial para alinhar o √≠cone SVG */
    align-items: center;
    justify-content: center;
    margin: 0 auto; /* Centraliza o bot√£o na c√©lula da tabela */
    transition: transform 0.2s ease-in-out; /* Anima√ß√£o de rota√ß√£o */
}
.expand-btn svg {
    width: 14px; /* Tamanho do √≠cone (voc√™ pode diminuir aqui se quiser) */
    height: 14px;
    color: var(--text-light); /* Cor padr√£o do √≠cone */
}
.expand-btn:hover svg {
    color: var(--primary); /* Cor do √≠cone ao passar o mouse */
}
.expand-btn.open {
    transform: rotate(90deg); /* Gira o √≠cone 90 graus quando a classe 'open' √© adicionada */
}
</style>
</head>
<body>
    <header>
        <h1>F√°brica de Massa - Lan√ßamento</h1>
    </header>

    <div class="nav-container">
        <a href="index.html" class="back-link">‚ùÆ Voltar para Produ√ß√£o Cer√¢mica</a>
    </div>

    <div class="container">
        <!-- Bot√£o Config Geral (Filtro Prensa) -->
        <button id="openConfigBtn" title="Configura√ß√µes de Pesos e Metas (Filtro Prensa)" onclick="openConfigModal()">‚öôÔ∏è</button>
        
        <div class="tab-nav">
            <button class="tab-link active" onclick="showTab('producao')">Filtro Prensa</button>
            <button class="tab-link" onclick="showTab('moagem')">Moagem</button>
            <button class="tab-link" onclick="showTab('pesagem')">Pesagem</button>
            <!-- NOVA ABA OPERADORES -->
            <button class="tab-link" onclick="showTab('operadores')">Operadores</button>
            <button class="tab-link" onclick="showTab('dashboard')">Dashboard</button>
        </div>

        <!-- 1. CONTE√öDO FILTRO PRENSA (ANTIGO 'PRODU√á√ÉO') -->
        <div id="tabProducao" class="tab-content active">
            <section>
                <h2>Lan√ßar Produ√ß√£o (Filtro Prensa)</h2>
                <form id="formMassa">
                    <div> <label for="data">Data</label> <input type="date" id="data" required> </div>
                    <div> <label for="turno">Turno</label> <select id="turno" required> <option value="">Selecione um turno</option> <option>Comercial</option> <option>Turno 1 (6x2)</option> <option>Turno 2 (6x2)</option> <option>Turno 3 (6x2)</option> <option>Turno 4 (6x2)</option> <option>Turno 1 (5x2)</option> <option>Turno 2 (5x2)</option> </select> </div>
                    <div> <label for="qtdFT">Quantidade de Filtro-prensagem (FT)</label> <input type="number" id="qtdFT" min="0" required> </div>
                    <div> <label for="qtdPlacas">Quantidade de Placas</label> <input type="number" id="qtdPlacas" min="0" value="0" required> </div>
                    
                    <fieldset class="paletes-fieldset">
                        <legend>Lan√ßamento de Paletes</legend>
                        <div class="palete-entry-row">
                            <select id="paleteSelect_1" class="palete-select"></select>
                            <input type="number" id="paleteQtd_1" class="palete-qtd" min="0" value="0" placeholder="Qtd.">
                            <div class="palete-peso-total">Peso: <output id="paletePesoTotal_1">0.00</output> kg</div>
                        </div>
                        <div class="palete-entry-row">
                            <select id="paleteSelect_2" class="palete-select"></select>
                            <input type="number" id="paleteQtd_2" class="palete-qtd" min="0" value="0" placeholder="Qtd.">
                            <div class="palete-peso-total">Peso: <output id="paletePesoTotal_2">0.00</output> kg</div>
                        </div>
                        <div class="palete-entry-row">
                             <select id="paleteSelect_3" class="palete-select"></select>
                            <input type="number" id="paleteQtd_3" class="palete-qtd" min="0" value="0" placeholder="Qtd.">
                            <div class="palete-peso-total">Peso: <output id="paletePesoTotal_3">0.00</output> kg</div>
                        </div>
                    </fieldset>
                    
                    <div class="full-width">
                        <label for="kgPalete">KG Total de Paletes (Calculado)</label>
                        <input type="number" id="kgPalete" step="0.1" min="0" readonly required>
                    </div>

                    <div class="full-width"> <label for="observacao">Observa√ß√£o</label> <textarea id="observacao" placeholder="Alguma observa√ß√£o sobre a produ√ß√£o..."></textarea> </div>
                    <div class="form-actions"> <button type="button" class="secondary" onclick="limparFormMassa()">Limpar</button> <button type="submit">Lan√ßar Produ√ß√£o</button> </div>
                </form>
            </section>
            <section class="history-section">
                <h2>Hist√≥rico de Produ√ß√£o (Filtro Prensa)</h2>
                <div class="filters">
                    <div> <label for="filtroDataInicio">Data In√≠cio</label> <input type="date" id="filtroDataInicio"> </div> <div> <label for="filtroDataFim">Data Fim</label> <input type="date" id="filtroDataFim"> </div> <div> <label for="filtroTurno">Turno</label> <select id="filtroTurno"> <option value="">Todos os Turnos</option> <option>Comercial</option> <option>Turno 1 (6x2)</option> <option>Turno 2 (6x2)</option> <option>Turno 3 (6x2)</option> <option>Turno 4 (6x2)</option> <option>Turno 1 (5x2)</option> <option>Turno 2 (5x2)</option> </select> </div>
                    <button class="excel-btn" onclick="exportarExcel()">Exportar Excel</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th></th> <th>Data</th> <th>Turno</th> <th>% FT</th> <th>% Palete</th> <th>Retrabalho (kg)</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaHistoricoBody"></tbody>
                </table>
            </section>
        </div>

        <!-- ================================================================ -->
        <!-- =================== 2. CONTE√öDO PARA MOAGEM ==================== -->
        <!-- ================================================================ -->
        <div id="tabMoagem" class="tab-content">
            <section>
                <h2>
                    Lan√ßar Moagem
                    <button id="openConfigMoagemBtn" title="Configurar Pontua√ß√£o da Moagem" onclick="openConfigMoagemModal()">‚öôÔ∏è</button>
                </h2>
                <form id="formMoagem">
                    <!-- Informa√ß√µes B√°sicas -->
                    <div>
                        <label for="dataMoagem">Data</label>
                        <input type="date" id="dataMoagem" required>
                    </div>
                    <div>
                        <label for="turnoMoagem">Turno</label>
                        <select id="turnoMoagem" required>
                             <option value="">Selecione um turno</option>
                             <option>Comercial</option>
                             <option>Turno 1 (6x2)</option> <option>Turno 2 (6x2)</option>
                             <option>Turno 3 (6x2)</option> <option>Turno 4 (6x2)</option>
                             <option>Turno 1 (5x2)</option> <option>Turno 2 (5x2)</option>
                        </select>
                    </div>
                    <div>
                        <!-- CAMPO DE TEXTO SUBSTITU√çDO POR SELECT -->
                        <label for="operadorMoagemSelect">Operador</label>
                        <select id="operadorMoagemSelect" required>
                            <option value="">Carregando...</option>
                        </select>
                    </div>

                    <!-- Se√ß√£o Operador -->
                    <fieldset class="moagem-fieldset">
    <legend>Operador</legend>
    
    <div>
        <label for="qtdCargasMoagem">Cargas Feitas</label>
        <input type="number" id="qtdCargasMoagem" min="0" value="0" required>
    </div>

    <div>
        <label for="qtdCargasSubidas">Cargas Subidas</label>
        <input type="number" id="qtdCargasSubidas" min="0" value="0">
    </div>

    <div>
        <label for="qtdDescargaMoagem">Quantidade de Descargas</label>
        <input type="number" id="qtdDescargaMoagem" min="0" value="0">
    </div>
    <div>
        <label for="arrumouBoxMoagem">Arrumou o Box?</label>
        <select id="arrumouBoxMoagem"> <option value="nao">N√£o</option> <option value="sim">Sim</option> </select>
    </div>
    
    <div>
        <label for="carregouCaminhaoCacoMoagem">Carregou Caminh√£o Caco?</label>
        <select id="carregouCaminhaoCacoMoagem"> <option value="nao">N√£o</option> <option value="sim">Sim</option> </select>
    </div>

    <div class="campo-com-condicional">
        <label for="guardouMateriaMoagem">Guardou Mat√©ria?</label>
        <select id="guardouMateriaMoagem" onchange="toggleCampoCondicional('guardouMateriaMoagem', 'containerQtdGuardouMateria')">
            <option value="nao">N√£o</option> <option value="sim">Sim</option>
        </select>
    </div>
    <div id="containerQtdGuardouMateria" class="campo-condicional">
        <label for="qtdGuardouMateriaMoagem">Quantas guardou?</label>
        <input type="number" id="qtdGuardouMateriaMoagem" min="0" value="0">
    </div>

    <div class="campo-com-condicional">
        <label for="subiuMassaMoagem">Subiu Massa?</label>
        <select id="subiuMassaMoagem" onchange="toggleCampoCondicional('subiuMassaMoagem', 'containerQtdSubiuMassa')">
            <option value="nao">N√£o</option> <option value="sim">Sim</option>
        </select>
    </div>
    <div id="containerQtdSubiuMassa" class="campo-condicional">
        <label for="qtdSubiuMassaMoagem">Quantas subiu?</label>
        <input type="number" id="qtdSubiuMassaMoagem" min="0" value="0">
    </div>

    <div class="campo-com-condicional">
        <label for="desceuCacambaMoagem">Desceu Ca√ßamba?</label>
        <select id="desceuCacambaMoagem" onchange="toggleCampoCondicional('desceuCacambaMoagem', 'containerQtdDesceuCacamba')">
            <option value="nao">N√£o</option> <option value="sim">Sim</option>
        </select>
    </div>
    <div id="containerQtdDesceuCacamba" class="campo-condicional">
        <label for="qtdDesceuCacambaMoagem">Quantas desceu?</label>
        <input type="number" id="qtdDesceuCacambaMoagem" min="0" value="0">
    </div>

    <div class="campo-com-condicional">
        <label for="virouCacambaMoagem">Virou Ca√ßamba?</label>
        <select id="virouCacambaMoagem" onchange="toggleCampoCondicional('virouCacambaMoagem', 'containerQtdVirouCacamba')">
            <option value="nao">N√£o</option> <option value="sim">Sim</option>
        </select>
    </div>
    <div id="containerQtdVirouCacamba" class="campo-condicional">
        <label for="qtdVirouCacambaMoagem">Quantas virou?</label>
        <input type="number" id="qtdVirouCacambaMoagem" min="0" value="0">
    </div>

    <div id="cargasContainerMoagem" class="full-width">
        </div>

    <div id="cargasSubidasContainerMoagem" class="full-width">
        </div>

</fieldset>

                    <!-- Se√ß√£o Auxiliar -->
                    <fieldset class="moagem-fieldset">
                        <legend>Auxiliar</legend>
                        <div>
                            <label for="lavouPeneiraMoagem">Lavou a Peneira?</label>
                            <select id="lavouPeneiraMoagem"> <option value="nao">N√£o</option> <option value="sim">Sim</option> </select>
                        </div>
                        <div>
                            <label for="limpouMoinhoMoagem">Limpou o Moinho?</label>
                            <select id="limpouMoinhoMoagem"> <option value="nao">N√£o</option> <option value="sim">Sim</option> </select>
                        </div>
                        <div>
                            <label for="lavouPeneiraDosadorMoagem">Lavou Peneira e Dosador?</label>
                            <select id="lavouPeneiraDosadorMoagem"> <option value="nao">N√£o</option> <option value="sim">Sim</option> </select>
                        </div>
                    </fieldset>
                    
                    <div class="full-width">
                        <label for="observacaoMoagem">Observa√ß√£o</label>
                        <textarea id="observacaoMoagem" placeholder="Alguma observa√ß√£o sobre a moagem..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="secondary" onclick="limparFormMoagem()">Limpar</button>
                        <button type="submit">Lan√ßar Moagem</button>
                    </div>
                </form>
            </section>
            <section class="history-section">
                <h2>Hist√≥rico de Moagem</h2>
                <!-- Adicionar filtros se necess√°rio -->
                <table>
                    <thead>
                        <tr>
                            <th></th> <!-- Para expandir -->
                            <th>Data</th>
                            <th>Turno</th>
                            <th>Operador</th>
                            <th>Cargas (Qtd)</th>
                            <th>Peso Total (kg)</th>
                            <th>Pontos</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaHistoricoMoagem">
                         <tr><td colspan="8">Nenhum lan√ßamento de moagem ainda.</td></tr>
                    </tbody>
                </table>
            </section>
        </div>
        <!-- ================================================================ -->
        <!-- ================================================================ -->


        <!-- 3. CONTE√öDO PESAGEM (Existente) -->
        <div id="tabPesagem" class="tab-content">
            <section>
                <h2>Lan√ßar Peso de Palete/Mesa</h2>
                <form id="formPesagem">
                    <div>
                        <label for="dataPesagem">Data</label>
                        <input type="date" id="dataPesagem" required>
                    </div>
                    <div>
                        <label for="codigoPalete">C√≥digo do Palete/Mesa</label>
                        <input type="text" id="codigoPalete" required placeholder="Ex: P01, MESA-A">
                    </div>
                    <div>
                        <label for="pesoTotalPalete">Peso Total (kg)</label>
                        <input type="number" id="pesoTotalPalete" step="0.1" min="0" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="secondary" onclick="document.getElementById('formPesagem').reset(); document.getElementById('dataPesagem').value = obterDataLocalFormatada();">Limpar</button>
                        <button type="submit">Lan√ßar Peso</button>
                    </div>
                </form>
            </section>
            <section class="history-section">
                <h2>Hist√≥rico de Pesagem</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Data</th> <th>C√≥digo</th> <th>Peso Total (kg)</th> <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaPesagemBody"></tbody>
                </table>
            </section>
        </div>
        
        <!-- ================================================================ -->
        <!-- =================== 4. NOVA ABA OPERADORES ===================== -->
        <!-- ================================================================ -->
        <div id="tabOperadores" class="tab-content">
            <section>
                <h2>Lan√ßar Cadastro de Operador</h2>
                <form id="formOperador">
                    <div>
                        <label for="dataCadastroOperador">Data Cadastro</label>
                        <input type="date" id="dataCadastroOperador" required>
                    </div>
                    <div>
                        <label for="nomeOperador">Nome do Operador</label>
                        <input type="text" id="nomeOperador" required placeholder="Nome Completo">
                    </div>
                    <div class="full-width">
                        <label for="turnoOperador">Turno (Moagem)</label>
                        <select id="turnoOperador" required>
                             <option value="">Selecione um turno</option>
                             <option>Turno 1 (6x2)</option> 
                             <option>Turno 2 (6x2)</option>
                             <option>Turno 3 (6x2)</option> 
                             <option>Turno 4 (6x2)</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="secondary" onclick="limparFormOperador()">Limpar</button>
                        <button type="submit">Cadastrar Operador</button>
                    </div>
                </form>
            </section>
            <section class="history-section">
                <h2>Operadores Cadastrados</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Data Cadastro</th>
                            <th>Nome</th>
                            <th>Turno</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaOperadoresBody">
                        <tr><td colspan="4">Carregando operadores...</td></tr>
                    </tbody>
                </table>
            </section>
        </div>


        <!-- 5. CONTE√öDO DASHBOARD (Existente) -->
        <div id="tabDashboard" class="tab-content">
            <h2>Dashboard de Produ√ß√£o</h2>
            <div class="dashboard-filters">
                <div>
                    <label for="dashFiltroDataInicio">Data In√≠cio</label>
                    <input type="date" id="dashFiltroDataInicio">
                </div>
                 <div>
                    <label for="dashFiltroDataFim">Data Fim</label>
                    <input type="date" id="dashFiltroDataFim">
                </div>
                 <div>
                    <label for="dashFiltroTurno">Turno</label>
                    <select id="dashFiltroTurno">
                        <option value="">Todos os Turnos</option>
                        <option>Comercial</option> <option>Turno 1 (6x2)</option> <option>Turno 2 (6x2)</option> <option>Turno 3 (6x2)</option> <option>Turno 4 (6x2)</option> <option>Turno 1 (5x2)</option> <option>Turno 2 (5x2)</option>
                    </select>
                </div>
                <button id="printDashboardBtn" onclick="window.print()" style="background-color: var(--accent);">üñ®Ô∏è Imprimir Dashboard</button>
            </div>

            <div class="kpi-grid">
                 <div class="kpi-card">
                    <h3>Meta FT (kg)</h3> <div class="value" id="kpiTotalMeta">---</div>
                </div>
                 <div class="kpi-card">
                    <h3>Realizado FT (kg)</h3> <div class="value" id="kpiTotalRealizado">---</div>
                </div>
                 <div class="kpi-card efficiency">
                    <h3>Efici√™ncia</h3> <div class="value" id="kpiEficiencia">---</div>
                </div>
                 <div class="kpi-card">
                    <h3>Retrabalho (kg)</h3> <div class="value" id="kpiRetrabalho">---</div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-container">
                     <h3>Produ√ß√£o por Turno (%)</h3>
                     <canvas id="pieChartTurnos"></canvas>
                </div>
                 <div class="chart-container">
                    <h3>Produ√ß√£o Mensal (√öltimos 12 Meses)</h3>
                    <select id="filtroTurnoGraficoMes" style="width: 100%; margin-bottom: 1rem;">
                        <option value="">Todos os Turnos</option>
                        <option>Comercial</option> <option>Turno 1 (6x2)</option> <option>Turno 2 (6x2)</option> <option>Turno 3 (6x2)</option> <option>Turno 4 (6x2)</option> <option>Turno 1 (5x2)</option> <option>Turno 2 (5x2)</option>
                    </select>
                    <canvas id="barChartMensal"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIGURA√á√ÉO (Filtro Prensa) -->
    <div id="configModal" class="modal-overlay" onclick="closeConfigModal(event)">
        <div class="modal-content">
            <h3>Configura√ß√µes de Pesos e Metas (Filtro Prensa)</h3>
            <div class="config-grid">
                <div> <label for="pesoFiltro">Peso por Filtro Prensa (kg)</label> <input type="number" id="pesoFiltro" step="0.1"> </div>
                <div> <label for="pesoPlaca">Peso por Placa (kg)</label> <input type="number" id="pesoPlaca" step="0.1"> </div>
                <div> <label for="metaKgFT">Meta KG (Filtro Prensa)</label> <input type="number" id="metaKgFT" step="100"> </div>
                <div> <label for="metaKgPalete">Meta KG (Paletes)</label> <input type="number" id="metaKgPalete" step="100"> </div>
            </div>
            <div class="modal-actions">
                <input type="password" id="configSenha" placeholder="Senha para salvar" style="flex-grow: 1;">
                <button type="button" class="secondary" onclick="closeConfigModal(event, true)">Cancelar</button>
                <button onclick="salvarConfiguracoes()">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL PARA PONTOS MOAGEM -->
    <div id="configMoagemModal" class="modal-overlay" onclick="closeConfigMoagemModal(event)">
        <div class="modal-content">
            <h3>Configurar Pontua√ß√£o (Moagem)</h3>
            
            <h4>Pontos por Produ√ß√£o</h4>
            <div class="config-grid">
                 <div> <label for="pontosPorKgMoagem">Pontos por KG (carga)</label> <input type="number" id="pontosPorKgMoagem" step="0.01"> </div>
            </div>

            <h4 style="margin-top: 1.5rem;">Pontos por Atividade (Operador)</h4>
            <div class="config-grid">
                <div> <label for="pontosDescarga">Descarga (por un.)</label> <input type="number" id="pontosDescarga" step="1"> </div>
                <div> <label for="pontosGuardouMateria">Guardou Mat√©ria (por un.)</label> <input type="number" id="pontosGuardouMateria" step="1"> </div>
                <div> <label for="pontosArrumouBox">Arrumou Box (fixo)</label> <input type="number" id="pontosArrumouBox" step="1"> </div>
                <div> <label for="pontosCarregouCaminhaoCaco">Carregou Caco (fixo)</label> <input type="number" id="pontosCarregouCaminhaoCaco" step="1"> </div>
                <div> <label for="pontosSubiuMassa">Subiu Massa (por un.)</label> <input type="number" id="pontosSubiuMassa" step="1"> </div>
                <div> <label for="pontosDesceuCacamba">Desceu Ca√ßamba (por un.)</label> <input type="number" id="pontosDesceuCacamba" step="1"> </div>
                <div> <label for="pontosVirouCacamba">Virou Ca√ßamba (por un.)</label> <input type="number" id="pontosVirouCacamba" step="1"> </div>
            </div>
            
            <h4 style="margin-top: 1.5rem;">Pontos por Atividade (Auxiliar)</h4>
            <div class="config-grid">
                 <div> <label for="pontosLavouPeneira">Lavou Peneira (fixo)</label> <input type="number" id="pontosLavouPeneira" step="1"> </div>
                 <div> <label for="pontosLimpouMoinho">Limpou Moinho (fixo)</label> <input type="number" id="pontosLimpouMoinho" step="1"> </div>
                 <div> <label for="pontosLavouPeneiraDosador">Lavou Peneira/Dosador (fixo)</label> <input type="number" id="pontosLavouPeneiraDosador" step="1"> </div>
            </div>

            <div class="modal-actions">
                <input type="password" id="configMoagemSenha" placeholder="Senha para salvar" style="flex-grow: 1;">
                <button type="button" class="secondary" onclick="closeConfigMoagemModal(event, true)">Cancelar</button>
                <button onclick="salvarConfigPontosMoagem()">Salvar Pontos</button>
            </div>
        </div>
    </div>

    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, deleteDoc, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB2z4mFj5qVtb59uocKK8JXhMTfi8MGSTo",
            authDomain: "acompanhamento-de-produc-b68b0.firebaseapp.com",
            projectId: "acompanhamento-de-produc-b68b0",
            storageBucket: "acompanhamento-de-produc-b68b0.firebasestorage.app",
            messagingSenderId: "891709449679",
            appId: "1:891709449679:web:43e83e076f5fb3201e1eba"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.massaCol = collection(db, "producao_massa");
        window.pesagemCol = collection(db, "pesagem_paletes");
        window.moagemCol = collection(db, "producao_moagem");
        window.operadoresCol = collection(db, "operadores_moagem"); // <-- Nova cole√ß√£o para Operadores
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        
        console.log("Firebase conectado para a F√°brica de Massa!");
    </script>
    
    <script>
    // Config Filtro Prensa
    let appConfig = {
        pesoFiltro: 4100, pesoPlaca: 39.1,
        metaKgFT: 12300, metaKgPalete: 12500
    };
    // Config Moagem (Pontos)
    let appConfigMoagem = {
        pontosPorKgMoagem: 0.01,
        pontosDescarga: 1,
        pontosGuardouMateria: 1,
        pontosArrumouBox: 5,
        pontosCarregouCaminhaoCaco: 5,
        pontosSubiuMassa: 1,
        pontosDesceuCacamba: 1,
        pontosVirouCacamba: 1,
        pontosLavouPeneira: 3,
        pontosLimpouMoinho: 3,
        pontosLavouPeneiraDosador: 3
    };
    
    let paletesDisponiveis = new Map();

    // ### REGISTRO DO PLUGIN DE R√ìTULOS (DATALABELS) ###
    Chart.register(ChartDataLabels);

    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
        document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
        event.target.classList.add('active');
    }

    function obterDataLocalFormatada() {
        const data = new Date();
        const ano = data.getFullYear();
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const dia = String(data.getDate()).padStart(2, '0');
        return `${ano}-${mes}-${dia}`;
    }

    // --- MODAL CONFIG FILTRO PRENSA ---
    function openConfigModal() {
        document.getElementById('pesoFiltro').value = appConfig.pesoFiltro;
        document.getElementById('pesoPlaca').value = appConfig.pesoPlaca;
        document.getElementById('metaKgFT').value = appConfig.metaKgFT;
        document.getElementById('metaKgPalete').value = appConfig.metaKgPalete;
        document.getElementById('configModal').style.display = 'flex';
    }

    function closeConfigModal(event, force = false) {
        if (force || event.target.id === 'configModal') {
            document.getElementById('configModal').style.display = 'none';
        }
    }

    async function salvarConfiguracoes() {
        if (document.getElementById('configSenha').value !== 'pb2025') {
            alert('Senha incorreta!'); return;
        }
        const newConfig = {
            pesoFiltro: parseFloat(document.getElementById('pesoFiltro').value) || 0,
            pesoPlaca: parseFloat(document.getElementById('pesoPlaca').value) || 0,
            metaKgFT: parseFloat(document.getElementById('metaKgFT').value) || 0,
            metaKgPalete: parseFloat(document.getElementById('metaKgPalete').value) || 0
        };
        try {
            const configDocRef = window.doc(db, "configuracoes", "massaConfig");
            await window.setDoc(configDocRef, newConfig, { merge: true });
            appConfig = newConfig;
            alert('Configura√ß√µes (Filtro Prensa) salvas com sucesso!');
            document.getElementById('configSenha').value = '';
            closeConfigModal({target: {id: 'configModal'}});
            renderizarHistorico();
        } catch (error) {
            console.error("Erro ao salvar configura√ß√µes:", error);
            alert("Erro ao salvar configura√ß√µes.");
        }
    }

    async function carregarConfiguracoes() {
        try {
            const configDocRef = window.doc(db, "configuracoes", "massaConfig");
            const docSnap = await window.getDoc(configDocRef);
            if (docSnap.exists()) {
                appConfig = { ...appConfig, ...docSnap.data() };
            }
        } catch(error) {
            console.error("Erro ao carregar configura√ß√µes (Filtro Prensa):", error);
        }
    }

    // --- MODAL CONFIG MOAGEM (PONTOS) ---
    function openConfigMoagemModal() {
        for (const key in appConfigMoagem) {
            const el = document.getElementById(key); // IDs devem bater com as chaves
            if (el) el.value = appConfigMoagem[key];
        }
        document.getElementById('configMoagemModal').style.display = 'flex';
    }

    function closeConfigMoagemModal(event, force = false) {
        if (force || event.target.id === 'configMoagemModal') {
            document.getElementById('configMoagemModal').style.display = 'none';
        }
    }

    async function salvarConfigPontosMoagem() {
        if (document.getElementById('configMoagemSenha').value !== 'pb2025') {
            alert('Senha incorreta!'); return;
        }
        const newConfigMoagem = {};
        for (const key in appConfigMoagem) {
            const el = document.getElementById(key);
            if (el) newConfigMoagem[key] = parseFloat(el.value) || 0;
        }
        
        try {
            const configDocRef = window.doc(db, "configuracoes", "moagemConfig");
            await window.setDoc(configDocRef, newConfigMoagem, { merge: true });
            appConfigMoagem = newConfigMoagem;
            alert('Configura√ß√£o de Pontos (Moagem) salva com sucesso!');
            document.getElementById('configMoagemSenha').value = '';
            closeConfigMoagemModal({target: {id: 'configMoagemModal'}});
        } catch (error) {
            console.error("Erro ao salvar config de pontos:", error);
            alert("Erro ao salvar config de pontos.");
        }
    }

    async function carregarConfigPontosMoagem() {
         try {
            const configDocRef = window.doc(db, "configuracoes", "moagemConfig");
            const docSnap = await window.getDoc(configDocRef);
            if (docSnap.exists()) {
                appConfigMoagem = { ...appConfigMoagem, ...docSnap.data() };
            }
        } catch(error) {
            console.error("Erro ao carregar config de pontos (Moagem):", error);
        }
    }

    // --- L√ìGICA FILTRO PRENSA (formMassa) ---
    async function carregarOpcoesPaletes() {
        try {
            const q = query(window.pesagemCol, orderBy("codigo"));
            const querySnapshot = await getDocs(q);
            paletesDisponiveis.clear();
            querySnapshot.forEach(doc => {
                const data = doc.data();
                if(data.codigo && data.peso) {
                    paletesDisponiveis.set(data.codigo, data.peso);
                }
            });
            const selects = document.querySelectorAll('.palete-select');
            selects.forEach(select => {
                select.innerHTML = '<option value="">Selecione...</option>';
                paletesDisponiveis.forEach((peso, codigo) => {
                    const option = document.createElement('option');
                    option.value = codigo;
                    option.textContent = `${codigo} (${peso.toFixed(2)} kg)`;
                    option.dataset.peso = peso;
                    select.appendChild(option);
                });
            });
        } catch (error) {
            console.error("Erro ao carregar op√ß√µes de paletes:", error);
        }
    }

    function calcularPesoTotalPaletes() {
        let grandTotal = 0;
        for (let i = 1; i <= 3; i++) {
            const select = document.getElementById(`paleteSelect_${i}`);
            const qtdInput = document.getElementById(`paleteQtd_${i}`);
            const pesoOutput = document.getElementById(`paletePesoTotal_${i}`);
            const selectedOption = select.options[select.selectedIndex];
            const pesoUnitario = parseFloat(selectedOption.dataset.peso) || 0;
            const quantidade = parseInt(qtdInput.value) || 0;
            const subTotal = pesoUnitario * quantidade;
            pesoOutput.textContent = subTotal.toFixed(2);
            grandTotal += subTotal;
        }
        document.getElementById('kgPalete').value = grandTotal.toFixed(2);
    }
    
    function limparFormMassa() {
        document.getElementById('formMassa').reset();
        document.getElementById('data').value = obterDataLocalFormatada();
        calcularPesoTotalPaletes();
    }
    
    document.getElementById('formMassa').addEventListener('submit', async function(event) {
¬† ¬† ¬† ¬† event.preventDefault();
¬† ¬† ¬† ¬† const kgPaleteReal = parseFloat(document.getElementById('kgPalete').value);
¬† ¬† ¬† ¬† if (kgPaleteReal <= 0) {
¬† ¬† ¬† ¬† ¬† ¬† alert("O KG Total de Paletes deve ser maior que zero. Lance ao menos um palete.");
¬† ¬† ¬† ¬† ¬† ¬† return;
¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† const qtdFT = parseInt(document.getElementById('qtdFT').value);
¬† ¬† ¬† ¬† const qtdPlacas = parseInt(document.getElementById('qtdPlacas').value);
¬† ¬† ¬† ¬† const kgCalculado = (qtdFT * appConfig.pesoFiltro) + (qtdPlacas * appConfig.pesoPlaca);
¬† ¬† ¬† ¬† const retrabalhoCalculado = kgPaleteReal - kgCalculado;
¬† ¬† ¬† ¬† const retrabalhoKg = Math.max(0, retrabalhoCalculado);
¬† ¬† ¬† ¬† const novoRegistro = {
¬† ¬† ¬† ¬† ¬† ¬† data: document.getElementById('data').value,
¬† ¬† ¬† ¬† ¬† ¬† turno: document.getElementById('turno').value,
¬† ¬† ¬† ¬† ¬† ¬† qtdFT, qtdPlacas,
¬† ¬† ¬† ¬† ¬† ¬† kgPalete: kgPaleteReal,
¬† ¬† ¬† ¬† ¬† ¬† observacao: document.getElementById('observacao').value,
¬† ¬† ¬† ¬† ¬† ¬† kgCalculado, retrabalhoKg,
¬† ¬† ¬† ¬† ¬† ¬† timestamp: new Date().toISOString(),
¬† ¬† ¬† ¬† ¬† ¬† metaKgFT: appConfig.metaKgFT,
¬† ¬† ¬† ¬† ¬† ¬† metaKgPalete: appConfig.metaKgPalete
¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† try {
¬† ¬† ¬† ¬† ¬† ¬† await window.addDoc(window.massaCol, novoRegistro);
¬† ¬† ¬† ¬† ¬† ¬† alert('Produ√ß√£o (Filtro Prensa) lan√ßada com sucesso! ‚úÖ');
¬† ¬† ¬† ¬† ¬† ¬† renderizarHistorico();
¬† ¬† ¬† ¬† ¬† ¬† limparFormMassa();
¬† ¬† ¬† ¬† } catch (error) {
¬† ¬† ¬† ¬† ¬† ¬† console.error("Erro ao salvar no Firebase: ", error);
¬† ¬† ¬† ¬† ¬† ¬† alert("Erro ao salvar. Verifique o console. ‚ùå");
¬† ¬† ¬† ¬† }
¬† ¬† });
    
    async function renderizarHistorico() {
        const tbody = document.getElementById('tabelaHistoricoBody');
        tbody.innerHTML = `<tr><td colspan="6">Carregando...</td></tr>`;
        const filtroDataInicio = document.getElementById('filtroDataInicio').value;
        const filtroDataFim = document.getElementById('filtroDataFim').value;
        const filtroTurno = document.getElementById('filtroTurno').value;
        let queryConstraints = [orderBy("data", "desc"), orderBy("timestamp", "desc")];
        if (filtroDataInicio) queryConstraints.push(where("data", ">=", filtroDataInicio));
        if (filtroDataFim) queryConstraints.push(where("data", "<=", filtroDataFim));
        if (filtroTurno) queryConstraints.push(where("turno", "==", filtroTurno));
        try {
            const q = query(window.massaCol, ...queryConstraints);
            const querySnapshot = await getDocs(q);
            const dadosFiltrados = querySnapshot.docs;
            tbody.innerHTML = '';
            if (dadosFiltrados.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6">Nenhum registro encontrado.</td></tr>`;
                return;
            }
            dadosFiltrados.forEach(doc => {
                const reg = doc.data();
                const docId = doc.id;
                const metaFTDoRegistro = reg.metaKgFT || appConfig.metaKgFT;
                const metaPaleteDoRegistro = reg.metaKgPalete || appConfig.metaKgPalete;
                const eficFT = (reg.kgCalculado / (metaFTDoRegistro || 1)) * 100;
                const eficPalete = (reg.kgPalete / (metaPaleteDoRegistro || 1)) * 100;
                const getEficClass = (perc) => {
                    if (perc >= 98) return 'efficiency-good';
                    if (perc >= 90) return 'efficiency-ok';
                    return 'efficiency-bad';
                };
                let retrabalhoValor = reg.retrabalhoKg;
                let retrabalhoClasse = '';
                if (retrabalhoValor != null) {
                    if (retrabalhoValor > 0) retrabalhoClasse = 'efficiency-good';
                    if (retrabalhoValor < 0) retrabalhoClasse = 'efficiency-bad';
                    retrabalhoValor = `${retrabalhoValor.toFixed(2)}`;
                } else { retrabalhoValor = 'N/A'; }
                const trPrincipal = document.createElement('tr');
                trPrincipal.innerHTML = `
    <td><button class="expand-btn" onclick="toggleDetalhes('detalhes-fp-${docId}', this)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></button></td>
    <td>${new Date(reg.data + 'T03:00:00').toLocaleDateString('pt-BR')}</td>
                    <td>${reg.turno}</td>
                    <td class="${getEficClass(eficFT)}">${eficFT.toFixed(2)}%</td>
                    <td class="${getEficClass(eficPalete)}">${eficPalete.toFixed(2)}%</td>
                    <td class="${retrabalhoClasse}">${retrabalhoValor}</td>
                `;
                const trDetalhes = document.createElement('tr');
                trDetalhes.id = `detalhes-fp-${docId}`; // ID √∫nico
                trDetalhes.className = 'linha-detalhes';
                trDetalhes.innerHTML = `
                    <td colspan="6">
                        <div class="detalhe-grid">
                            <div><span>Filtro Prensa (kg):</span> ${reg.kgCalculado.toFixed(2)} kg</div>
                            <div><span>Palete (kg):</span> ${reg.kgPalete.toFixed(2)} kg</div>
                            <div><span>Retrabalho (kg):</span> ${reg.retrabalhoKg ? reg.retrabalhoKg.toFixed(2) + ' kg' : 'N/A'}</div>
                            <div><span>Qtd. Filtros (FT):</span> ${reg.qtdFT}</div>
                            <div><span>Qtd. Placas:</span> ${reg.qtdPlacas}</div>
                            <div><span>Meta FT (kg):</span> ${reg.metaKgFT ? reg.metaKgFT.toFixed(2) + ' kg' : 'N/A'}</div>
                            <div><span>Meta Palete (kg):</span> ${reg.metaKgPalete ? reg.metaKgPalete.toFixed(2) + ' kg' : 'N/A'}</div>
                            <div style="grid-column: 1 / -1;"><span>Observa√ß√£o:</span> ${reg.observacao || 'Nenhuma'}</div>
                            <div>
                                <span>A√ß√µes:</span> 
                                <button class="delete-btn" onclick="deletarRegistro('${docId}')">Excluir</button>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(trPrincipal);
                tbody.appendChild(trDetalhes);
            });
        } catch (error) {
            console.error("Erro ao buscar dados:", error);
            tbody.innerHTML = `<tr><td colspan="6">Erro ao carregar dados.</td></tr>`;
        }
    }
    
    // --- L√ìGICA MOAGEM (formMoagem) ---
    
    function toggleCampoCondicional(selectId, containerId) {
        const select = document.getElementById(selectId);
        const container = document.getElementById(containerId);
        if (select.value === 'sim') {
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
            // Limpa o valor do input num√©rico quando escondido
            const input = container.querySelector('input[type="number"]');
            if (input) input.value = '0';
        }
    }
    
    function atualizarCamposCargaMoagem() {
        const qtd = parseInt(document.getElementById('qtdCargasMoagem').value) || 0;
        const container = document.getElementById('cargasContainerMoagem');
        container.innerHTML = ''; // Limpa campos antigos
        
        if (qtd > 0) {
             const title = document.createElement('h4');
             title.textContent = 'Detalhes das Cargas';
             title.style.gridColumn = '1 / -1';
             title.style.margin = '0 0 0.5rem 0';
             container.appendChild(title);
        }

        for (let i = 1; i <= qtd; i++) {
            const row = document.createElement('div');
            row.className = 'carga-moagem-row';
            
            row.innerHTML = `
                <label for="moinhoCarga_${i}">Carga ${i}</label>
                <select id="moinhoCarga_${i}" class="moinho-select">
                    <option value="">Moinho...</option>
                    <option value="1">Moinho 1</option>
                    <option value="2">Moinho 2</option>
                    <option value="3">Moinho 3</option>
                </select>
                <label for="pesoCarga_${i}">Peso (kg)</label>
                <input type="number" id="pesoCarga_${i}" class="peso-carga-input" min="0" placeholder="kg" step="0.1">
            `;
            // Ajusta o layout da linha de carga
            row.style.gridTemplateColumns = 'auto auto 1fr';
            row.style.gap = '0.75rem';
            row.querySelectorAll('label')[0].style.textAlign = 'left';
            row.querySelectorAll('label')[1].style.textAlign = 'right';

            container.appendChild(row);
        }
    }

        // --- FUN√á√ÉO NOVA: Gera campos para CARGAS SUBIDAS ---
    function atualizarCamposCargasSubidas() {
        const qtd = parseInt(document.getElementById('qtdCargasSubidas').value) || 0;
        const container = document.getElementById('cargasSubidasContainerMoagem');
        container.innerHTML = ''; // Limpa campos antigos
        
        if (qtd > 0) {
             const title = document.createElement('h4');
             title.textContent = 'Detalhes das Cargas SUBIDAS';
             title.style.gridColumn = '1 / -1';
             title.style.margin = '1rem 0 0.5rem 0';
             title.style.color = 'var(--accent)'; // Cor diferente para destacar
             container.appendChild(title);
        }

        for (let i = 1; i <= qtd; i++) {
            const row = document.createElement('div');
            row.className = 'carga-moagem-row';
            
            // Note os IDs diferentes: moinhoCargaSubida_X e pesoCargaSubida_X
            row.innerHTML = `
                <label for="moinhoCargaSubida_${i}">Subida ${i}</label>
                <select id="moinhoCargaSubida_${i}" class="moinho-select">
                    <option value="">Moinho...</option>
                    <option value="1">Moinho 1</option>
                    <option value="2">Moinho 2</option>
                    <option value="3">Moinho 3</option>
                </select>
                <label for="pesoCargaSubida_${i}">Peso (kg)</label>
                <input type="number" id="pesoCargaSubida_${i}" class="peso-carga-input" min="0" placeholder="kg" step="0.1">
            `;
            
            row.style.gridTemplateColumns = 'auto auto 1fr';
            row.style.gap = '0.75rem';
            row.querySelectorAll('label')[0].style.textAlign = 'left';
            row.querySelectorAll('label')[1].style.textAlign = 'right';

            container.appendChild(row);
        }
    }

    // --- ATUALIZAR LISTENERS ---
    // Coloque isso dentro do 'DOMContentLoaded' junto com os outros listeners
    // document.getElementById('qtdCargasSubidas').addEventListener('input', atualizarCamposCargasSubidas);
    
    function limparFormMoagem() {
        document.getElementById('formMoagem').reset();
        document.getElementById('dataMoagem').value = obterDataLocalFormatada();
        
        atualizarCamposCargaMoagem();     // Limpa container Feitas
        atualizarCamposCargasSubidas();   // Limpa container Subidas (NOVO)
        
        document.querySelectorAll('.campo-condicional').forEach(el => el.style.display = 'none');
    }
    document.getElementById('formMoagem').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        // 1. Coletar Cargas Din√¢micas
        const qtdCargas = parseInt(document.getElementById('qtdCargasMoagem').value) || 0;
        let cargas = [];
        let pesoTotalCargas = 0;
        for (let i = 1; i <= qtdCargas; i++) {
            const moinho = document.getElementById(`moinhoCarga_${i}`).value;
            const peso = parseFloat(document.getElementById(`pesoCarga_${i}`).value) || 0;
            if (moinho && peso > 0) {
                cargas.push({ moinho: moinho, peso: peso });
                pesoTotalCargas += peso;
            }
        }
        
        // 2. Coletar Dados Sim/N√£o e Quantidades
        const dadosOperador = {
            qtdDescarga: parseInt(document.getElementById('qtdDescargaMoagem').value) || 0,
            guardouMateria: document.getElementById('guardouMateriaMoagem').value === 'sim',
            qtdGuardouMateria: parseInt(document.getElementById('qtdGuardouMateriaMoagem').value) || 0,
            arrumouBox: document.getElementById('arrumouBoxMoagem').value === 'sim',
            carregouCaminhaoCaco: document.getElementById('carregouCaminhaoCacoMoagem').value === 'sim',
            subiuMassa: document.getElementById('subiuMassaMoagem').value === 'sim',
            qtdSubiuMassa: parseInt(document.getElementById('qtdSubiuMassaMoagem').value) || 0,
            desceuCacamba: document.getElementById('desceuCacambaMoagem').value === 'sim',
            qtdDesceuCacamba: parseInt(document.getElementById('qtdDesceuCacambaMoagem').value) || 0,
            virouCacamba: document.getElementById('virouCacambaMoagem').value === 'sim',
            qtdVirouCacamba: parseInt(document.getElementById('qtdVirouCacambaMoagem').value) || 0,
        };
        
        const dadosAuxiliar = {
             lavouPeneira: document.getElementById('lavouPeneiraMoagem').value === 'sim',
             limpouMoinho: document.getElementById('limpouMoinhoMoagem').value === 'sim',
             lavouPeneiraDosador: document.getElementById('lavouPeneiraDosadorMoagem').value === 'sim',
        };

        // 3. Calcular Pontos
        let pontosCargas = pesoTotalCargas * appConfigMoagem.pontosPorKgMoagem;
        
        let pontosAtividades = 0;
        pontosAtividades += dadosOperador.qtdDescarga * appConfigMoagem.pontosDescarga;
        pontosAtividades += dadosOperador.qtdGuardouMateria * appConfigMoagem.pontosGuardouMateria;
        pontosAtividades += dadosOperador.arrumouBox ? appConfigMoagem.pontosArrumouBox : 0;
        pontosAtividades += dadosOperador.carregouCaminhaoCaco ? appConfigMoagem.pontosCarregouCaminhaoCaco : 0;
        pontosAtividades += dadosOperador.qtdSubiuMassa * appConfigMoagem.pontosSubiuMassa;
        pontosAtividades += dadosOperador.qtdDesceuCacamba * appConfigMoagem.pontosDesceuCacamba;
        pontosAtividades += dadosOperador.qtdVirouCacamba * appConfigMoagem.pontosVirouCacamba;
        
        pontosAtividades += dadosAuxiliar.lavouPeneira ? appConfigMoagem.pontosLavouPeneira : 0;
        pontosAtividades += dadosAuxiliar.limpouMoinho ? appConfigMoagem.pontosLimpouMoinho : 0;
        pontosAtividades += dadosAuxiliar.lavouPeneiraDosador ? appConfigMoagem.pontosLavouPeneiraDosador : 0;
        
        const pontosTotal = pontosCargas + pontosAtividades;

        // 4. Montar Registro e Salvar
        const novoRegistroMoagem = {
            data: document.getElementById('dataMoagem').value,
            turno: document.getElementById('turnoMoagem').value,
            operador: document.getElementById('operadorMoagemSelect').value, // <-- CAMPO ATUALIZADO
            observacao: document.getElementById('observacaoMoagem').value,
            
            cargas: cargas, // Array de {moinho, peso}
            pesoTotalCargas: pesoTotalCargas,
            
            ...dadosOperador, // Inclui todos os dados do operador
            ...dadosAuxiliar, // Inclui todos os dados do auxiliar
            
            pontosCargas: pontosCargas,
            pontosAtividades: pontosAtividades,
            pontosTotal: pontosTotal,
            
            configuracaoPontosUsada: appConfigMoagem, // Salva snapshot da config usada
            timestamp: new Date().toISOString()
        };

        try {
            await window.addDoc(window.moagemCol, novoRegistroMoagem);
            alert(`Lan√ßamento de Moagem salvo! \nPontos: ${pontosTotal.toFixed(2)} \n(Cargas: ${pontosCargas.toFixed(2)}, Atividades: ${pontosAtividades.toFixed(2)})`);
            renderizarHistoricoMoagem();
            limparFormMoagem();
        } catch (error) {
            console.error("Erro ao salvar moagem: ", error);
            alert("Erro ao salvar lan√ßamento de moagem. ‚ùå");
        }
    });

    async function renderizarHistoricoMoagem() {
        const tbody = document.getElementById('tabelaHistoricoMoagem');
        tbody.innerHTML = `<tr><td colspan="8">Carregando...</td></tr>`;
        try {
            const q = query(window.moagemCol, orderBy("data", "desc"), orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(q);
            tbody.innerHTML = '';
            if (querySnapshot.empty) {
                 tbody.innerHTML = `<tr><td colspan="8">Nenhum lan√ßamento de moagem ainda.</td></tr>`;
                 return;
            }
            querySnapshot.forEach(doc => {
                const reg = doc.data();
                const docId = doc.id;
                
                // C√°lculos visuais
                const qtdFeitas = reg.cargas ? reg.cargas.length : 0;
                const qtdSubidas = reg.cargasSubidas ? reg.cargasSubidas.length : 0;
                const pesoFeitas = reg.pesoTotalCargas || 0;
                const pesoSubidas = reg.pesoTotalCargasSubidas || 0;
                const pesoTotalGeral = pesoFeitas + pesoSubidas;

                const trPrincipal = document.createElement('tr');
                trPrincipal.innerHTML = `
                    <td><button class="expand-btn" onclick="toggleDetalhes('detalhes-moagem-${docId}', this)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></button></td>
                    <td>${new Date(reg.data + 'T03:00:00').toLocaleDateString('pt-BR')}</td>
                    <td>${reg.turno}</td>
                    <td>${reg.operador}</td>
                    <td>F: ${qtdFeitas} | S: ${qtdSubidas}</td>
                    <td>${pesoTotalGeral.toFixed(2)} kg</td>
                    <td style="font-weight: bold; color: var(--primary);">${reg.pontosTotal ? reg.pontosTotal.toFixed(2) : '0.00'}</td>
                    <td>
                        <button class="delete-btn" onclick="deletarRegistroMoagem('${docId}')">Excluir</button>
                    </td>
                `;
                
                // --- Detalhes ---
                const trDetalhes = document.createElement('tr');
                trDetalhes.id = `detalhes-moagem-${docId}`;
                trDetalhes.className = 'linha-detalhes';
                
                // Formatar Cargas FEITAS
                let cargasHtml = 'Nenhuma';
                if (reg.cargas && reg.cargas.length > 0) {
                    cargasHtml = reg.cargas.map(c => `M${c.moinho}: ${c.peso}kg`).join(' | ');
                }

                // Formatar Cargas SUBIDAS (NOVO)
                let cargasSubidasHtml = 'Nenhuma';
                if (reg.cargasSubidas && reg.cargasSubidas.length > 0) {
                    cargasSubidasHtml = reg.cargasSubidas.map(c => `M${c.moinho}: ${c.peso}kg`).join(' | ');
                }
                
                const simNao = (val) => val ? 'Sim' : 'N√£o';
                const qtd = (val) => val || 0;
                
                trDetalhes.innerHTML = `
                    <td colspan="8">
                        <div class="detalhe-grid">
                            <div><span>Pontos (Peso Total):</span> ${reg.pontosCargas ? reg.pontosCargas.toFixed(2) : '0.00'}</div>
                            <div><span>Pontos (Ativ.):</span> ${reg.pontosAtividades ? reg.pontosAtividades.toFixed(2) : '0.00'}</div>
                            <div><span>Descargas:</span> ${qtd(reg.qtdDescarga)}</div>
                            <div><span>Guardou Mat√©ria:</span> ${simNao(reg.guardouMateria)} (${qtd(reg.qtdGuardouMateria)} un)</div>
                            <div><span>Arrumou Box:</span> ${simNao(reg.arrumouBox)}</div>
                            <div><span>Carregou Caco:</span> ${simNao(reg.carregouCaminhaoCaco)}</div>
                        </div>
                        <div class="detalhe-grid" style="margin-top: 1rem; border-top: 1px solid var(--border-color); padding-top: 0.5rem;">
                            <div style="grid-column: 1 / -1; color: var(--primary);"><strong>Cargas Feitas (${pesoFeitas.toFixed(2)}kg):</strong> ${cargasHtml}</div>
                            <div style="grid-column: 1 / -1; color: var(--accent);"><strong>Cargas Subidas (${pesoSubidas.toFixed(2)}kg):</strong> ${cargasSubidasHtml}</div>
                            <div style="grid-column: 1 / -1;"><span>Observa√ß√£o:</span> ${reg.observacao || 'Nenhuma'}</div>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(trPrincipal);
                tbody.appendChild(trDetalhes);
            });
        } catch(error) {
             console.error("Erro ao carregar hist√≥rico de moagem:", error);
             tbody.innerHTML = `<tr><td colspan="8">Erro ao carregar dados.</td></tr>`;
        }
    }
    
    window.deletarRegistroMoagem = async function(docId) {
        const t=prompt("Para confirmar a exclus√£o, digite a senha:");
        if(null!==t&&"pb2025"!==t) {
            alert("Senha incorreta. Exclus√£o cancelada.");
        } else if(confirm("Tem certeza que deseja excluir este lan√ßamento de MOAGEM?")) {
            try{
                await window.deleteDoc(window.doc(db, "producao_moagem", docId));
                alert("Registro de moagem exclu√≠do com sucesso!");
                renderizarHistoricoMoagem();
            } catch(d) {
                console.error("Erro ao deletar do Firebase: ", d);
                alert("Erro ao excluir. Verifique o console.");
            }
        }
    };


    // --- L√ìGICA PESAGEM (formPesagem) ---
    document.getElementById('formMoagem').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        // 1. Coletar Cargas FEITAS
        const qtdCargas = parseInt(document.getElementById('qtdCargasMoagem').value) || 0;
        let cargas = [];
        let pesoTotalCargas = 0;
        for (let i = 1; i <= qtdCargas; i++) {
            const moinhoEl = document.getElementById(`moinhoCarga_${i}`);
            const pesoEl = document.getElementById(`pesoCarga_${i}`);
            
            // Verifica√ß√£o de seguran√ßa se o elemento existe
            if (moinhoEl && pesoEl) {
                const moinho = moinhoEl.value;
                const peso = parseFloat(pesoEl.value) || 0;
                if (moinho && peso > 0) {
                    cargas.push({ moinho: moinho, peso: peso });
                    pesoTotalCargas += peso;
                }
            }
        }

        // 2. Coletar Cargas SUBIDAS (NOVO)
        const qtdCargasSubidas = parseInt(document.getElementById('qtdCargasSubidas').value) || 0;
        let cargasSubidas = [];
        let pesoTotalCargasSubidas = 0;
        for (let i = 1; i <= qtdCargasSubidas; i++) {
            const moinhoEl = document.getElementById(`moinhoCargaSubida_${i}`);
            const pesoEl = document.getElementById(`pesoCargaSubida_${i}`);
            
            if (moinhoEl && pesoEl) {
                const moinho = moinhoEl.value;
                const peso = parseFloat(pesoEl.value) || 0;
                if (moinho && peso > 0) {
                    cargasSubidas.push({ moinho: moinho, peso: peso });
                    pesoTotalCargasSubidas += peso;
                }
            }
        }
        
        // 3. Coletar Dados Sim/N√£o (Mantido igual)
        const dadosOperador = {
            qtdDescarga: parseInt(document.getElementById('qtdDescargaMoagem').value) || 0,
            guardouMateria: document.getElementById('guardouMateriaMoagem').value === 'sim',
            qtdGuardouMateria: parseInt(document.getElementById('qtdGuardouMateriaMoagem').value) || 0,
            arrumouBox: document.getElementById('arrumouBoxMoagem').value === 'sim',
            carregouCaminhaoCaco: document.getElementById('carregouCaminhaoCacoMoagem').value === 'sim',
            subiuMassa: document.getElementById('subiuMassaMoagem').value === 'sim',
            qtdSubiuMassa: parseInt(document.getElementById('qtdSubiuMassaMoagem').value) || 0,
            desceuCacamba: document.getElementById('desceuCacambaMoagem').value === 'sim',
            qtdDesceuCacamba: parseInt(document.getElementById('qtdDesceuCacambaMoagem').value) || 0,
            virouCacamba: document.getElementById('virouCacambaMoagem').value === 'sim',
            qtdVirouCacamba: parseInt(document.getElementById('qtdVirouCacambaMoagem').value) || 0,
        };
        
        const dadosAuxiliar = {
             lavouPeneira: document.getElementById('lavouPeneiraMoagem').value === 'sim',
             limpouMoinho: document.getElementById('limpouMoinhoMoagem').value === 'sim',
             lavouPeneiraDosador: document.getElementById('lavouPeneiraDosadorMoagem').value === 'sim',
        };

        // 4. Calcular Pontos (ATUALIZADO PARA SOMAR FEITAS + SUBIDAS)
        // Soma o peso das Feitas + Subidas e multiplica pelo fator
        const pesoTotalGeral = pesoTotalCargas + pesoTotalCargasSubidas;
        let pontosCargas = pesoTotalGeral * appConfigMoagem.pontosPorKgMoagem;
        
        let pontosAtividades = 0;
        pontosAtividades += dadosOperador.qtdDescarga * appConfigMoagem.pontosDescarga;
        pontosAtividades += dadosOperador.qtdGuardouMateria * appConfigMoagem.pontosGuardouMateria;
        pontosAtividades += dadosOperador.arrumouBox ? appConfigMoagem.pontosArrumouBox : 0;
        pontosAtividades += dadosOperador.carregouCaminhaoCaco ? appConfigMoagem.pontosCarregouCaminhaoCaco : 0;
        pontosAtividades += dadosOperador.qtdSubiuMassa * appConfigMoagem.pontosSubiuMassa;
        pontosAtividades += dadosOperador.qtdDesceuCacamba * appConfigMoagem.pontosDesceuCacamba;
        pontosAtividades += dadosOperador.qtdVirouCacamba * appConfigMoagem.pontosVirouCacamba;
        
        pontosAtividades += dadosAuxiliar.lavouPeneira ? appConfigMoagem.pontosLavouPeneira : 0;
        pontosAtividades += dadosAuxiliar.limpouMoinho ? appConfigMoagem.pontosLimpouMoinho : 0;
        pontosAtividades += dadosAuxiliar.lavouPeneiraDosador ? appConfigMoagem.pontosLavouPeneiraDosador : 0;
        
        const pontosTotal = pontosCargas + pontosAtividades;

        // 5. Montar Registro e Salvar
        const novoRegistroMoagem = {
            data: document.getElementById('dataMoagem').value,
            turno: document.getElementById('turnoMoagem').value,
            operador: document.getElementById('operadorMoagemSelect').value,
            observacao: document.getElementById('observacaoMoagem').value,
            
            cargas: cargas, // Cargas Feitas
            pesoTotalCargas: pesoTotalCargas,
            
            cargasSubidas: cargasSubidas, // NOVO: Cargas Subidas
            pesoTotalCargasSubidas: pesoTotalCargasSubidas, // NOVO: Peso Subidas

            ...dadosOperador,
            ...dadosAuxiliar,
            
            pontosCargas: pontosCargas, // Inclui pontos de ambas
            pontosAtividades: pontosAtividades,
            pontosTotal: pontosTotal,
            
            configuracaoPontosUsada: appConfigMoagem,
            timestamp: new Date().toISOString()
        };

        try {
            await window.addDoc(window.moagemCol, novoRegistroMoagem);
            alert(`Lan√ßamento salvo! \nPontos: ${pontosTotal.toFixed(2)} \n(Peso Total: ${pesoTotalGeral.toFixed(2)}kg)`);
            renderizarHistoricoMoagem();
            limparFormMoagem();
        } catch (error) {
            console.error("Erro ao salvar moagem: ", error);
            alert("Erro ao salvar lan√ßamento de moagem. ‚ùå");
        }
    });

    // --- L√ìGICA OPERADORES (formOperador) ---
    
    function limparFormOperador() {
        document.getElementById('formOperador').reset();
        document.getElementById('dataCadastroOperador').value = obterDataLocalFormatada();
    }
    
    document.getElementById('formOperador').addEventListener('submit', async function(event) {
        event.preventDefault();
        const nomeOperador = document.getElementById('nomeOperador').value.trim();
        const turnoOperador = document.getElementById('turnoOperador').value;
        
        if (!nomeOperador || !turnoOperador) {
            alert("Por favor, preencha o nome e o turno do operador.");
            return;
        }
        
        const novoOperador = {
            dataCadastro: document.getElementById('dataCadastroOperador').value,
            nome: nomeOperador,
            turno: turnoOperador,
            timestamp: new Date().toISOString()
        };
        
        try {
            await window.addDoc(window.operadoresCol, novoOperador);
            alert('Operador cadastrado com sucesso! ‚úÖ');
            renderizarHistoricoOperadores(); // Atualiza a tabela
            carregarOperadoresDropdown(); // Atualiza o dropdown da Moagem
            limparFormOperador();
        } catch (error) {
            console.error("Erro ao cadastrar operador:", error);
            alert("Erro ao cadastrar operador. ‚ùå");
        }
    });
    
    async function renderizarHistoricoOperadores() {
        const tbody = document.getElementById('tabelaOperadoresBody');
        tbody.innerHTML = `<tr><td colspan="4">Carregando...</td></tr>`;
        try {
            const q = query(window.operadoresCol, orderBy("nome", "asc"));
            const querySnapshot = await getDocs(q);
            tbody.innerHTML = '';
            if (querySnapshot.empty) {
                 tbody.innerHTML = `<tr><td colspan="4">Nenhum operador cadastrado.</td></tr>`;
                 return;
            }
            querySnapshot.forEach(doc => {
                const reg = doc.data();
                const docId = doc.id;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(reg.dataCadastro + 'T03:00:00').toLocaleDateString('pt-BR')}</td>
                    <td>${reg.nome}</td>
                    <td>${reg.turno}</td>
                    <td>
                        <button class="delete-btn" onclick="deletarRegistroOperador('${docId}')">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch(error) {
             console.error("Erro ao carregar hist√≥rico de operadores:", error);
             tbody.innerHTML = `<tr><td colspan="4">Erro ao carregar dados.</td></tr>`;
        }
    }
    
    async function carregarOperadoresDropdown() {
        const select = document.getElementById('operadorMoagemSelect');
        select.innerHTML = '<option value="">Carregando...</option>';
        try {
            const q = query(window.operadoresCol, orderBy("nome", "asc"));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                select.innerHTML = '<option value="">Nenhum operador cadastrado</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Selecione um operador</option>';
            querySnapshot.forEach(doc => {
                const operador = doc.data();
                const option = document.createElement('option');
                option.value = operador.nome;
                option.textContent = operador.nome;
                select.appendChild(option);
            });
        } catch(error) {
             console.error("Erro ao carregar operadores no dropdown:", error);
             select.innerHTML = '<option value="">Erro ao carregar</option>';
        }
    }
    
    window.deletarRegistroOperador = async function(docId) {
        const t=prompt("Para confirmar a exclus√£o, digite a senha:");
        if(null!==t&&"pb2025"!==t) {
            alert("Senha incorreta. Exclus√£o cancelada.");
        } else if(confirm("Tem certeza que deseja excluir este OPERADOR? Isso n√£o afetar√° os lan√ßamentos antigos.")) {
            try{
                await window.deleteDoc(window.doc(db, "operadores_moagem", docId));
                alert("Operador exclu√≠do com sucesso!");
                renderizarHistoricoOperadores();
                carregarOperadoresDropdown();
            } catch(d) {
                console.error("Erro ao deletar operador: ", d);
                alert("Erro ao excluir. Verifique o console.");
            }
        }
    };


    // --- L√ìGICA DO DASHBOARD ---
    let pieChartTurnosInstance, barChartMensalInstance;

    async function atualizarDashboard() {
        const dataInicio = document.getElementById('dashFiltroDataInicio').value;
        const dataFim = document.getElementById('dashFiltroDataFim').value;
        const turno = document.getElementById('dashFiltroTurno').value;
        if (!dataInicio || !dataFim) return;
        ['kpiTotalMeta', 'kpiTotalRealizado', 'kpiEficiencia', 'kpiRetrabalho'].forEach(id => document.getElementById(id).textContent = '...');
        try {
            let qConstraints = [where("data", ">=", dataInicio), where("data", "<=", dataFim)];
            if (turno) qConstraints.push(where("turno", "==", turno));
            const q = query(window.massaCol, ...qConstraints); // Dashboard ainda usa massaCol
            const querySnapshot = await getDocs(q);
            const dados = querySnapshot.docs.map(doc => doc.data());
            calcularKPIs(dados);
            gerarGraficoPizzaTurnos(dados);
        } catch (error) {
            console.error("Erro ao atualizar dashboard:", error);
            alert("N√£o foi poss√≠vel carregar os dados do dashboard.");
        }
    }

    function calcularKPIs(dados) {
        const totais = dados.reduce((acc, reg) => {
            acc.meta += reg.metaKgFT || 0;
            acc.realizado += reg.kgCalculado || 0;
            acc.retrabalho += reg.retrabalhoKg || 0;
            return acc;
        }, { meta: 0, realizado: 0, retrabalho: 0 });
        const eficiencia = totais.meta > 0 ? (totais.realizado / totais.meta) * 100 : 0;
        document.getElementById('kpiTotalMeta').textContent = totais.meta.toLocaleString('pt-BR', { maximumFractionDigits: 0 });
        document.getElementById('kpiTotalRealizado').textContent = totais.realizado.toLocaleString('pt-BR', { maximumFractionDigits: 0 });
        const eficienciaEl = document.getElementById('kpiEficiencia');
        eficienciaEl.textContent = `${eficiencia.toFixed(2)}%`;
        eficienciaEl.className = 'value';
        if (eficiencia >= 98) eficienciaEl.classList.add('good'); else eficienciaEl.classList.add('bad');
        document.getElementById('kpiRetrabalho').textContent = totais.retrabalho.toLocaleString('pt-BR', { maximumFractionDigits: 0 });
    }

    function gerarGraficoPizzaTurnos(dados) {
        const producaoPorTurno = dados.reduce((acc, reg) => {
            if (!acc[reg.turno]) acc[reg.turno] = 0;
            acc[reg.turno] += reg.kgPalete || 0;
            return acc;
        }, {});
        if (pieChartTurnosInstance) pieChartTurnosInstance.destroy();
        const ctx = document.getElementById('pieChartTurnos').getContext('2d');
        pieChartTurnosInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(producaoPorTurno),
                datasets: [{
                    label: 'Produ√ß√£o (kg)',
                    data: Object.values(producaoPorTurno),
                    backgroundColor: ['#0077cc', '#28a745', '#ff9900', '#dc3545', '#6c757d', '#17a2b8', '#f012be'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    datalabels: {
                        formatter: (value, ctx) => {
                            const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            if (sum === 0) return '0.00%';
                            const percentage = (value * 100 / sum).toFixed(2) + '%';
                            return percentage;
                        },
                        color: '#fff',
                        font: { weight: 'bold', size: 14 }
                    }
                }
            }
        });
    }

    async function gerarGraficoProducaoMensal() {
        const turnoFiltro = document.getElementById('filtroTurnoGraficoMes').value;
        const hoje = new Date();
        const dozeMesesAtras = new Date(hoje.getFullYear() - 1, hoje.getMonth(), 1);
        const dataInicioStr = dozeMesesAtras.toISOString().split('T')[0];
        try {
            let qConstraints = [where("data", ">=", dataInicioStr)];
            if (turnoFiltro) qConstraints.push(where("turno", "==", turnoFiltro));
            const q = query(window.massaCol, ...qConstraints); // Dashboard ainda usa massaCol
            const querySnapshot = await getDocs(q);
            const dados = querySnapshot.docs.map(doc => doc.data());
            const producaoPorMes = {};
            for(let i=0; i<12; i++) {
                const d = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                producaoPorMes[`${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`] = 0;
            }
            dados.forEach(reg => {
                const mesAno = reg.data.substring(0, 7);
                if (producaoPorMes[mesAno] !== undefined) producaoPorMes[mesAno] += reg.kgPalete;
            });
            const labels = Object.keys(producaoPorMes).reverse();
            const data = Object.values(producaoPorMes).reverse();
            const labelsFormatados = labels.map(l => `${l.substring(5, 7)}/${l.substring(2, 4)}`);
            if (barChartMensalInstance) barChartMensalInstance.destroy();
            const ctx = document.getElementById('barChartMensal').getContext('2d');
            barChartMensalInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labelsFormatados,
                    datasets: [{
                        label: 'Produ√ß√£o Total (kg)',
                        data: data,
                        backgroundColor: 'rgba(0, 119, 204, 0.7)',
                        borderColor: 'rgba(0, 119, 204, 1)',
                        borderWidth: 1
                    }]
                },
                options: { 
                    scales: { y: { beginAtZero: true } },
                    plugins: {
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#444',
                            font: { weight: 'bold' },
                            formatter: (value) => {
                                return value > 0 ? value.toLocaleString('pt-BR') : '';
                            }
                        }
                    }
                }
            });
        } catch (error) { console.error("Erro ao gerar gr√°fico mensal:", error); }
    }
    
    document.addEventListener('DOMContentLoaded', async () => {
        const hojeStr = obterDataLocalFormatada();
        // Adicionado 'dataCadastroOperador' √† lista de campos de data
        ['data', 'filtroDataInicio', 'filtroDataFim', 'dataPesagem', 'dashFiltroDataInicio', 'dashFiltroDataFim', 'dataMoagem', 'dataCadastroOperador'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = hojeStr;
        });
        
        // Listeners Filtro Prensa
        document.querySelectorAll('.palete-select, .palete-qtd').forEach(el => el.addEventListener('input', calcularPesoTotalPaletes));
        ['filtroDataInicio', 'filtroDataFim', 'filtroTurno'].forEach(id => document.getElementById(id).addEventListener('change', renderizarHistorico));
        
        // Listeners Moagem
        document.getElementById('qtdCargasMoagem').addEventListener('input', atualizarCamposCargaMoagem);
        
        // --- ADICIONE ESTA LINHA ---
        document.getElementById('qtdCargasSubidas').addEventListener('input', atualizarCamposCargasSubidas);
        
        // Listeners Dashboard
        ['dashFiltroDataInicio', 'dashFiltroDataFim', 'dashFiltroTurno'].forEach(id => document.getElementById(id).addEventListener('change', atualizarDashboard));
        document.getElementById('filtroTurnoGraficoMes').addEventListener('change', gerarGraficoProducaoMensal);
        
        // Carregar Configs
        await carregarConfiguracoes(); // Filtro Prensa
        await carregarConfigPontosMoagem(); // Moagem
        
        // Carregar Dados Iniciais
        await carregarOpcoesPaletes();
        await carregarOperadoresDropdown(); // <-- Carrega operadores no dropdown
        
        renderizarHistorico();
        renderizarHistoricoPesagem();
        renderizarHistoricoMoagem(); 
        renderizarHistoricoOperadores(); // <-- Renderiza tabela de operadores
        
        calcularPesoTotalPaletes();
        limparFormMoagem(); 
        limparFormOperador();
        
        await atualizarDashboard();
        await gerarGraficoProducaoMensal();
    });

    // --- Fun√ß√µes Globais (Detalhes, Excluir) ---
    
    // Fun√ß√£o gen√©rica para expandir/recolher
    window.toggleDetalhes = function(detalhesId, botao) {
        const detalhesRow = document.getElementById(detalhesId);
        const btn = botao.closest('.expand-btn');
        
        if (detalhesRow.style.display === "table-row") {
            detalhesRow.style.display = "none";
            btn.classList.remove('open');
        } else {
            detalhesRow.style.display = "table-row";
            btn.classList.add('open');
        }
    };
    
    window.deletarRegistro = async function(d){
        const t=prompt("Para confirmar a exclus√£o, digite a senha:");
        if(null!==t&&"pb2025"!==t) alert("Senha incorreta. Exclus√£o cancelada.");
        else if(confirm("Tem certeza que deseja excluir este lan√ßamento (FILTRO PRENSA) do banco de dados?")) {
            try{
                await window.deleteDoc(window.doc(db,"producao_massa",d));
                alert("Registro exclu√≠do com sucesso!");
                renderizarHistorico();
            } catch(d) {
                console.error("Erro ao deletar do Firebase: ",d);
                alert("Erro ao excluir. Verifique o console.");
            }
        }
    };
    
    async function renderizarHistoricoPesagem(){
        const d=document.getElementById("tabelaPesagemBody");
        d.innerHTML='<tr><td colspan="4">Carregando dados...</td></tr>';
        try{
            const t=await window.getDocs(window.query(window.pesagemCol,window.orderBy("codigo")));
            d.innerHTML="";
            if(t.empty){
                d.innerHTML='<tr><td colspan="4">Nenhum registro de pesagem encontrado.</td></tr>';
                return;
            }
            t.forEach(t=>{
                const o=t.data(),e=t.id,n=document.createElement("tr");
                n.innerHTML=`
                 <td>${new Date(o.data+"T03:00:00").toLocaleDateString("pt-BR")}</td>
                 <td>${o.codigo}</td>
                 <td>${o.peso.toFixed(2)} kg</td>
                 <td>
                 <button class="edit-btn" onclick='editarRegistroPesagem("${e}", ${JSON.stringify(o)})'>Editar</button>
                 <button class="delete-btn" onclick="deletarRegistroPesagem('${e}')">Excluir</button>
                 </td>
                 `;
                 d.appendChild(n);
            });
        } catch(t) {
            console.error("Erro ao buscar hist√≥rico de pesagem: ",t);
            d.innerHTML='<tr><td colspan="4">Erro ao carregar dados.</td></tr>';
        }
    };
    
    window.editarRegistroPesagem=async function(d,t){
        const o=prompt("Para editar, por favor, insira a senha:");
        if("pb2025"!==o) return void alert("Senha incorreta. Opera√ß√£o cancelada.");
        const e=prompt("Editar Data (AAAA-MM-DD):",t.data); if(null===e)return;
        const n=prompt("Editar C√≥digo:",t.codigo); if(null===n)return;
        const a=prompt("Editar Peso (kg):",t.peso); if(null===a)return;
        const r={...t,data:e,codigo:n.trim().toUpperCase(),peso:parseFloat(a)};
        if(isNaN(r.peso)||!r.codigo) return void alert("Dados inv√°lidos. A edi√ß√£o foi cancelada.");
        try{
            await window.setDoc(window.doc(db,"pesagem_paletes",d),r);
            alert("Registro atualizado com sucesso!");
            renderizarHistoricoPesagem();
            carregarOpcoesPaletes();
        } catch(d) {
            console.error("Erro ao atualizar registro: ",d);
            alert("Falha ao atualizar o registro.");
        }
    };
    
    window.deletarRegistroPesagem=async function(d){
        const t=prompt("Para excluir, por favor, insira a senha:");
        if("pb2025"!==t) return void alert("Senha incorreta. Opera√ß√£o cancelada.");
        if(confirm("Tem certeza que deseja excluir este registro de pesagem?")) {
            try{
                await window.deleteDoc(window.doc(db,"pesagem_paletes",d));
                alert("Registro exclu√≠do com sucesso!");
                renderizarHistoricoPesagem();
                carregarOpcoesPaletes();
            } catch(d) {
                console.error("Erro ao excluir registro de pesagem:",d);
                alert("Falha ao excluir o registro.");
            }
        }
    };
    
    async function exportarExcel(){
        alert("Preparando o arquivo Excel com dados do Firebase (Filtro Prensa)...");
        const d=document.getElementById("filtroDataInicio").value,t=document.getElementById("filtroDataFim").value,o=document.getElementById("filtroTurno").value;
        let e=[window.orderBy("data","desc"),window.orderBy("timestamp","desc")];
        d&&e.push(window.where("data",">=",d));
        t&&e.push(window.where("data","<=",t));
        o&&e.push(window.where("turno","==",o));
        try{
            const d=await window.getDocs(window.query(window.massaCol,...e)),t=d.docs.map(d=>d.data());
            if(0===t.length)return void alert("Nenhum dado encontrado para exportar.");
            const o=t.map(d=>{
                var t;
                const o=d.metaKgFT||appConfig.metaKgFT,e=d.metaKgPalete||appConfig.metaKgPalete;
                const n=(null!==(t=d.retrabalhoKg)?t:d.kgPalete-d.kgCalculado);
                return{
                    'Data':new Date(d.data+"T03:00:00").toLocaleDateString("pt-BR"),
                    'Turno':d.turno,
                    'Qtd Filtros (FT)':d.qtdFT,
                    'Qtd Placas':d.qtdPlacas,
                    'KG Calculado':d.kgCalculado.toFixed(2),
                    'KG Palete (Real)':d.kgPalete.toFixed(2),
                    'Retrabalho (kg)':n.toFixed(2),
                    'Meta FT (kg)':o.toFixed(2),
                    'Meta Palete (kg)':e.toFixed(2),
                    '% Efici√™ncia FT':(d.kgCalculado/(o||1)*100).toFixed(2)+"%",
                    '% Efici√™ncia Palete':(d.kgPalete/(e||1)*100).toFixed(2)+"%",
                    'Observa√ß√£o':d.observacao
                }
            });
            const n=XLSX.utils.json_to_sheet(o),a=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(a,n,"Hist√≥rico de Massa");
            XLSX.writeFile(a,`Historico_Massa_${obterDataLocalFormatada()}.xlsx`);
        } catch(d) {
            console.error("Erro ao exportar dados do Firebase: ",d);
            alert("Ocorreu um erro ao preparar o arquivo.");
        }
    };
    </script>
</body>
</html>
