<!DOCTYPE html>
<html lang="pt-BR">
<head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width,initial-scale=1" />
      <title>Acompanhamento de Produ√ß√£o</title>

      <link rel="manifest" href="manifest.json" />
      <meta name="theme-color" content="#0077cc">
      <link rel="apple-touch-icon" href="icons/icon-180x180.png" />
      <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root{--primary:#0077cc;--muted:#e6f0ff;--card:#ffffff;--accent:#ff9900;--danger:#dc3545}
        *{box-sizing:border-box}
        body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--muted);color:#222}
        header{background:var(--primary);color:#fff;padding:14px 12px;text-align:center}
        .container{max-width:980px;margin:18px auto;padding:16px;background:var(--card);border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
        h1,h2{margin:0 0 12px}
        .nav{display:flex;flex-wrap: wrap; gap:8px;justify-content:center;margin-bottom:14px}
        .nav a{color:var(--primary);text-decoration:none;font-weight:700;padding:6px 10px;border-radius:6px;transition:background 0.2s}
        .nav a:hover{background:rgba(0,0,0,0.08)}
        .nav a.active{background:rgba(0,0,0,0.08)}
        form{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
        label{font-size:13px;font-weight:700;margin-bottom:4px;display:block}
        input[type="date"], input[type="text"], input[type="number"], select, textarea{width:100%;padding:8px;border:1px solid #cfd8e3;border-radius:6px}
        textarea{min-height:70px;resize:vertical}
        .full{grid-column:1/-1}
        button{background:var(--primary);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700;transition:background 0.2s}
        button:hover{filter:brightness(1.1)}
        button.secondary{background:#eee;color:#111}
        button.secondary:hover{background:#ddd;filter:none}
        button.delete-btn{background:var(--danger);padding:4px 8px;font-size:12px;}
        .filtros{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom: 12px;padding: 8px;border: 1px solid #ddd;border-radius: 8px;} 
        .filtros input, .filtros select{padding:8px;border-radius:6px;border:1px solid #ccc;}
        table{width:100%;border-collapse:collapse;margin-top:12px}
        th,td{border:1px solid #e0e6ef;padding:8px;text-align:center;font-size:13px}
        th{background:var(--primary);color:#fff}
        .table-porcentagem{min-width: 80px;} 
        @media(min-width:880px){form{grid-template-columns:repeat(3,1fr)}}
        .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin:20px 0 0;}
        .kpi-card{background:var(--muted);padding:12px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
        .kpi-card h3{font-size:14px;color:#555;margin:0 0 4px}
        .kpi-card p{font-size:28px;font-weight:bold;margin:0;color:var(--primary)} 
        .kpi-card.percent p{color:#00a000} 
        #analiseOperadorArea{
            border: 2px solid var(--accent);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            opacity: 1; transition: opacity 0.3s ease-in-out;
        }
        #analiseOperadorArea.hidden {
            opacity: 0;
            height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            border-color: transparent;
            overflow: hidden;
        }
        #analiseOperadorArea h3 {
            color: var(--accent);
            text-align: center;
            margin-bottom: 10px;
        }
        #analiseOperadorArea .kpi-card p {
            color: var(--accent); 
            font-size: 26px; 
        }
        .linha-detalhes {
            display: none;
            background-color: #f9f9f9;
        }
        .linha-detalhes td {
            padding: 10px 15px;
            text-align: left !important;
            border: 0;
        }
        .linha-detalhes .detalhe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
        }
        .detalhe-grid span {
            font-weight: bold;
            color: var(--primary);
        }
        .expand-btn {
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            padding: 2px 8px;
            border-radius: 50%;
            background-color: #ddd;
            border: none;
        }
        .expand-btn:hover {
            background-color: #ccc;
        }
        /* ESTILO PARA PAGINA√á√ÉO */
        .paginacao {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            gap: 10px;
        }
        .paginacao button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <header><h1>Acompanhamento de Produ√ß√£o</h1></header>

    <div class="container">
        <div class="nav">
            <a href="#" id="linkLanc" class="active" onclick="mostrarPagina('lancamento')">Lan√ßamento</a>
            <a href="#" id="linkOper" onclick="mostrarPagina('operadores')">Cadastro Operadores</a>
            <a href="#" id="linkHist" onclick="mostrarPagina('historico')">Hist√≥rico</a>
            <a href="#" id="linkDash" onclick="mostrarPagina('dashboard')">Dashboard</a>
        </div>

        <section id="lancamento">
            <h2>Lan√ßamento de Produ√ß√£o</h2>
            <form id="formProducao">
                <div>
                    <label>Data</label>
                    <input type="date" id="data" required />
                </div>
                <div>
                    <label>Setor</label>
                    <select id="setor" required>
                        <option value="">Selecione</option>
                        <option>Conforma√ß√£o</option>
                        <option>Esmalta√ß√£o</option>
                        <option>Embalagem</option>
                        <option>Forno Vidrado</option>
                        <option>Forno Chicote</option>
                    </select>
                </div>
                <div>
                    <label>Turno</label>
                    <select id="turno" required>
                        <option value="">Selecione</option>
                        <option>Comercial</option> 
                        <option>Turno 1 (6x2)</option>
                        <option>Turno 2 (6x2)</option>
                        <option>Turno 3 (6x2)</option>
                        <option>Turno 4 (6x2)</option>
                        <option>Turno 1 (5x2)</option>
                        <option>Turno 2 (5x2)</option>
                    </select>
                </div>
                <div>
                    <label>Operador</label>
                    <select id="operadorSelect" required>
                        <option value="">Selecione o setor</option>
                    </select>
                </div>
                <div>
                    <label>M√°quina</label>
                    <select id="maquinaSelect" required>
                        <option value="">Selecione o setor primeiro</option>
                    </select>
                </div>
                <div>
                    <label>Massa</label>
                    <select id="massa" required>
                        <option value="">Selecione</option>
                        <option>Stone</option>
                        <option>Faian√ßa</option>
                    </select>
                </div>
                <div>
                    <label>Refer√™ncia/CPB</label>
                    <input type="text" id="refCpb" />
                </div>
                <div>
                    <label>Produ√ß√£o Prevista</label>
                    <input type="number" id="prevista" min="0" required />
                </div>
                <div>
                    <label>Produ√ß√£o Realizada</label>
                    <input type="number" id="realizada" min="0" required />
                </div>
                <div>
                    <label>Quebras</label>
                    <input type="number" id="quebras" min="0" required />
                </div>
                <div class="full">
                    <label>Observa√ß√£o</label>
                    <textarea id="observacao"></textarea>
                </div>
                <div class="full" style="text-align:right;">
                    <button type="button" class="secondary" onclick="limparFormulario()">Limpar</button>
                    <button type="submit">Lan√ßar</button>
                </div>
            </form>
        </section>
        
        <section id="operadores" style="display:none;">
            <h2>Cadastro de Operadores</h2>
            <form id="formOperador">
                <div>
                    <label>Data do Cadastro</label>
                    <input type="date" id="dataCadastroOp" required />
                </div>
                <div>
                    <label>Nome do Operador</label>
                    <input type="text" id="nomeOperador" required placeholder="Nome completo" />
                </div>
                <div>
                    <label>Setor</label>
                    <select id="setorOperador" required>
                        <option value="">Selecione</option>
                        <option>Conforma√ß√£o</option>
                        <option>Esmalta√ß√£o</option>
                        <option>Embalagem</option>
                        <option>Forno Vidrado</option>
                        <option>Forno Chicote</option>
                    </select>
                </div>
                <div>
                    <label>Turno</label>
                    <select id="turnoOperador" required>
                        <option value="">Selecione</option>
                        <option>Comercial</option> 
                        <option>Turno 1 (6x2)</option>
                        <option>Turno 2 (6x2)</option>
                        <option>Turno 3 (6x2)</option>
                        <option>Turno 4 (6x2)</option>
                        <option>Turno 1 (5x2)</option>
                        <option>Turno 2 (5x2)</option>
                    </select>
                </div>
                <div class="full" style="text-align:right;">
                     <button type="submit">Cadastrar Operador</button>
                </div>
            </form>
            
            <h2 style="margin-top: 20px;">Operadores Cadastrados</h2>
             <table id="tabelaOperadores">
                <thead>
                    <tr>
                        <th>Data Cadastro</th>
                        <th>Nome</th>
                        <th>Setor</th>
                        <th>Turno</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <section id="historico" style="display:none">
            <h2>Hist√≥rico</h2>
            <div class="filtros">
                <input type="date" id="filtroDataInicio" placeholder="Data In√≠cio" />
                <input type="date" id="filtroDataFim" placeholder="Data Fim" />
                <select id="filtroSetor">
                    <option value="">Todos os Setores</option>
                    <option>Conforma√ß√£o</option>
                    <option>Esmalta√ß√£o</option>
                    <option>Embalagem</option>
                    <option>Forno Vidrado</option>
                    <option>Forno Chicote</option>
                </select>
                <select id="filtroTurno">
                    <option value="">Todos os Turnos</option>
                    <option>Comercial</option> 
                    <option>Turno 1 (6x2)</option>
                    <option>Turno 2 (6x2)</option>
                    <option>Turno 3 (6x2)</option>
                    <option>Turno 4 (6x2)</option>
                    <option>Turno 1 (5x2)</option>
                    <option>Turno 2 (5x2)</option>
                </select>
                <input type="text" id="filtroMaquina" placeholder="M√°quina..." list="listaMaquinasFiltro" />
                <datalist id="listaMaquinasFiltro"></datalist>
                <input type="text" id="filtroRefCpb" placeholder="Ref/CPB..." />
                <button onclick="filtrarHistorico()">Filtrar</button>
                <button class="secondary" onclick="buscarTodos()">Mostrar todos</button>
                <button style="background:green;" onclick="exportarExcel()">Exportar Excel</button>
            </div>

            <table id="tabelaHistorico">
                <thead>
                    <tr>
                        <th></th>
                        <th>Data</th>
                        <th>Setor</th>
                        <th>M√°quina</th>
                        <th>% Efic.</th>
                        <th>% Perda</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div class="paginacao">
                <button id="btnAnterior" onclick="paginaAnterior()">Anterior</button>
                <span id="infoPagina">P√°gina 1</span>
                <button id="btnProxima" onclick="proximaPagina()">Pr√≥xima</button>
            </div>
        </section>

        <section id="dashboard" style="display:none">
            <h2>Dashboard</h2>
            <div class="filtros">
                <input type="date" id="dashFiltroDataInicio" placeholder="Data In√≠cio" />
                <input type="date" id="dashFiltroDataFim" placeholder="Data Fim" />
                <select id="dashFiltroSetor">
                    <option value="">Todos os Setores</option>
                    <option>Conforma√ß√£o</option>
                    <option>Esmalta√ß√£o</option>
                    <option>Embalagem</option>
                    <option>Forno Vidrado</option>
                    <option>Forno Chicote</option>
                </select>
                <select id="dashFiltroTurno">
                    <option value="">Todos os Turnos</option>
                    <option>Comercial</option> 
                    <option>Turno 1 (6x2)</option>
                    <option>Turno 2 (6x2)</option>
                    <option>Turno 3 (6x2)</option>
                    <option>Turno 4 (6x2)</option>
                    <option>Turno 1 (5x2)</option>
                    <option>Turno 2 (5x2)</option>
                </select>
                <input type="text" id="dashFiltroMaquina" placeholder="M√°quina..." list="listaMaquinasDash" />
                <datalist id="listaMaquinasDash"></datalist>
                <input type="text" id="dashFiltroRefCpb" placeholder="Ref/CPB..."/>
                <input type="text" id="dashFiltroOperador" placeholder="Operador..." /> 
                <button onclick="atualizarDashboard()">Aplicar Filtro</button>
            </div>
            <h3>Resumo Geral da Produ√ß√£o (Filtros Aplicados)</h3>
            <div class="kpis" id="kpisResumo">
                <div class="kpi-card"><h3>Total Previsto</h3><p id="kpiPrevisto">0</p></div>
                <div class="kpi-card"><h3>Total Realizado</h3><p id="kpiRealizado">0</p></div>
                <div class="kpi-card"><h3>Total Quebras</h3><p id="kpiQuebras">0</p></div>
                <div class="kpi-card percent"><h3>% Realizado/Previsto</h3><p id="kpiPercRealPrev">N/A</p></div>
                <div class="kpi-card percent"><h3>% Quebras/Total</h3><p id="kpiPercQuebraTotal">N/A</p></div>
            </div>
            <div id="analiseOperadorArea">
                <h3>An√°lise do Operador: <span id="operadorSelecionado">Nenhum</span></h3>
                <div class="kpis" id="kpisOperador">
                    <div class="kpi-card"><h3>Previsto Operador</h3><p id="kpiOperadorPrevisto">0</p></div>
                    <div class="kpi-card"><h3>Realizado Operador</h3><p id="kpiOperadorRealizado">0</p></div>
                    <div class="kpi-card"><h3>Quebras Operador</h3><p id="kpiOperadorQuebras">0</p></div>
                    <div class="kpi-card percent"><h3>% Realizado/Previsto</h3><p id="kpiOperadorPercRealPrev">N/A</p></div>
                    <div class="kpi-card percent"><h3>% Quebras/Total</h3><p id="kpiOperadorPercQuebraTotal">N/A</p></div>
                </div>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, getDocs, 
            query, where, orderBy, deleteDoc, doc, limit, startAfter 
        } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "SUA_API_KEY_AQUI",
            authDomain: "acompanhamento-de-produc-b68b0.firebaseapp.com",
            projectId: "acompanhamento-de-produc-b68b0",
            storageBucket: "acompanhamento-de-produc-b68b0.firebasestorage.app",
            messagingSenderId: "891709449679",
            appId: "1:891709449679:web:43e83e076f5fb3201e1eba"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.producoesCol = collection(db, "producoes"); 
        window.operadoresCol = collection(db, "operadores");
        window.addDoc = addDoc;        
        window.getDocs = getDocs;      
        window.query = query;          
        window.where = where;          
        window.orderBy = orderBy;      
        window.deleteDoc = deleteDoc;  
        window.doc = doc;
        // NOVAS FUN√á√ïES DO FIREBASE PARA PAGINA√á√ÉO
        window.limit = limit;
        window.startAfter = startAfter;
        
        console.log("Firebase e Firestore inicializados!");
    </script>

<script>
// Vari√°veis globais
let db, producoesCol, operadoresCol;

// VARI√ÅVEIS DE CONTROLE DA PAGINA√á√ÉO
const ITENS_POR_PAGINA = 30;
let ultimoDocumentoVisivel = null;
let primeiroDocumentoStack = [null]; // Armazena o primeiro item de cada p√°gina para poder voltar
let paginaAtual = 1;
let filtroAtual = null;

document.addEventListener("DOMContentLoaded", ()=>{
    db = window.db; 
    producoesCol = window.producoesCol; 
    operadoresCol = window.operadoresCol;
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("data").value = today;
    document.getElementById("dataCadastroOp").value = today;

    document.getElementById("filtroDataInicio").value = today;
    document.getElementById("filtroDataFim").value = today;

    document.getElementById("dashFiltroDataInicio").value = today;
    document.getElementById("dashFiltroDataFim").value = today;

    document.getElementById("setor").addEventListener("change", carregarOperadores);
    // document.getElementById("turno").addEventListener("change", carregarOperadores); // REMOVIDO
    document.getElementById("formOperador").addEventListener("submit", cadastrarOperador);

    document.getElementById('filtroSetor').addEventListener('change', () => {
        atualizarDatalistMaquina('filtroSetor', 'listaMaquinasFiltro');
    });
    document.getElementById('dashFiltroSetor').addEventListener('change', () => {
        atualizarDatalistMaquina('dashFiltroSetor', 'listaMaquinasDash');
    });
});

const maquinasPorSetor = {
    "Conforma√ß√£o":["Secador 2","Secador 3","Secador 4","Secador 10","M√°quina de X√≠cara 1","M√°quina de X√≠cara 2","M√°quina de Prato","Prensa"],
    "Esmalta√ß√£o":["Disco 1","Disco 2","Disco 3","Disco 4","Rob√¥ 1","Rob√¥ 2","Spray","Imers√£o"],
    "Embalagem":["Linha 1","Linha 2","Linha 3","Linha 4","Linha 5"],
    "Forno Vidrado":["Forno 1","Forno 2"],
    "Forno Chicote":["Forno 3"]
};

document.getElementById("setor").addEventListener("change", e=>{
    const setor = e.target.value;
    const maqSelect = document.getElementById("maquinaSelect");
    maqSelect.innerHTML='<option value="">(Selecione ou Digite)</option>';
    if(maquinasPorSetor[setor]){
        maquinasPorSetor[setor].forEach(m=>{
            const opt=document.createElement("option");
            opt.textContent=m; opt.value=m;
            maqSelect.appendChild(opt);
        });
    }
});

function atualizarDatalistMaquina(idSetor, idDatalist) {
    const setor = document.getElementById(idSetor).value;
    const datalist = document.getElementById(idDatalist);
    datalist.innerHTML = ''; 

    if (maquinasPorSetor[setor]) {
        maquinasPorSetor[setor].forEach(m => {
            const option = document.createElement('option');
            option.value = m;
            datalist.appendChild(option);
        });
    }
}

function mostrarPagina(pg){
    document.querySelectorAll("section").forEach(s=>s.style.display="none");
    document.getElementById(pg).style.display="block";
    document.querySelectorAll(".nav a").forEach(a=>a.classList.remove("active"));
    
    const linkId = `#link${pg.charAt(0).toUpperCase()}${pg.slice(1,4)}`;
    document.querySelector(linkId).classList.add("active");
    
    if(pg==="historico") filtrarHistorico(); 
    if(pg==="dashboard") atualizarDashboard();
    if(pg==="operadores") atualizarTabelaOperadores();
}

function toggleDetalhes(index) {
    const detalhesRow = document.getElementById(`detalhes-${index}`);
    const btn = event.target;
    if (detalhesRow.style.display === "table-row") {
        detalhesRow.style.display = "none";
        btn.textContent = "+";
    } else {
        detalhesRow.style.display = "table-row";
        btn.textContent = "-";
    }
}

async function cadastrarOperador(e) {
    e.preventDefault();
    if (!operadoresCol || !window.addDoc) { 
        alert("Aguarde, o Firebase ainda n√£o foi inicializado corretamente.");
        return;
    }
    const data = {
        dataCadastro: document.getElementById("dataCadastroOp").value,
        nome: document.getElementById("nomeOperador").value,
        setor: document.getElementById("setorOperador").value,
        turno: document.getElementById("turnoOperador").value
    };
    try {
        await window.addDoc(operadoresCol, data);
        alert("Operador cadastrado com sucesso!");
        document.getElementById("formOperador").reset();
        document.getElementById("dataCadastroOp").value = new Date().toISOString().split('T')[0];
        atualizarTabelaOperadores();
    } catch (error) {
        console.error("Erro ao cadastrar operador:", error);
        alert("Erro ao cadastrar operador. Verifique o console.");
    }
}

async function atualizarTabelaOperadores() {
    const tbody = document.querySelector("#tabelaOperadores tbody");
    tbody.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";

    if (!operadoresCol || !window.getDocs || !window.query) {
        tbody.innerHTML = "<tr><td colspan='5'>Erro: Firebase n√£o conectado.</td></tr>";
        return;
    }

    try {
        const q = window.query(operadoresCol, window.orderBy("nome"));
        const snapshot = await window.getDocs(q);
        
        if (snapshot.empty) {
            tbody.innerHTML = "<tr><td colspan='5'>Nenhum operador cadastrado.</td></tr>";
            return;
        }

        tbody.innerHTML = "";
        snapshot.forEach(doc => {
            const op = doc.data();
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${op.dataCadastro}</td>
                <td>${op.nome}</td>
                <td>${op.setor}</td>
                <td>${op.turno}</td>
                <td><button class="delete-btn" onclick="deletarOperador('${doc.id}')">Deletar</button></td>`;
            tbody.appendChild(tr);
        });
    } catch (error) {
        console.error("Erro ao buscar operadores:", error);
        tbody.innerHTML = "<tr><td colspan='5'>Erro ao carregar dados.</td></tr>";
    }
}

async function deletarOperador(docId) {
    const senhaCorreta = "pb2025";
    const senhaDigitada = prompt("Para confirmar a exclus√£o, digite a senha:");

    if (senhaDigitada === null) {
        return; 
    }

    if (senhaDigitada === senhaCorreta) {
        if (confirm("Tem certeza que deseja deletar este operador?")) {
            try {
                await window.deleteDoc(window.doc(db, "operadores", docId));
                alert("Operador deletado com sucesso!");
                atualizarTabelaOperadores();
            } catch (error) {
                console.error("Erro ao deletar operador:", error);
                alert("Erro ao deletar. Verifique o console.");
            }
        }
    } else {
        alert("Senha incorreta. A exclus√£o foi cancelada.");
    }
}

async function carregarOperadores() {
    const setor = document.getElementById("setor").value;
    const opSelect = document.getElementById("operadorSelect");

    opSelect.innerHTML = '<option value="">Carregando...</option>';
    opSelect.disabled = true;

    if (!setor) {
        opSelect.innerHTML = '<option value="">Selecione o setor</option>';
        opSelect.disabled = false;
        return;
    }

    try {
        const q = window.query(operadoresCol, 
            window.where("setor", "==", setor),
            window.orderBy("nome")
        );
        const snapshot = await window.getDocs(q);
        
        opSelect.innerHTML = '';
        if (snapshot.empty) {
            opSelect.innerHTML = '<option value="">Nenhum operador neste setor</option>';
        } else {
            opSelect.innerHTML = '<option value="">Selecione um operador</option>';
            snapshot.forEach(doc => {
                const nome = doc.data().nome;
                opSelect.add(new Option(nome, nome));
            });
        }
    } catch(error) {
        console.error("Erro ao carregar operadores:", error);
        opSelect.innerHTML = '<option value="">Erro ao carregar</option>';
    } finally {
        opSelect.disabled = false;
    }
}


document.getElementById("formProducao").addEventListener("submit", async (e)=>{
    e.preventDefault();
    if (!producoesCol || !window.addDoc) { 
        alert("Aguarde, o Firebase ainda n√£o foi inicializado corretamente.");
        return;
    }
    const data = {
        data:document.getElementById("data").value,
        setor:document.getElementById("setor").value,
        turno:document.getElementById("turno").value,
        operador:document.getElementById("operadorSelect").value,
        maquina:document.getElementById("maquinaSelect").value, 
        massa:document.getElementById("massa").value,
        refCpb:document.getElementById("refCpb").value,
        prevista:parseFloat(document.getElementById("prevista").value),
        realizada:parseFloat(document.getElementById("realizada").value),
        quebras:parseFloat(document.getElementById("quebras").value),
        observacao:document.getElementById("observacao").value,
        timestamp: new Date().toISOString()
    };
    try {
        await window.addDoc(producoesCol, data);
        alert("Lan√ßamento salvo com sucesso no Firebase! ‚úÖ");
        limparFormulario();
    } catch (error) {
        console.error("Erro ao adicionar documento: ", error);
        alert("Erro ao salvar o lan√ßamento. Verifique o console. ‚ùå"); 
    }
});

function limparFormulario(){
    document.getElementById("formProducao").reset();
    document.getElementById("operadorSelect").innerHTML = '<option value="">Selecione o setor</option>';
}

function deletarRegistro(docId) {
    const senhaCorreta = "pb2025";
    const senhaDigitada = prompt("Para confirmar a exclus√£o, digite a senha:");

    if (senhaDigitada === null) {
        return;
    }

    if (senhaDigitada === senhaCorreta) {
        if (confirm("Tem certeza que deseja deletar este registro de produ√ß√£o?")) {
            if (!docId || !producoesCol || !window.deleteDoc || !window.doc) {
                alert("Erro: ID do documento ou conex√£o Firebase inv√°lida.");
                return;
            }
            try {
                window.deleteDoc(window.doc(db, "producoes", docId))
                    .then(() => {
                        alert("Registro deletado com sucesso!");
                        filtrarHistorico(); // Recarrega a p√°gina atual
                    });
            } catch (error) {
                console.error("Erro de execu√ß√£o na dele√ß√£o: ", error);
                alert("Erro ao deletar o registro. Verifique o console.");
            }
        }
    } else {
        alert("Senha incorreta. A exclus√£o foi cancelada.");
    }
}

// FUN√á√ÉO ATUALIZARTABELA TOTALMENTE MODIFICADA PARA PAGINA√á√ÉO
async function atualizarTabela(filtro, direcao = null) {
    const tbody = document.querySelector("#tabelaHistorico tbody");
    tbody.innerHTML = "<tr><td colspan='6'>Carregando dados...</td></tr>";

    if (!producoesCol) {
        tbody.innerHTML = "<tr><td colspan='6'>Erro: O Firebase n√£o est√° conectado.</td></tr>";
        return;
    }

    let queryConstraints = [];
    // Adiciona filtros de data se existirem
    if (filtro && filtro.dataInicio) queryConstraints.push(window.where("data", ">=", filtro.dataInicio));
    if (filtro && filtro.dataFim) queryConstraints.push(window.where("data", "<=", filtro.dataFim));

    // Adiciona ordena√ß√£o
    const baseOrdering = [window.orderBy("data", "desc"), window.orderBy("timestamp", "desc")];
    queryConstraints.push(...baseOrdering);
    
    // L√≥gica de pagina√ß√£o
    if (direcao === 'proxima' && ultimoDocumentoVisivel) {
        queryConstraints.push(window.startAfter(ultimoDocumentoVisivel));
    } else if (direcao === 'anterior') {
        // Para voltar, usamos a pilha de primeiros documentos
        primeiroDocumentoStack.pop(); // Remove o cursor da p√°gina atual
        const cursorAnterior = primeiroDocumentoStack[primeiroDocumentoStack.length - 1];
        if(cursorAnterior){
            queryConstraints.push(window.startAfter(cursorAnterior));
        }
    }
    
    // Limita o n√∫mero de resultados
    queryConstraints.push(window.limit(ITENS_POR_PAGINA));
    
    const q = window.query(producoesCol, ...queryConstraints);

    try {
        const querySnapshot = await window.getDocs(q);
        const documentos = querySnapshot.docs;

        // Filtros locais (que n√£o podem ser feitos no query do Firebase)
        let filtrados = documentos.map(doc => ({ id: doc.id, ...doc.data() }));
        if (filtro) {
            filtrados = filtrados.filter(r =>
                (!filtro.setor || r.setor === filtro.setor) &&
                (!filtro.turno || r.turno === filtro.turno) &&
                (!filtro.maquina || (r.maquina && r.maquina.toLowerCase().includes(filtro.maquina.toLowerCase()))) &&
                (!filtro.refCpb || (r.refCpb && r.refCpb.toLowerCase().includes(filtro.refCpb.toLowerCase())))
            );
        }

        tbody.innerHTML = "";
        if (filtrados.length === 0) {
            tbody.innerHTML = `<tr><td colspan='6'>${paginaAtual > 1 ? 'Fim dos resultados.' : 'Nenhum registro encontrado.'}</td></tr>`;
            document.getElementById('btnProxima').disabled = true;
            return;
        }

        // Atualiza estado da pagina√ß√£o
        if(direcao === 'proxima'){
            primeiroDocumentoStack.push(documentos[0]);
        }
        
        ultimoDocumentoVisivel = documentos[documentos.length - 1];
        
        // Renderiza as linhas
        filtrados.forEach((r, index) => {
            const prev = parseFloat(r.prevista) || 0;
            const real = parseFloat(r.realizada) || 0;
            const queb = parseFloat(r.quebras) || 0;
            const percRealizadoPrevisto = prev > 0 ? ((real / prev) * 100).toFixed(2) + '%' : 'N/A';
            const totalProd = real + queb;
            const percQuebrasRealizado = totalProd > 0 ? ((queb / totalProd) * 100).toFixed(2) + '%' : 'N/A';
            
            const trPrincipal = document.createElement("tr");
            trPrincipal.innerHTML = `<td><button class="expand-btn" onclick="toggleDetalhes(${index})">+</button></td><td>${r.data}</td><td>${r.setor}</td><td>${r.maquina}</td><td>${percRealizadoPrevisto}</td><td>${percQuebrasRealizado}</td>`;
            
            const trDetalhes = document.createElement("tr");
            trDetalhes.classList.add("linha-detalhes");
            trDetalhes.id = `detalhes-${index}`;
            trDetalhes.innerHTML = `<td colspan="6"><div class="detalhe-grid"><div><span>Operador:</span> ${r.operador}</div><div><span>Turno:</span> ${r.turno}</div><div><span>Massa:</span> ${r.massa}</div><div><span>Ref/CPB:</span> ${r.refCpb || 'N/A'}</div><div><span>Prevista:</span> ${prev}</div><div><span>Realizada:</span> ${real}</div><div><span>Quebras:</span> ${queb}</div><div><span>Observa√ß√£o:</span> ${r.observacao || 'Nenhuma'}</div><div><span>A√ß√£o:</span> <button class="delete-btn" onclick="deletarRegistro('${r.id}')">Deletar</button></div></div></td>`;
            
            tbody.appendChild(trPrincipal);
            tbody.appendChild(trDetalhes);
        });

        // Habilita/Desabilita bot√µes
        document.getElementById('infoPagina').textContent = `P√°gina ${paginaAtual}`;
        document.getElementById('btnAnterior').disabled = (paginaAtual === 1);
        document.getElementById('btnProxima').disabled = (documentos.length < ITENS_POR_PAGINA);

    } catch (error) {
       console.error("Erro ao buscar documentos: ", error);
       tbody.innerHTML="<tr><td colspan='6'>Erro ao carregar dados. Verifique o console.</td></tr>";
    }
}

// FUN√á√ïES DE CONTROLE DA PAGINA√á√ÉO
function proximaPagina() {
    paginaAtual++;
    atualizarTabela(filtroAtual, 'proxima');
}

function paginaAnterior() {
    if (paginaAtual > 1) {
        paginaAtual--;
        atualizarTabela(filtroAtual, 'anterior');
    }
}

// FUN√á√ïES DE FILTRO MODIFICADAS PARA RESETAR A PAGINA√á√ÉO
function filtrarHistorico(){
    filtroAtual = {
        dataInicio:document.getElementById("filtroDataInicio").value,
        dataFim:document.getElementById("filtroDataFim").value,
        setor:document.getElementById("filtroSetor").value,
        turno:document.getElementById("filtroTurno").value,
        maquina:document.getElementById("filtroMaquina").value,
        refCpb:document.getElementById("filtroRefCpb").value
    };
    // Reseta o estado da pagina√ß√£o para uma nova busca
    paginaAtual = 1;
    ultimoDocumentoVisivel = null;
    primeiroDocumentoStack = [null];
    atualizarTabela(filtroAtual);
}

function buscarTodos(){
    document.getElementById("filtroDataInicio").value = "";
    document.getElementById("filtroDataFim").value = "";
    document.getElementById("filtroSetor").value = "";
    document.getElementById("filtroTurno").value = "";
    document.getElementById("filtroMaquina").value = "";
    document.getElementById("filtroRefCpb").value = "";
    
    // Reseta o estado da pagina√ß√£o
    filtroAtual = null;
    paginaAtual = 1;
    ultimoDocumentoVisivel = null;
    primeiroDocumentoStack = [null];
    atualizarTabela(null);
}

async function exportarExcel() {
    alert("Preparando dados para exporta√ß√£o. Isso pode levar um momento...");
    const filtro = {
        dataInicio: document.getElementById("filtroDataInicio").value,
        dataFim: document.getElementById("filtroDataFim").value,
        setor: document.getElementById("filtroSetor").value,
        turno: document.getElementById("filtroTurno").value,
        maquina: document.getElementById("filtroMaquina").value,
        refCpb: document.getElementById("filtroRefCpb").value
    };
    const conditions = [];
    if(filtro.dataInicio) conditions.push(window.where("data", ">=", filtro.dataInicio));
    if(filtro.dataFim) conditions.push(window.where("data", "<=", filtro.dataFim));
    const baseOrdering = [window.orderBy("data", "desc"), window.orderBy("timestamp", "desc")];
    let q = window.query(producoesCol, ...conditions, ...baseOrdering);
    try {
        const querySnapshot = await window.getDocs(q);
        const regs = [];
        querySnapshot.forEach(doc => regs.push({ id: doc.id, ...doc.data() }));
        let filtrados = regs.filter(r => 
            (!filtro.setor || r.setor === filtro.setor) &&
            (!filtro.turno || r.turno === filtro.turno) &&
            (!filtro.maquina || (r.maquina && r.maquina.toLowerCase().includes(filtro.maquina.toLowerCase()))) &&
            (!filtro.refCpb || (r.refCpb && r.refCpb.toLowerCase().includes(filtro.refCpb.toLowerCase())))
        );
        if (filtrados.length === 0) {
            alert("Nenhum dado para exportar com os filtros atuais.");
            return;
        }
        const dataToExport = filtrados.map(r => {
            const prev = parseFloat(r.prevista) || 0;
            const real = parseFloat(r.realizada) || 0;
            const queb = parseFloat(r.quebras) || 0;
            const percRealizadoPrevisto = prev > 0 ? `${((real / prev) * 100).toFixed(2)}%` : 'N/A';
            const totalProd = real + queb;
            const percQuebrasRealizado = totalProd > 0 ? `${((queb / totalProd) * 100).toFixed(2)}%` : 'N/A';
            return {
                "Data": r.data, "Setor": r.setor, "Turno": r.turno, "Operador": r.operador,
                "M√°quina": r.maquina, "Massa": r.massa, "Ref/CPB": r.refCpb,
                "Prevista": prev, "Realizada": real, "Quebras": queb, "Obs": r.observacao,
                "% Realizado/Previsto": percRealizadoPrevisto, "% Quebras/Total": percQuebrasRealizado,
            };
        });
        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Hist√≥rico");
        XLSX.writeFile(wb, `Historico_Filtrado_${new Date().toISOString().split('T')[0]}.xlsx`);
    } catch(error) {
        console.error("Erro ao exportar para Excel:", error);
        alert("Ocorreu um erro ao preparar os dados para exporta√ß√£o.");
    }
}


function filtrarDadosDashboardLocal(dados, filtro) {
    return dados.filter(d => 
        (!filtro.setor || d.setor === filtro.setor) &&
        (!filtro.turno || d.turno === filtro.turno) &&
        (!filtro.maquina || (d.maquina && d.maquina.toLowerCase().includes(filtro.maquina.toLowerCase()))) &&
        (!filtro.refCpb || (d.refCpb && d.refCpb.toLowerCase().includes(filtro.refCpb.toLowerCase()))) &&
        (!filtro.operador || (d.operador && d.operador.toLowerCase().includes(filtro.operador.toLowerCase())))
    );
}

function calcularKPIsEstatistica(dados, prefixo) {
    let totalPrevisto = 0, totalRealizado = 0, totalQuebras = 0;
    dados.forEach(d => {
        totalPrevisto += parseFloat(d.prevista) || 0;
        totalRealizado += parseFloat(d.realizada) || 0;
        totalQuebras += parseFloat(d.quebras) || 0;
    });
    const totalProducao = totalRealizado + totalQuebras;
    const percRealPrev = totalPrevisto > 0 ? `${((totalRealizado / totalPrevisto) * 100).toFixed(2)}%` : 'N/A';
    const percQuebraTotal = totalProducao > 0 ? `${((totalQuebras / totalProducao) * 100).toFixed(2)}%` : 'N/A';
    document.getElementById(`${prefixo}Previsto`).textContent = totalPrevisto.toLocaleString();
    document.getElementById(`${prefixo}Realizado`).textContent = totalRealizado.toLocaleString();
    document.getElementById(`${prefixo}Quebras`).textContent = totalQuebras.toLocaleString();
    document.getElementById(`${prefixo}PercRealPrev`).textContent = percRealPrev;
    document.getElementById(`${prefixo}PercQuebraTotal`).textContent = percQuebraTotal;
    
    if (prefixo === 'kpiOperador') {
        const areaOperador = document.getElementById('analiseOperadorArea');
        const operadorInput = document.getElementById('dashFiltroOperador').value.trim();
        if (operadorInput && dados.length > 0) {
            document.getElementById('operadorSelecionado').textContent = operadorInput.toUpperCase(); 
            areaOperador.classList.remove('hidden');
        } else {
            document.getElementById('operadorSelecionado').textContent = "Nenhum";
            areaOperador.classList.add('hidden'); 
        }
    }
}

async function atualizarDashboard(){
    if (!producoesCol || !window.getDocs || !window.query) {
        console.error("Firebase n√£o conectado para o Dashboard."); return;
    }
    const filtro = {
        dataInicio: document.getElementById("dashFiltroDataInicio").value,
        dataFim: document.getElementById("dashFiltroDataFim").value,
        setor: document.getElementById("dashFiltroSetor").value,
        turno: document.getElementById("dashFiltroTurno").value,
        maquina: document.getElementById("dashFiltroMaquina").value,
        refCpb: document.getElementById("dashFiltroRefCpb").value.trim(),
        operador: document.getElementById("dashFiltroOperador").value.trim()
    };
    const conditions = [];
    if(filtro.dataInicio) conditions.push(window.where("data", ">=", filtro.dataInicio));
    if(filtro.dataFim) conditions.push(window.where("data", "<=", filtro.dataFim));
    const baseOrdering = [window.orderBy("data", "desc")];
    let q = window.query(producoesCol, ...conditions, ...baseOrdering);
    try {
        const querySnapshot = await window.getDocs(q);
        const dadosGerais = [];
        querySnapshot.forEach(doc => dadosGerais.push(doc.data()));
        const dadosFiltradosGeral = filtrarDadosDashboardLocal(dadosGerais, filtro);
        calcularKPIsEstatistica(dadosFiltradosGeral, 'kpi');
        
        let dadosOperador = [];
        if (filtro.operador) {
            const filtroOperadorApenasData = { 
                dataInicio: filtro.dataInicio, dataFim: filtro.dataFim, operador: filtro.operador,
                setor: '', turno: '', maquina: '', refCpb: ''
            };
            dadosOperador = filtrarDadosDashboardLocal(dadosGerais, filtroOperadorApenasData); 
        }
        calcularKPIsEstatistica(dadosOperador, 'kpiOperador');
        
    } catch (error) {
        console.error("Erro ao carregar dados para o Dashboard: ", error);
    }
}

window.deletarRegistro = deletarRegistro;
window.deletarOperador = deletarOperador;
window.filtrarHistorico = filtrarHistorico;
window.buscarTodos = buscarTodos;
window.exportarExcel = exportarExcel;
window.atualizarDashboard = atualizarDashboard;
window.limparFormulario = limparFormulario;
window.mostrarPagina = mostrarPagina;
window.toggleDetalhes = toggleDetalhes;
window.proximaPagina = proximaPagina;     // Torna as fun√ß√µes de pagina√ß√£o globais
window.paginaAnterior = paginaAnterior;
</script>
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("Service Worker registrado com sucesso."))
    .catch(err => console.log("Erro ao registrar o Service Worker:", err));
}
</script>
<script>
let deferredPrompt;
const installBtn = document.createElement("button");
installBtn.textContent = "üì• Instalar Aplicativo";
installBtn.style.display = "none";
installBtn.style.position = "fixed";
installBtn.style.bottom = "20px";
installBtn.style.right = "20px";
installBtn.style.padding = "10px 16px";
installBtn.style.background = "#0077cc";
installBtn.style.color = "#fff";
installBtn.style.border = "none";
installBtn.style.borderRadius = "8px";
installBtn.style.cursor = "pointer";
document.body.appendChild(installBtn);

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = "block";

  installBtn.addEventListener("click", () => {
    installBtn.style.display = "none";
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(choiceResult => {
      if (choiceResult.outcome === "accepted") {
        console.log("Usu√°rio aceitou instalar o app");
      } else {
        console.log("Usu√°rio recusou instalar o app");
      }
      deferredPrompt = null;
    });
  });
});
</script>
</body>
</html>
