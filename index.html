<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Acompanhamento de Produ√ß√£o</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root{--primary:#0077cc;--muted:#e6f0ff;--card:#ffffff;--accent:#ff9900;--danger:#dc3545}
        *{box-sizing:border-box}
        body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--muted);color:#222}
        header{background:var(--primary);color:#fff;padding:14px 12px;text-align:center}
        .container{max-width:980px;margin:18px auto;padding:16px;background:var(--card);border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
        h1,h2{margin:0 0 12px}
        .nav{display:flex;gap:8px;justify-content:center;margin-bottom:14px}
        .nav a{color:var(--primary);text-decoration:none;font-weight:700;padding:6px 10px;border-radius:6px;transition:background 0.2s}
        .nav a:hover{background:rgba(0,0,0,0.08)}
        .nav a.active{background:rgba(0,0,0,0.08)}
        form{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
        label{font-size:13px;font-weight:700;margin-bottom:4px;display:block}
        input[type="date"], input[type="text"], input[type="number"], select, textarea{width:100%;padding:8px;border:1px solid #cfd8e3;border-radius:6px}
        textarea{min-height:70px;resize:vertical}
        .full{grid-column:1/-1}
        button{background:var(--primary);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700;transition:background 0.2s}
        button:hover{filter:brightness(1.1)}
        button.secondary{background:#eee;color:#111}
        button.secondary:hover{background:#ddd;filter:none}
        button.delete-btn{background:var(--danger);padding:4px 8px;font-size:12px;}
        .filtros{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom: 12px;padding: 8px;border: 1px solid #ddd;border-radius: 8px;} 
        .filtros input, .filtros select{padding:8px;border-radius:6px;border:1px solid #ccc;}
        table{width:100%;border-collapse:collapse;margin-top:12px}
        th,td{border:1px solid #e0e6ef;padding:8px;text-align:center;font-size:13px}
        th{background:var(--primary);color:#fff}
        .table-porcentagem{min-width: 80px;} 
        .charts{display:grid;gap:18px;margin-top:20px}
        canvas {background-color: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
        @media(min-width:880px){form{grid-template-columns:repeat(3,1fr)}.charts{grid-template-columns:1fr 1fr}}
        .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin:20px 0 0;}
        .kpi-card{background:var(--muted);padding:12px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
        .kpi-card h3{font-size:14px;color:#555;margin:0 0 4px}
        .kpi-card p{font-size:28px;font-weight:bold;margin:0;color:var(--primary)} 
        .kpi-card.percent p{color:#00a000} 
        #analiseOperadorArea{
            border: 2px solid var(--accent);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            /* Estilo para ocultar quando n√£o houver operador selecionado */
            opacity: 1; transition: opacity 0.3s ease-in-out;
        }
        #analiseOperadorArea.hidden {
            opacity: 0;
            height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            border-color: transparent;
            overflow: hidden;
        }
        #analiseOperadorArea h3 {
            color: var(--accent);
            text-align: center;
            margin-bottom: 10px;
        }
        #analiseOperadorArea .kpi-card p {
            color: var(--accent); 
            font-size: 26px; 
        }
    </style>
</head>
<body>
    <header><h1>Acompanhamento de Produ√ß√£o</h1></header>

    <div class="container">
        <div class="nav">
            <a href="#" id="linkLanc" class="active" onclick="mostrarPagina('lancamento')">Lan√ßamento</a>
            <a href="#" id="linkHist" onclick="mostrarPagina('historico')">Hist√≥rico</a>
            <a href="#" id="linkDash" onclick="mostrarPagina('dashboard')">Dashboard</a>
        </div>

        <section id="lancamento">
            <h2>Lan√ßamento de Produ√ß√£o</h2>
            <form id="formProducao">
                <div>
                    <label>Data</label>
                    <input type="date" id="data" required />
                </div>

                <div>
                    <label>Setor</label>
                    <select id="setor" required>
                        <option value="">Selecione</option>
                        <option>Conforma√ß√£o</option>
                        <option>Esmalta√ß√£o</option>
                        <option>Embalagem</option>
                        <option>Forno Vidrado</option>
                        <option>Forno Chicote</option>
                    </select>
                </div>

                <div>
                    <label>Turno</label>
                    <select id="turno" required>
                        <option value="">Selecione</option>
                        <option>Comercial</option> 
                        <option>Turno 1 (6x2)</option>
                        <option>Turno 2 (6x2)</option>
                        <option>Turno 3 (6x2)</option>
                        <option>Turno 4 (6x2)</option>
                        <option>Turno 1 (5x2)</option>
                        <option>Turno 2 (5x2)</option>
                    </select>
                </div>
                
                <div>
                    <label>Operador</label>
                    <input type="text" id="operador" required />
                </div>

                <div>
                    <label>M√°quina</label>
                    <select id="maquinaSelect" required>
                        <option value="">Selecione o setor primeiro</option>
                    </select>
                </div>

                <div>
                    <label>Massa</label>
                    <select id="massa" required>
                        <option value="">Selecione</option>
                        <option>Stone</option>
                        <option>Faian√ßa</option>
                    </select>
                </div>

                <div>
                    <label>Produ√ß√£o Prevista</label>
                    <input type="number" id="prevista" min="0" required />
                </div>

                <div>
                    <label>Produ√ß√£o Realizada</label>
                    <input type="number" id="realizada" min="0" required />
                </div>

                <div>
                    <label>Quebras</label>
                    <input type="number" id="quebras" min="0" required />
                </div>

                <div class="full">
                    <label>Observa√ß√£o</label>
                    <textarea id="observacao"></textarea>
                </div>

                <div class="full" style="text-align:right;">
                    <button type="button" class="secondary" onclick="limparFormulario()">Limpar</button>
                    <button type="submit">Lan√ßar</button>
                </div>
            </form>
        </section>

        <section id="historico" style="display:none">
            <h2>Hist√≥rico</h2>

            <div class="filtros">
                <input type="date" id="filtroDataInicio" placeholder="Data In√≠cio" />
                <input type="date" id="filtroDataFim" placeholder="Data Fim" />
                <select id="filtroSetor">
                    <option value="">Todos os Setores</option>
                    <option>Conforma√ß√£o</option>
                    <option>Esmalta√ß√£o</option>
                    <option>Embalagem</option>
                    <option>Forno Vidrado</option>
                    <option>Forno Chicote</option>
                </select>
                <select id="filtroTurno">
                    <option value="">Todos os Turnos</option>
                    <option>Comercial</option> 
                    <option>Turno 1 (6x2)</option>
                    <option>Turno 2 (6x2)</option>
                    <option>Turno 3 (6x2)</option>
                    <option>Turno 4 (6x2)</option>
                    <option>Turno 1 (5x2)</option>
                    <option>Turno 2 (5x2)</option>
                </select>
                <input type="text" id="filtroMaquina" placeholder="M√°quina..." />
                <button onclick="filtrarHistorico()">Filtrar</button>
                <button class="secondary" onclick="buscarTodos()">Mostrar todos</button>
                <button style="background:green;" onclick="exportarExcel()">Exportar Excel</button>
            </div>

            <table id="tabelaHistorico">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Setor</th>
                        <th>Turno</th>
                        <th>Operador</th>
                        <th>M√°quina</th>
                        <th>Massa</th>
                        <th>Prevista</th>
                        <th>Realizada</th>
                        <th>Quebras</th>
                        <th>Obs</th>
                        <th class="table-porcentagem">% Realizado/Previsto</th>
                        <th class="table-porcentagem">% Quebras/Total</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <section id="dashboard" style="display:none">
            <h2>Dashboard</h2>

            <div class="filtros">
                <input type="date" id="dashFiltroDataInicio" placeholder="Data In√≠cio" />
                <input type="date" id="dashFiltroDataFim" placeholder="Data Fim" />
                
                <select id="dashFiltroSetor">
                    <option value="">Todos os Setores</option>
                    <option>Conforma√ß√£o</option>
                    <option>Esmalta√ß√£o</option>
                    <option>Embalagem</option>
                    <option>Forno Vidrado</option>
                    <option>Forno Chicote</option>
                </select>

                <select id="dashFiltroTurno">
                    <option value="">Todos os Turnos</option>
                    <option>Comercial</option> 
                    <option>Turno 1 (6x2)</option>
                    <option>Turno 2 (6x2)</option>
                    <option>Turno 3 (6x2)</option>
                    <option>Turno 4 (6x2)</option>
                    <option>Turno 1 (5x2)</option>
                    <option>Turno 2 (5x2)</option>
                </select>
                <input type="text" id="dashFiltroMaquina" placeholder="M√°quina..." />
                <input type="text" id="dashFiltroOperador" placeholder="Operador..." /> 
                <button onclick="atualizarDashboard()">Aplicar Filtro</button>
            </div>
            
            <h3>Resumo Geral da Produ√ß√£o (Filtros Aplicados)</h3>
            <div class="kpis" id="kpisResumo">
                <div class="kpi-card"><h3>Total Previsto</h3><p id="kpiPrevisto">0</p></div>
                <div class="kpi-card"><h3>Total Realizado</h3><p id="kpiRealizado">0</p></div>
                <div class="kpi-card"><h3>Total Quebras</h3><p id="kpiQuebras">0</p></div>
                <div class="kpi-card percent"><h3>% Realizado/Previsto</h3><p id="kpiPercRealPrev">N/A</p></div>
                <div class="kpi-card percent"><h3>% Quebras/Total</h3><p id="kpiPercQuebraTotal">N/A</p></div>
            </div>
            
            <div id="analiseOperadorArea">
                <h3>An√°lise do Operador: <span id="operadorSelecionado">Nenhum</span></h3>
                <div class="kpis" id="kpisOperador">
                    <div class="kpi-card"><h3>Previsto Operador</h3><p id="kpiOperadorPrevisto">0</p></div>
                    <div class="kpi-card"><h3>Realizado Operador</h3><p id="kpiOperadorRealizado">0</p></div>
                    <div class="kpi-card"><h3>Quebras Operador</h3><p id="kpiOperadorQuebras">0</p></div>
                    <div class="kpi-card percent"><h3>% Realizado/Previsto</h3><p id="kpiOperadorPercRealPrev">N/A</p></div>
                    <div class="kpi-card percent"><h3>% Quebras/Total</h3><p id="kpiOperadorPercQuebraTotal">N/A</p></div>
                </div>
            </div>


            <div class="charts">
                <canvas id="graficoProducao"></canvas>
                <canvas id="graficoQuebras"></canvas>
                <canvas id="graficoTurnos"></canvas>
            </div>
        </section>
    </div>

    <script type="module">
        // Importa as fun√ß√µes de inicializa√ß√£o do Firebase App
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        // Importa as fun√ß√µes necess√°rias para o Firestore
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            query, 
            where, 
            orderBy, 
            deleteDoc, 
            doc 
        } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // SUA CONFIGURA√á√ÉO DO FIREBASE (‚ö†Ô∏è IMPORTANTE: SUBSTITUA 'SUA_API_KEY_AQUI' PELA SUA CHAVE REAL)
        const firebaseConfig = {
            apiKey: "SUA_API_KEY_AQUI", // üö® COLOQUE SUA API KEY REAL AQUI!
            authDomain: "acompanhamento-de-produc-b68b0.firebaseapp.com",
            projectId: "acompanhamento-de-produc-b68b0",
            storageBucket: "acompanhamento-de-produc-b68b0.firebasestorage.app",
            messagingSenderId: "891709449679",
            appId: "1:891709449679:web:43e83e076f5fb3201e1eba"
        };

        // Inicializa o Firebase App
        const app = initializeApp(firebaseConfig);
        
        // Inicializa o Firestore
        const db = getFirestore(app);
        
        // Torna as refer√™ncias e fun√ß√µes do Firestore globais (window.funcao)
        // Isso √© necess√°rio porque o m√≥dulo JS (import) tem escopo isolado
        window.db = db;
        window.producoesCol = collection(db, "producoes"); 
        window.addDoc = addDoc;        
        window.getDocs = getDocs;      
        window.query = query;          
        window.where = where;          
        window.orderBy = orderBy;      
        window.deleteDoc = deleteDoc;  
        window.doc = doc;              
        
        console.log("Firebase e Firestore inicializados!");
    </script>

<script>
// Vari√°veis globais para as refer√™ncias do Firebase (preenchidas no DOMContentLoaded)
let db, producoesCol;

document.addEventListener("DOMContentLoaded", ()=>{
    // Pega as refer√™ncias globais do script de m√≥dulo
    db = window.db; 
    producoesCol = window.producoesCol; 
    
    // Configura datas iniciais
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("data").value = today;
    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    document.getElementById("dashFiltroDataInicio").value = sevenDaysAgo;
    document.getElementById("dashFiltroDataFim").value = today;

    // Garante que o dashboard e hist√≥rico carreguem dados na primeira vez (ou quando trocados)
    // Embora mostrarPagina('lancamento') seja o padr√£o, adicionamos para o caso de o usu√°rio ir direto para outra aba
    // Sem uma aba selecionada, n√£o executamos as fun√ß√µes aqui. A fun√ß√£o mostrarPagina se encarrega disso.

});

const maquinasPorSetor = {
    "Conforma√ß√£o":["Secador 2","Secador 3","Secador 4","Secador 10","M√°quina de X√≠cara 1","M√°quina de X√≠cara 2","M√°quina de Prato","Prensa"],
    "Esmalta√ß√£o":["Disco 1","Disco 2","Disco 3","Disco 4","Rob√¥ 1","Rob√¥ 2","Spray","Imers√£o"],
    "Embalagem":["Linha 1","Linha 2","Linha 3","Linha 4","Linha 5"],
    "Forno Vidrado":["Forno 1","Forno 2"],
    "Forno Chicote":["Forno 3"]
};

document.getElementById("setor").addEventListener("change", e=>{
    const setor=e.target.value;
    const maqSelect=document.getElementById("maquinaSelect");
    maqSelect.innerHTML="";
    
    const optDefault=document.createElement("option");
    optDefault.textContent="(Selecione ou Digite)";
    optDefault.value="";
    maqSelect.appendChild(optDefault);

    if(maquinasPorSetor[setor]){
        maquinasPorSetor[setor].forEach(m=>{
            const opt=document.createElement("option");
            opt.textContent=m; opt.value=m;
            maqSelect.appendChild(opt);
        });
    }
});

function mostrarPagina(pg){
    document.querySelectorAll("section").forEach(s=>s.style.display="none");
    document.getElementById(pg).style.display="block";
    document.querySelectorAll(".nav a").forEach(a=>a.classList.remove("active"));
    document.querySelector(`#link${pg.charAt(0).toUpperCase()+pg.slice(1)}`).classList.add("active");
    
    // üí° Atualiza os dados quando a aba √© mostrada
    if(pg==="historico") atualizarTabela();
    if(pg==="dashboard") atualizarDashboard();
}

/**
 * Lan√ßa o registro no Firestore. 
 */
document.getElementById("formProducao").addEventListener("submit", async (e)=>{
    e.preventDefault();
    
    if (!producoesCol || !window.addDoc) { 
        alert("Aguarde, o Firebase ainda n√£o foi inicializado corretamente.");
        return;
    }
    
    const data = {
        data:document.getElementById("data").value,
        setor:document.getElementById("setor").value,
        turno:document.getElementById("turno").value,
        operador:document.getElementById("operador").value,
        maquina:document.getElementById("maquinaSelect").value, 
        massa:document.getElementById("massa").value,
        prevista:parseFloat(document.getElementById("prevista").value),
        realizada:parseFloat(document.getElementById("realizada").value),
        quebras:parseFloat(document.getElementById("quebras").value),
        observacao:document.getElementById("observacao").value,
        timestamp: new Date().toISOString()
    };

    try {
        await window.addDoc(producoesCol, data);
        alert("Lan√ßamento salvo com sucesso no Firebase! ‚úÖ");
        limparFormulario();
    } catch (error) {
        console.error("Erro ao adicionar documento: ", error);
        alert("Erro ao salvar o lan√ßamento. Verifique o console. ‚ùå"); 
    }
});

function limparFormulario(){document.getElementById("formProducao").reset();}

/**
 * Deleta um registro no Firestore. 
 * @param {string} docId O ID do documento a ser deletado.
 */
function deletarRegistro(docId) {
    if (confirm("Tem certeza que deseja deletar este registro de produ√ß√£o?")) {
        
        if (!docId || !producoesCol || !window.deleteDoc || !window.doc) {
            alert("Erro: ID do documento ou conex√£o Firebase inv√°lida.");
            return;
        }
        
        try {
            window.deleteDoc(window.doc(db, "producoes", docId))
                .then(() => {
                    alert("Registro deletado com sucesso!");
                    atualizarTabela(); 
                })
                .catch(error => {
                    console.error("Erro ao deletar documento: ", error);
                    alert("Erro ao deletar o registro. Verifique o console.");
                });
            
        } catch (error) {
            console.error("Erro de execu√ß√£o na dele√ß√£o: ", error);
            alert("Erro ao deletar o registro. Verifique o console.");
        }
    }
}

/**
 * Busca e atualiza a tabela com dados do Firestore (opcionalmente filtrados). 
 * @param {object|null} filtro Objeto de filtro ou null.
 */
async function atualizarTabela(filtro=null){
    const tbody=document.querySelector("#tabelaHistorico tbody");
    tbody.innerHTML="<tr><td colspan='13'>Carregando dados...</td></tr>";
    
    if (!producoesCol || !window.getDocs || !window.query) {
        tbody.innerHTML="<tr><td colspan='13'>Erro: O Firebase n√£o est√° conectado.</td></tr>";
        return;
    }

    // 1. Cria a query para o Firestore (apenas filtros de Data)
    const conditions = [];
    
    if(filtro){
        if(filtro.dataInicio) conditions.push(window.where("data", ">=", filtro.dataInicio));
        if(filtro.dataFim) conditions.push(window.where("data", "<=", filtro.dataFim));
    }
    
    let q;
    // Otimiza a query: ordena por data (o campo filtrado) e, depois, por timestamp
    const baseOrdering = [window.orderBy("data", "desc"), window.orderBy("timestamp", "desc")];
    q = window.query(producoesCol, ...conditions, ...baseOrdering);


    try {
        // 2. Executa a busca no Firestore
        const querySnapshot = await window.getDocs(q);
        const regs = [];
        querySnapshot.forEach(doc => {
            regs.push({ id: doc.id, ...doc.data() });
        });

        let filtrados = regs;
        
        // 3. Filtros Locais (Setor, Turno, M√°quina)
        if(filtro){
            filtrados = filtrados.filter(r => 
                (!filtro.setor || r.setor === filtro.setor) &&
                (!filtro.turno || r.turno === filtro.turno) &&
                (!filtro.maquina || (r.maquina && r.maquina.toLowerCase().includes(filtro.maquina.toLowerCase())))
            );
        }

        // 4. Renderiza a tabela
        tbody.innerHTML="";
        if (filtrados.length === 0) {
               tbody.innerHTML="<tr><td colspan='13'>Nenhum registro encontrado com este filtro.</td></tr>";
               return;
        }
        
        filtrados.forEach(r=>{
            const prev = parseFloat(r.prevista) || 0;
            const real = parseFloat(r.realizada) || 0;
            const queb = parseFloat(r.quebras) || 0;
            
            const percRealizadoPrevisto = prev > 0 ? ((real / prev) * 100).toFixed(2) + '%' : (real > 0 ? 'INF' : 'N/A');

            const totalProd = real + queb;
            const percQuebrasRealizado = totalProd > 0 ? ((queb / totalProd) * 100).toFixed(2) + '%' : 'N/A';
            
            const tr=document.createElement("tr");
            tr.innerHTML=`<td>${r.data}</td><td>${r.setor}</td><td>${r.turno}</td><td>${r.operador}</td>
                <td>${r.maquina}</td><td>${r.massa}</td>
                <td>${prev}</td><td>${real}</td><td>${queb}</td><td>${r.observacao}</td>
                <td>${percRealizadoPrevisto}</td>
                <td>${percQuebrasRealizado}</td>
                <td><button class="delete-btn" onclick="deletarRegistro('${r.id}')">Deletar</button></td>`; 
            tbody.appendChild(tr);
        });
    } catch (error) {
       console.error("Erro ao buscar documentos: ", error);
       tbody.innerHTML="<tr><td colspan='13'>Erro ao carregar dados. Verifique o console.</td></tr>";
    }
}

function filtrarHistorico(){
    const filtro={
        dataInicio:document.getElementById("filtroDataInicio").value,
        dataFim:document.getElementById("filtroDataFim").value,
        setor:document.getElementById("filtroSetor").value,
        turno:document.getElementById("filtroTurno").value,
        maquina:document.getElementById("filtroMaquina").value 
    };
    atualizarTabela(filtro);
}

function buscarTodos(){
    document.getElementById("filtroDataInicio").value = "";
    document.getElementById("filtroDataFim").value = "";
    document.getElementById("filtroSetor").value = "";
    document.getElementById("filtroTurno").value = "";
    document.getElementById("filtroMaquina").value = "";
    atualizarTabela(null);
}

function exportarExcel(){
    const rows=[...document.querySelectorAll("#tabelaHistorico tbody tr")];
    if(rows.length===0 || rows[0].textContent.includes('Carregando dados') || rows[0].textContent.includes('Nenhum registro')){
        alert("Nenhum dado v√°lido para exportar.");
        return;
    }
    
    // Removendo a coluna 'A√ß√£o'
    const headers = [...document.querySelectorAll("#tabelaHistorico thead th")].map(th => th.textContent).slice(0, -1);
    
    const data = [];
    rows.forEach(r => {
        const c = r.querySelectorAll("td");
        const rowData = {};
        
        // Iterando apenas pelos cabe√ßalhos que vamos usar (excluindo a 'A√ß√£o')
        for (let i = 0; i < headers.length; i++) {
            rowData[headers[i]] = c[i].textContent;
        }
        data.push(rowData);
    });
    
    const ws=XLSX.utils.json_to_sheet(data);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Hist√≥rico");
    const nome=`Historico_Filtrado_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb,nome);
}

/* ====== DASHBOARD ====== */
let grafico1, grafico2, grafico3;

// Fun√ß√£o que aplica filtros client-side (setor, turno, m√°quina e operador) ap√≥s a busca no Firestore
function filtrarDadosDashboardLocal(dados, filtro) {
    return dados.filter(d => {
        // Filtro de Setor
        const setorCorreto = (!filtro.setor || d.setor === filtro.setor);
        // Filtro de Turno
        const turnoCorreto = (!filtro.turno || d.turno === filtro.turno);
        // Filtro de M√°quina (LIKE)
        const maquinaCorreta = 
            (!filtro.maquina || (d.maquina && d.maquina.toLowerCase().includes(filtro.maquina.toLowerCase())));
        // Filtro de Operador (LIKE)
        const operadorCorreto = 
            (!filtro.operador || (d.operador && d.operador.toLowerCase().includes(filtro.operador.toLowerCase())));

        return setorCorreto && turnoCorreto && maquinaCorreta && operadorCorreto;
    });
}

// Fun√ß√£o para calcular e atualizar KPIs em uma √°rea espec√≠fica
function calcularKPIsEstatistica(dados, prefixo, operadorNome = "Nenhum") {
    let totalPrevisto = 0;
    let totalRealizado = 0;
    let totalQuebras = 0;

    dados.forEach(d => {
        totalPrevisto += parseFloat(d.prevista) || 0;
        totalRealizado += parseFloat(d.realizada) || 0;
        totalQuebras += parseFloat(d.quebras) || 0;
    });

    const totalProducao = totalRealizado + totalQuebras;
    
    // Porcentagem de Realizado/Previsto
    const percRealPrev = totalPrevisto > 0 
        ? ((totalRealizado / totalPrevisto) * 100).toFixed(2) + '%' 
        : (totalRealizado > 0 ? 'INF' : 'N/A');

    // Porcentagem de Quebras / Total Produzido
    const percQuebraTotal = totalProducao > 0 
        ? ((totalQuebras / totalProducao) * 100).toFixed(2) + '%' 
        : 'N/A';

    // Atualiza os elementos HTML usando o prefixo fornecido
    document.getElementById(`${prefixo}Previsto`).textContent = totalPrevisto.toLocaleString();
    document.getElementById(`${prefixo}Realizado`).textContent = totalRealizado.toLocaleString();
    document.getElementById(`${prefixo}Quebras`).textContent = totalQuebras.toLocaleString();
    document.getElementById(`${prefixo}PercRealPrev`).textContent = percRealPrev;
    document.getElementById(`${prefixo}PercQuebraTotal`).textContent = percQuebraTotal;
    
    // üí° Ajuste para o KPI do Operador
    if (prefixo === 'kpiOperador' && document.getElementById('operadorSelecionado')) {
        const areaOperador = document.getElementById('analiseOperadorArea');
        const operadorInput = document.getElementById('dashFiltroOperador').value.trim();

        if (operadorInput && dados.length > 0) {
             // üí° Garante que o nome exibido seja o nome no filtro, capitalizado
            document.getElementById('operadorSelecionado').textContent = operadorInput.toUpperCase(); 
            areaOperador.classList.remove('hidden');
        } else {
            document.getElementById('operadorSelecionado').textContent = "Nenhum";
            // üí° Oculta a √°rea se o filtro de operador estiver vazio ou sem dados
            areaOperador.classList.add('hidden'); 
        }
    }

    return dados; 
}


/**
 * Busca dados no Firestore, aplica filtros e atualiza o Dashboard. 
 */
async function atualizarDashboard(){
    if (!producoesCol || !window.getDocs || !window.query) {
        console.error("Firebase n√£o conectado para o Dashboard.");
        return;
    }

    // 1. Coleta os filtros
    const filtro = {
        dataInicio: document.getElementById("dashFiltroDataInicio").value,
        dataFim: document.getElementById("dashFiltroDataFim").value,
        setor: document.getElementById("dashFiltroSetor").value,
        turno: document.getElementById("dashFiltroTurno").value,
        maquina: document.getElementById("dashFiltroMaquina").value,
        operador: document.getElementById("dashFiltroOperador").value.trim() // Retira espa√ßos
    };
    
    // 2. Define a query do Firestore (Apenas Filtros de Data)
    const conditions = [];

    if(filtro.dataInicio) conditions.push(window.where("data", ">=", filtro.dataInicio));
    if(filtro.dataFim) conditions.push(window.where("data", "<=", filtro.dataFim));
    
    const baseOrdering = [window.orderBy("data", "desc")];
    let q = window.query(producoesCol, ...conditions, ...baseOrdering);
    
    try {
        const querySnapshot = await window.getDocs(q);
        const dadosGerais = [];
        querySnapshot.forEach(doc => {
            dadosGerais.push(doc.data());
        });
        
        // 3. Filtros Cliente-Side
        const dadosFiltradosGeral = filtrarDadosDashboardLocal(dadosGerais, filtro);
        
        // 4. AN√ÅLISE GERAL 
        calcularKPIsEstatistica(dadosFiltradosGeral, 'kpi');
        
        // 5. AN√ÅLISE DO OPERADOR (Filtra apenas por data e operador para performance geral dele)
        let dadosOperador = [];
        if (filtro.operador) {
            const filtroOperadorApenasData = { 
                dataInicio: filtro.dataInicio, 
                dataFim: filtro.dataFim, 
                operador: filtro.operador,
                setor: '', turno: '', maquina: '' // Ignora outros filtros
            };
            
            // Reutiliza o filtro local, mas apenas com os filtros de data e operador
            dadosOperador = filtrarDadosDashboardLocal(dadosGerais, filtroOperadorApenasData); 
        }
        
        calcularKPIsEstatistica(dadosOperador, 'kpiOperador');
        
        // 6. Gerar Gr√°ficos (usando dados filtrados gerais)
        if(dadosFiltradosGeral.length===0) {
            if(grafico1) grafico1.destroy(); grafico1 = null;
            if(grafico2) grafico2.destroy(); grafico2 = null;
            if(grafico3) grafico3.destroy(); grafico3 = null;
            return;
        }

        gerarGraficoProducao(dadosFiltradosGeral);
        gerarGraficoQuebras(dadosFiltradosGeral);
        gerarGraficoTurnos(dadosFiltradosGeral);

    } catch (error) {
        console.error("Erro ao carregar dados para o Dashboard: ", error);
    }
}

// =================================================================
// FUN√á√ïES DE GR√ÅFICO (ajustes nas cores)
// =================================================================

function gerarGraficoProducao(dados) {
    const dadosPorSetor = dados.reduce((acc, d) => {
        if (!acc[d.setor]) acc[d.setor] = { previsto: 0, realizado: 0 };
        acc[d.setor].previsto += parseFloat(d.prevista) || 0;
        acc[d.setor].realizado += parseFloat(d.realizada) || 0;
        return acc;
    }, {});

    const labels = Object.keys(dadosPorSetor);
    const previsto = labels.map(s => dadosPorSetor[s].previsto);
    const realizado = labels.map(s => dadosPorSetor[s].realizado);

    const ctx = document.getElementById('graficoProducao').getContext('2d');
    if (grafico1) grafico1.destroy();

    grafico1 = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Previsto',
                    data: previsto,
                    backgroundColor: 'rgba(0, 119, 204, 0.7)',
                    borderColor: 'rgba(0, 119, 204, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Realizado',
                    data: realizado,
                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'Produ√ß√£o Prevista vs. Realizada por Setor' }
            },
            scales: { y: { beginAtZero: true } }
        }
    });
}

function gerarGraficoQuebras(dados) {
    const dadosPorSetor = dados.reduce((acc, d) => {
        if (!acc[d.setor]) acc[d.setor] = { quebras: 0, total: 0 };
        acc[d.setor].quebras += parseFloat(d.quebras) || 0;
        acc[d.setor].total += (parseFloat(d.realizada) || 0) + (parseFloat(d.quebras) || 0);
        return acc;
    }, {});

    const labels = Object.keys(dadosPorSetor);
    const quebrasPerc = labels.map(s => {
        const total = dadosPorSetor[s].total;
        const quebras = dadosPorSetor[s].quebras;
        return total > 0 ? ((quebras / total) * 100).toFixed(2) : 0;
    });

    const ctx = document.getElementById('graficoQuebras').getContext('2d');
    if (grafico2) grafico2.destroy();

    grafico2 = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '% Quebras sobre o Total de Pe√ßas',
                    data: quebrasPerc,
                    backgroundColor: 'rgba(255, 99, 132, 0.7)', // Cor mais suave
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'Percentual de Quebras por Setor' }
            },
            scales: { 
                y: { 
                    beginAtZero: true,
                    max: 100,
                    ticks: { callback: function(value) { return value + "%" } }
                } 
            }
        }
    });
}

function gerarGraficoTurnos(dados) {
    const dadosPorTurno = dados.reduce((acc, d) => {
        const turno = d.turno;
        if (!acc[turno]) acc[turno] = 0;
        acc[turno] += parseFloat(d.realizada) || 0;
        return acc;
    }, {});
    
    // Filtra turnos com produ√ß√£o zero para o gr√°fico de pizza
    const labels = Object.keys(dadosPorTurno).filter(t => dadosPorTurno[t] > 0);
    const realizado = labels.map(t => dadosPorTurno[t]);

    const ctx = document.getElementById('graficoTurnos').getContext('2d');
    if (grafico3) grafico3.destroy();

    // üí° Cores mais vibrantes e distintas para o gr√°fico de pizza
    const cores = labels.map((_, i) => `hsl(${i * 45}, 70%, 55%)`); 

    grafico3 = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Produ√ß√£o Realizada',
                    data: realizado,
                    backgroundColor: cores,
                    hoverOffset: 8
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'Distribui√ß√£o da Produ√ß√£o Realizada por Turno' },
                legend: { position: 'right' }
            }
        }
    });
}

// üí° Torna as fun√ß√µes de a√ß√£o globais para o HTML
window.deletarRegistro = deletarRegistro;
window.filtrarHistorico = filtrarHistorico;
window.buscarTodos = buscarTodos;
window.exportarExcel = exportarExcel;
window.atualizarDashboard = atualizarDashboard;
window.limparFormulario = limparFormulario;
window.mostrarPagina = mostrarPagina;
</script>
</body>
</html>
