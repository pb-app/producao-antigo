<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Acompanhamento de Produ√ß√£o</title>

    <link rel="manifest" href="manifest.json?v=2.0.1" />
    
    <meta name="theme-color" content="#0077cc">
    
    <link rel="apple-touch-icon" href="icons/icon-180x180.png?v=1.0.1" />

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        /* Define vari√°veis de cores para facilitar a manuten√ß√£o do tema */
        :root{--primary:#0077cc;--muted:#e6f0ff;--card:#ffffff;--accent:#ff9900;--danger:#dc3545}
        
        /* Reset b√°sico e configura√ß√£o de fonte para todo o corpo da p√°gina */
        *{box-sizing:border-box}
        body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--muted);color:#222}
        
        /* Estilos do cabe√ßalho */
        header{background:var(--primary);color:#fff;padding:14px 12px;text-align:center}
        
        /* Estilo do container principal que centraliza o conte√∫do */
        .container{max-width:980px;margin:18px auto;padding:16px;background:var(--card);border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
        
        /* Estilos dos t√≠tulos */
        h1,h2{margin:0 0 12px}
        
        /* Estilos da barra de navega√ß√£o */
        .nav{display:flex;flex-wrap: wrap; gap:8px;justify-content:center;margin-bottom:14px}
        .nav a{color:var(--primary);text-decoration:none;font-weight:700;padding:6px 10px;border-radius:6px;transition:background 0.2s}
        .nav a:hover{background:rgba(0,0,0,0.08)}
        .nav a.active{background:rgba(0,0,0,0.08)} /* Estilo para o link da p√°gina ativa */
        
        /* Estilos gerais para formul√°rios */
        form{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
        label{font-size:13px;font-weight:700;margin-bottom:4px;display:block}
        input[type="date"], input[type="text"], input[type="number"], select, textarea{width:100%;padding:8px;border:1px solid #cfd8e3;border-radius:6px}
        textarea{min-height:70px;resize:vertical}
        .full{grid-column:1/-1} /* Classe para um campo de formul√°rio ocupar a largura total */
        
        /* Estilos para bot√µes */
        button{background:var(--primary);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700;transition:background 0.2s}
        button:hover{filter:brightness(1.1)}
        button.secondary{background:#eee;color:#111}
        button.secondary:hover{background:#ddd;filter:none}
        button.edit-btn{background:var(--accent); margin-right: 5px;}
        button.delete-btn{background:var(--danger);}
        
        /* Estilos para a √°rea de filtros */
        .filtros{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom: 12px;padding: 8px;border: 1px solid #ddd;border-radius: 8px;}
        .filtros input, .filtros select{padding:8px;border-radius:6px;border:1px solid #ccc;}
        
        /* Estilos para tabelas */
        table{width:100%;border-collapse:collapse;margin-top:12px}
        th,td{border:1px solid #e0e6ef;padding:8px;text-align:center;font-size:13px}
        th{background:var(--primary);color:#fff}
        
        /* Estilos para responsividade em telas maiores */
        @media(min-width:880px){form{grid-template-columns:repeat(3,1fr)}}
        
        /* Estilos para os cart√µes de KPI (Indicadores Chave de Performance) no Dashboard */
        .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin:20px 0 0;}
        .kpi-card{background:var(--muted);padding:12px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
        .kpi-card h3{font-size:14px;color:#555;margin:0 0 4px}
        .kpi-card p{font-size:28px;font-weight:bold;margin:0;color:var(--primary)}
        .kpi-card.percent p{color:#00a000}
        
        /* Estilos para a √°rea de an√°lise de operador no Dashboard */
        #analiseOperadorArea{border: 2px solid var(--accent);padding: 15px;border-radius: 10px;margin-top: 15px;opacity: 1; transition: opacity 0.3s ease-in-out;}
        #analiseOperadorArea.hidden {opacity: 0;height: 0;padding-top: 0;padding-bottom: 0;margin-top: 0;border-color: transparent;overflow: hidden;}
        #analiseOperadorArea h3 {color: var(--accent);text-align: center;margin-bottom: 10px;}
        #analiseOperadorArea .kpi-card p {color: var(--accent); font-size: 26px;}
        
        /* Estilos para a linha de detalhes expans√≠vel na tabela de hist√≥rico */
        .linha-detalhes { display: none; background-color: #f9f9f9; }
        .linha-detalhes td { padding: 10px 15px; text-align: left !important; border: 0; }
        .linha-detalhes .detalhe-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; }
        .detalhe-grid span { font-weight: bold; color: var(--primary); }
        .expand-btn { cursor: pointer; font-weight: bold; font-size: 16px; padding: 2px 8px; border-radius: 50%; background-color: #ddd; border: none; }
        .expand-btn:hover { background-color: #ccc; }
        
        /* Estilos para a pagina√ß√£o da tabela de hist√≥rico */
        .paginacao { display: flex; justify-content: center; align-items: center; margin-top: 15px; gap: 10px; }
        .paginacao button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* ESTILOS PARA O MODAL (POP-UP) DE EDI√á√ÉO */
        .modal-overlay {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000;}
        .modal-content {background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 800px;}
        .modal-content h2 { margin-top: 0; }
        .modal-content form { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        @media (max-width: 600px) {.modal-content form { grid-template-columns: 1fr; }}
    </style>
</head>
<body>
    <header><h1>Acompanhamento de Produ√ß√£o</h1></header>

    <div class="container">
        <div class="nav">
            <a href="#" id="linkLanc" class="active" onclick="mostrarPagina('lancamento')">Lan√ßamento</a>
            <a href="#" id="linkOper" onclick="mostrarPagina('operadores')">Operadores</a>
            <a href="#" id="linkHist" onclick="mostrarPagina('historico')">Hist√≥rico</a>
            <a href="#" id="linkDash" onclick="mostrarPagina('dashboard')">Dashboard</a>
            <a href="Massa.html" style="color: #0077cc;">F√°brica de Massa</a>
        </div>

        <section id="lancamento">
            <h2>Lan√ßamento de Produ√ß√£o</h2>
            <form id="formProducao">
                <div><label>Data</label><input type="date" id="data" required /></div>
                <div><label>Setor</label><select id="setor" required><option value="">Selecione</option><option>Conforma√ß√£o</option><option>Esmalta√ß√£o</option><option>Embalagem</option><option>Forno Vidrado</option><option>Forno chacote</option></select></div>
                <div><label>Turno</label><select id="turno" required><option value="">Selecione</option><option>Comercial</option><option>Turno 1 (6x2)</option><option>Turno 2 (6x2)</option><option>Turno 3 (6x2)</option><option>Turno 4 (6x2)</option><option>Turno 1 (5x2)</option><option>Turno 2 (5x2)</option></select></div>
                <div><label>Operador</label><select id="operadorSelect" required><option value="">Selecione o setor</option></select></div>
                <div><label>M√°quina</label><select id="maquinaSelect" required><option value="">Selecione o setor primeiro</option></select></div>
                <div><label>Massa</label><select id="massa" required><option value="">Selecione</option><option>Stone</option><option>Faian√ßa</option></select></div>
                <div><label>Refer√™ncia/CPB</label><input type="text" id="refCpb" /></div>
                <div><label>Produ√ß√£o Prevista</label><input type="number" id="prevista" min="0" required /></div>
                <div><label>Produ√ß√£o Realizada</label><input type="number" id="realizada" min="0" required /></div>
                <div><label>Quebras</label><input type="number" id="quebras" min="0" required /></div>
                <div class="full"><label>Observa√ß√£o</label><textarea id="observacao"></textarea></div>
                <div class="full" style="text-align:right;"><button type="button" class="secondary" onclick="limparFormulario()">Limpar</button><button type="submit">Lan√ßar</button></div>
            </form>
        </section>
        
        <section id="operadores" style="display:none;">
            <h2>Cadastro de Operadores</h2>
            <form id="formOperador">
                <div><label>Data do Cadastro</label><input type="date" id="dataCadastroOp" required /></div>
                <div><label>Nome do Operador</label><input type="text" id="nomeOperador" required placeholder="Nome completo" /></div>
                <div><label>Setor</label><select id="setorOperador" required><option value="">Selecione</option><option>Conforma√ß√£o</option><option>Esmalta√ß√£o</option><option>Embalagem</option><option>Forno Vidrado</option><option>Forno chacote</option></select></div>
                <div><label>Turno</label><select id="turnoOperador" required><option value="">Selecione</option><option>Comercial</option><option>Turno 1 (6x2)</option><option>Turno 2 (6x2)</option><option>Turno 3 (6x2)</option><option>Turno 4 (6x2)</option><option>Turno 1 (5x2)</option><option>Turno 2 (5x2)</option></select></div>
                <div class="full" style="text-align:right;"><button type="submit">Cadastrar Operador</button></div>
            </form>
            
            <h2 style="margin-top: 20px;">Operadores Cadastrados</h2>
             <table id="tabelaOperadores">
                <thead><tr><th>Data Cadastro</th><th>Nome</th><th>Setor</th><th>Turno</th><th>A√ß√£o</th></tr></thead>
                <tbody></tbody>
            </table>
        </section>

        <section id="historico" style="display:none">
            <h2>Hist√≥rico</h2>
            <div class="filtros">
                <input type="date" id="filtroDataInicio" placeholder="Data In√≠cio" />
                <input type="date" id="filtroDataFim" placeholder="Data Fim" />
                <select id="filtroSetor"><option value="">Todos os Setores</option><option>Conforma√ß√£o</option><option>Esmalta√ß√£o</option><option>Embalagem</option><option>Forno Vidrado</option><option>Forno chacote</option></select>
                <select id="filtroTurno"><option value="">Todos os Turnos</option><option>Comercial</option><option>Turno 1 (6x2)</option><option>Turno 2 (6x2)</option><option>Turno 3 (6x2)</option><option>Turno 4 (6x2)</option><option>Turno 1 (5x2)</option><option>Turno 2 (5x2)</option></select>
                <input type="text" id="filtroMaquina" placeholder="M√°quina..." list="listaMaquinasFiltro" />
                <datalist id="listaMaquinasFiltro"></datalist>
                <input type="text" id="filtroRefCpb" placeholder="Ref/CPB..." />
                <button onclick="filtrarHistorico()">Filtrar</button>
                <button class="secondary" onclick="buscarTodos()">Mostrar todos</button>
                <button style="background:green;" onclick="exportarExcel()">Exportar Excel</button>
            </div>

            <table id="tabelaHistorico">
                <thead><tr><th></th><th>Data</th><th>Setor</th><th>M√°quina</th><th>% Efic.</th><th>% Perda</th></tr></thead>
                <tbody></tbody>
            </table>

            <div class="paginacao">
                <button id="btnAnterior" onclick="paginaAnterior()">Anterior</button>
                <span id="infoPagina">P√°gina 1</span>
                <button id="btnProxima" onclick="proximaPagina()">Pr√≥xima</button>
            </div>
        </section>

        <section id="dashboard" style="display:none">
            <h2>Dashboard</h2>
             <div class="filtros">
                <input type="date" id="dashFiltroDataInicio" placeholder="Data In√≠cio" />
                <input type="date" id="dashFiltroDataFim" placeholder="Data Fim" />
                <select id="dashFiltroSetor"><option value="">Todos os Setores</option><option>Conforma√ß√£o</option><option>Esmalta√ß√£o</option><option>Embalagem</option><option>Forno Vidrado</option><option>Forno chacote</option></select>
                <select id="dashFiltroTurno"><option value="">Todos os Turnos</option><option>Comercial</option><option>Turno 1 (6x2)</option><option>Turno 2 (6x2)</option><option>Turno 3 (6x2)</option><option>Turno 4 (6x2)</option><option>Turno 1 (5x2)</option><option>Turno 2 (5x2)</option></select>
                <input type="text" id="dashFiltroMaquina" placeholder="M√°quina..." list="listaMaquinasDash" />
                <datalist id="listaMaquinasDash"></datalist>
                <input type="text" id="dashFiltroRefCpb" placeholder="Ref/CPB..."/>
                <input type="text" id="dashFiltroOperador" placeholder="Operador..." />
                <button onclick="atualizarDashboard()">Aplicar Filtro</button>
            </div>
            <h3>Resumo Geral da Produ√ß√£o (Filtros Aplicados)</h3>
            <div class="kpis" id="kpisResumo">
                <div class="kpi-card"><h3>Total Previsto</h3><p id="kpiPrevisto">0</p></div>
                <div class="kpi-card"><h3>Total Realizado</h3><p id="kpiRealizado">0</p></div>
                <div class="kpi-card"><h3>Total Quebras</h3><p id="kpiQuebras">0</p></div>
                <div class="kpi-card percent"><h3>% Realizado/Previsto</h3><p id="kpiPercRealPrev">N/A</p></div>
                <div class="kpi-card percent"><h3>% Quebras/Total</h3><p id="kpiPercQuebraTotal">N/A</p></div>
            </div>
            <div id="analiseOperadorArea">
                <h3>An√°lise do Operador: <span id="operadorSelecionado">Nenhum</span></h3>
                <div class="kpis" id="kpisOperador">
                    <div class="kpi-card"><h3>Previsto Operador</h3><p id="kpiOperadorPrevisto">0</p></div>
                    <div class="kpi-card"><h3>Realizado Operador</h3><p id="kpiOperadorRealizado">0</p></div>
                    <div class="kpi-card"><h3>Quebras Operador</h3><p id="kpiOperadorQuebras">0</p></div>
                    <div class="kpi-card percent"><h3>% Realizado/Previsto</h3><p id="kpiOperadorPercRealPrev">N/A</p></div>
                    <div class="kpi-card percent"><h3>% Quebras/Total</h3><p id="kpiOperadorPercQuebraTotal">N/A</p></div>
                </div>
            </div>
        </section>
    </div>

    <div id="modalEdicaoProducao" class="modal-overlay">
        <div class="modal-content">
            <h2>Editar Lan√ßamento</h2>
            <form id="formEdicaoProducao">
                <input type="hidden" id="editDocId"> <div> <label>Data</label> <input type="date" id="editData" required /> </div>
                <div> <label>Setor</label> <select id="editSetor" required> <option>Conforma√ß√£o</option> <option>Esmalta√ß√£o</option> <option>Embalagem</option> <option>Forno Vidrado</option> <option>Forno chacote</option> </select> </div>
                <div> <label>Turno</label> <select id="editTurno" required> <option>Comercial</option> <option>Turno 1 (6x2)</option> <option>Turno 2 (6x2)</option> <option>Turno 3 (6x2)</option> <option>Turno 4 (6x2)</option> <option>Turno 1 (5x2)</option> <option>Turno 2 (5x2)</option> </select> </div>
                <div> <label>Operador</label> <input type="text" id="editOperador" required /> </div>
                <div> <label>M√°quina</label> <input type="text" id="editMaquina" required /> </div>
                <div> <label>Massa</label> <select id="editMassa" required> <option>Stone</option> <option>Faian√ßa</option> </select> </div>
                <div> <label>Refer√™ncia/CPB</label> <input type="text" id="editRefCpb" /> </div>
                <div> <label>Prod. Prevista</label> <input type="number" id="editPrevista" required /> </div>
                <div> <label>Prod. Realizada</label> <input type="number" id="editRealizada" required /> </div>
                <div> <label>Quebras</label> <input type="number" id="editQuebras" required /> </div>
                <div class="full"> <label>Observa√ß√£o</label> <textarea id="editObservacao"></textarea> </div>
                <div class="full" style="text-align: right; margin-top: 10px;">
                    <button type="button" class="secondary" onclick="fecharModal('modalEdicaoProducao')">Cancelar</button>
                    <button type="submit">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="modalEdicaoOperador" class="modal-overlay">
        <div class="modal-content">
            <h2>Editar Operador</h2>
            <form id="formEdicaoOperador" style="grid-template-columns: 1fr;">
                <input type="hidden" id="editOpDocId"> <div><label>Data Cadastro</label><input type="date" id="editOpData" required></div>
                <div><label>Nome</label><input type="text" id="editOpNome" required></div>
                <div><label>Setor</label><select id="editOpSetor" required> <option>Conforma√ß√£o</option> <option>Esmalta√ß√£o</option> <option>Embalagem</option> <option>Forno Vidrado</option> <option>Forno chacote</option> </select></div>
                <div><label>Turno</label><select id="editOpTurno" required> <option>Comercial</option> <option>Turno 1 (6x2)</option> <option>Turno 2 (6x2)</option> <option>Turno 3 (6x2)</option> <option>Turno 4 (6x2)</option> <option>Turno 1 (5x2)</option> <option>Turno 2 (5x2)</option> </select></div>
                <div class="full" style="text-align: right; margin-top: 10px;">
                    <button type="button" class="secondary" onclick="fecharModal('modalEdicaoOperador')">Cancelar</button>
                    <button type="submit">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Importa as fun√ß√µes necess√°rias do SDK do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, getDocs, 
            query, where, orderBy, deleteDoc, doc, limit, startAfter,
            getDoc, updateDoc // Fun√ß√µes para obter e atualizar documentos
        } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // Configura√ß√µes do seu projeto Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB2z4mFj5qVtb59uocKK8JXhMTfi8MGSTo",
            authDomain: "acompanhamento-de-produc-b68b0.firebaseapp.com",
            projectId: "acompanhamento-de-produc-b68b0",
            storageBucket: "acompanhamento-de-produc-b68b0.firebasestorage.app",
            messagingSenderId: "891709449679",
            appId: "1:891709449679:web:43e83e076f5fb3201e1eba"
        };

        // Inicializa o Firebase e o Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Exp√µe as fun√ß√µes e refer√™ncias do Firebase ao escopo global (window)
        // para que possam ser acessadas no script principal (que n√£o √© um m√≥dulo)
        window.db = db;
        window.producoesCol = collection(db, "producoes"); 
        window.operadoresCol = collection(db, "operadores");
        window.addDoc = addDoc;        
        window.getDocs = getDocs;        
        window.query = query;         
        window.where = where;         
        window.orderBy = orderBy;      
        window.deleteDoc = deleteDoc; 
        window.doc = doc;
        window.limit = limit;
        window.startAfter = startAfter;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;
        
        console.log("Firebase e Firestore inicializados!");
    </script>

<script>
// ================================================================
// IN√çCIO DO SCRIPT PRINCIPAL DA APLICA√á√ÉO
// ================================================================

// ---- Vari√°veis Globais ----
// Essas vari√°veis armazenam o estado da aplica√ß√£o, como a p√°gina atual, filtros, etc.
let db, producoesCol, operadoresCol; // Vari√°veis para o Firebase
const ITENS_POR_PAGINA = 30; // Define quantos itens aparecem por p√°gina no hist√≥rico
let ultimoDocumentoVisivel = null; // Guarda refer√™ncia ao √∫ltimo item da p√°gina atual, para pagina√ß√£o
let primeiroDocumentoStack = [null]; // Pilha para controlar a pagina√ß√£o para a p√°gina anterior
let paginaAtual = 1; // Controla o n√∫mero da p√°gina atual
let filtroAtual = null; // Armazena os filtros aplicados no hist√≥rico

/**
 * Retorna a data local atual no formato AAAA-MM-DD.
 * Isso evita problemas de fuso hor√°rio que podem ocorrer com new Date().toISOString().
 * @returns {string} A data formatada.
 */
function obterDataLocalFormatada() {
    const data = new Date();
    const ano = data.getFullYear();
    const mes = String(data.getMonth() + 1).padStart(2, '0'); // M√™s come√ßa em 0, ent√£o somamos 1
    const dia = String(data.getDate()).padStart(2, '0');
    return `${ano}-${mes}-${dia}`;
}

// ---- Inicializa√ß√£o da P√°gina ----
// Este evento √© disparado quando o HTML da p√°gina foi completamente carregado.
document.addEventListener("DOMContentLoaded", ()=>{
    // Atribui as vari√°veis globais do Firebase que foram inicializadas no script de m√≥dulo
    db = window.db; 
    producoesCol = window.producoesCol; 
    operadoresCol = window.operadoresCol;
    
    // Pega a data de hoje usando a fun√ß√£o corrigida
    const today = obterDataLocalFormatada();

    // Define a data de hoje como valor padr√£o para os campos de data
    document.getElementById("data").value = today;
    document.getElementById("dataCadastroOp").value = today;
    document.getElementById("filtroDataInicio").value = today;
    document.getElementById("filtroDataFim").value = today;
    document.getElementById("dashFiltroDataInicio").value = today;
    document.getElementById("dashFiltroDataFim").value = today;

    // Adiciona "ouvintes" de eventos aos elementos da p√°gina
    document.getElementById("setor").addEventListener("change", carregarOperadores);
    document.getElementById("formOperador").addEventListener("submit", cadastrarOperador);
    document.getElementById('filtroSetor').addEventListener('change', () => atualizarDatalistMaquina('filtroSetor', 'listaMaquinasFiltro'));
    document.getElementById('dashFiltroSetor').addEventListener('change', () => atualizarDatalistMaquina('dashFiltroSetor', 'listaMaquinasDash'));
    document.getElementById('formEdicaoProducao').addEventListener('submit', salvarEdicaoProducao);
    document.getElementById('formEdicaoOperador').addEventListener('submit', salvarEdicaoOperador);
});

// ---- L√≥gica de M√°quinas e Setores ----
// Objeto que mapeia quais m√°quinas pertencem a cada setor
const maquinasPorSetor = {
    "Conforma√ß√£o":["Secador 2","Secador 3","Secador 4","Secador 10","M√°quina de X√≠cara 1","M√°quina de X√≠cara 2","M√°quina de Prato","Prensa"],
    "Esmalta√ß√£o":["Disco 1","Disco 2","Disco 3","Disco 4","Rob√¥ 1","Rob√¥ 2","Spray","Imers√£o"],
    "Embalagem":["Linha 1","Linha 2","Linha 3","Linha 4","Linha 5"],
    "Forno Vidrado":["Forno 1","Forno 2"],
    "Forno chacote":["Forno 3"]
};

// Atualiza o <select> de m√°quinas quando um setor √© escolhido no formul√°rio de lan√ßamento
document.getElementById("setor").addEventListener("change", e=>{
    const setor = e.target.value;
    const maqSelect = document.getElementById("maquinaSelect");
    maqSelect.innerHTML='<option value="">(Selecione ou Digite)</option>'; // Limpa op√ß√µes antigas
    if(maquinasPorSetor[setor]){
        maquinasPorSetor[setor].forEach(m=>{
            const opt=document.createElement("option");
            opt.textContent=m; opt.value=m;
            maqSelect.appendChild(opt);
        });
    }
});

/**
 * Atualiza um <datalist> de m√°quinas com base no setor selecionado em um filtro.
 * @param {string} idSetor - O ID do elemento <select> do setor.
 * @param {string} idDatalist - O ID do elemento <datalist> a ser atualizado.
 */
function atualizarDatalistMaquina(idSetor, idDatalist) {
    const setor = document.getElementById(idSetor).value;
    const datalist = document.getElementById(idDatalist);
    datalist.innerHTML = ''; // Limpa o datalist

    if (maquinasPorSetor[setor]) {
        maquinasPorSetor[setor].forEach(m => {
            const option = document.createElement('option');
            option.value = m;
            datalist.appendChild(option);
        });
    }
}

// ---- Navega√ß√£o e UI (Interface do Usu√°rio) ----
/**
 * Controla a navega√ß√£o entre as "p√°ginas" (se√ß√µes) da aplica√ß√£o.
 * @param {string} pg - O ID da se√ß√£o a ser exibida.
 */
function mostrarPagina(pg){
    // Esconde todas as se√ß√µes
    document.querySelectorAll("section").forEach(s=>s.style.display="none");
    // Mostra apenas a se√ß√£o desejada
    document.getElementById(pg).style.display="block";
    // Atualiza o estilo do link de navega√ß√£o para indicar a p√°gina ativa
    document.querySelectorAll(".nav a").forEach(a=>a.classList.remove("active"));
    const linkId = `#link${pg.charAt(0).toUpperCase()}${pg.slice(1,4)}`;
    document.querySelector(linkId).classList.add("active");
    
    // Se a p√°gina for "hist√≥rico", "dashboard" ou "operadores", atualiza os dados
    if(pg==="historico") filtrarHistorico(); 
    if(pg==="dashboard") atualizarDashboard();
    if(pg==="operadores") atualizarTabelaOperadores();
}

/**
 * Mostra ou esconde a linha de detalhes de um registro na tabela de hist√≥rico.
 * @param {number} index - O √≠ndice da linha que foi clicada.
 */
function toggleDetalhes(index) {
    const detalhesRow = document.getElementById(`detalhes-${index}`);
    const btn = event.target; // O bot√£o "+" ou "-" que foi clicado
    if (detalhesRow.style.display === "table-row") {
        detalhesRow.style.display = "none";
        btn.textContent = "+";
    } else {
        detalhesRow.style.display = "table-row";
        btn.textContent = "-";
    }
}

// ---- Fun√ß√µes do Modal (Pop-up) de Edi√ß√£o ----
/**
 * Fecha um modal (pop-up).
 * @param {string} modalId - O ID do modal a ser fechado.
 */
function fecharModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

/**
 * Abre o modal para editar um lan√ßamento de produ√ß√£o, buscando os dados do Firebase.
 * @param {string} docId - O ID do documento no Firebase.
 */
async function abrirModalEdicao(docId) {
    try {
        const docRef = window.doc(db, "producoes", docId);
        const docSnap = await window.getDoc(docRef);
        if (docSnap.exists()) {
            const data = docSnap.data();
            // Preenche os campos do formul√°rio do modal com os dados do documento
            document.getElementById('editDocId').value = docId;
            document.getElementById('editData').value = data.data;
            document.getElementById('editSetor').value = data.setor;
            // ... (preenche todos os outros campos)
            document.getElementById('modalEdicaoProducao').style.display = 'flex'; // Mostra o modal
        } else {
            alert("Erro: Documento n√£o encontrado.");
        }
    } catch (error) {
        console.error("Erro ao abrir modal de edi√ß√£o:", error);
        alert("N√£o foi poss√≠vel carregar os dados para edi√ß√£o.");
    }
}

/**
 * Salva as altera√ß√µes feitas no formul√°rio de edi√ß√£o de produ√ß√£o.
 * @param {Event} e - O evento de submit do formul√°rio.
 */
async function salvarEdicaoProducao(e) {
    e.preventDefault(); // Impede o recarregamento da p√°gina
    const docId = document.getElementById('editDocId').value;
    const docRef = window.doc(db, "producoes", docId);
    
    // Coleta os dados atualizados do formul√°rio
    const dadosAtualizados = {
        data: document.getElementById('editData').value,
        setor: document.getElementById('editSetor').value,
        // ... (coleta todos os outros campos)
    };

    try {
        await window.updateDoc(docRef, dadosAtualizados); // Atualiza o documento no Firebase
        alert("Lan√ßamento atualizado com sucesso!");
        fecharModal('modalEdicaoProducao');
        filtrarHistorico(); // Atualiza a tabela de hist√≥rico
    } catch (error) {
        console.error("Erro ao salvar altera√ß√µes:", error);
        alert("Erro ao salvar. Verifique o console.");
    }
}

/**
 * Abre o modal para editar um operador.
 * @param {string} docId - O ID do documento do operador no Firebase.
 */
async function abrirModalOperador(docId) {
    // L√≥gica similar √† `abrirModalEdicao`, mas para operadores
    // ...
}

/**
 * Salva as altera√ß√µes feitas no formul√°rio de edi√ß√£o de operador.
 * @param {Event} e - O evento de submit do formul√°rio.
 */
async function salvarEdicaoOperador(e) {
    // L√≥gica similar √† `salvarEdicaoProducao`, mas para operadores
    // ...
}

// ---- Fun√ß√µes de CRUD (Create, Read, Update, Delete) para Operadores ----
/**
 * Cadastra um novo operador no Firebase.
 * @param {Event} e - O evento de submit do formul√°rio.
 */
async function cadastrarOperador(e) {
    e.preventDefault();
    const dataCadastro = document.getElementById("dataCadastroOp").value;
    const nome = document.getElementById("nomeOperador").value.trim();
    // ... (pega outros valores)
    
    if (!dataCadastro || !nome /* ... */) {
        alert("Por favor, preencha todos os campos.");
        return;
    }

    const novoOperador = { dataCadastro, nome, /* ... */ };

    try {
        await window.addDoc(operadoresCol, novoOperador); // Adiciona ao Firebase
        alert(`Operador "${nome}" cadastrado com sucesso! ‚úÖ`);
        document.getElementById("formOperador").reset();
        atualizarTabelaOperadores();
    } catch (error) {
        console.error("Erro ao cadastrar operador: ", error);
        alert("Erro ao cadastrar. ‚ùå");
    }
}

/**
 * Busca todos os operadores no Firebase e atualiza a tabela na tela.
 */
async function atualizarTabelaOperadores() {
    const tbody = document.querySelector("#tabelaOperadores tbody");
    tbody.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";

    try {
        const q = window.query(operadoresCol, window.orderBy("nome"));
        const snapshot = await window.getDocs(q);
        
        tbody.innerHTML = ""; // Limpa a tabela
        if (snapshot.empty) {
            tbody.innerHTML = "<tr><td colspan='5'>Nenhum operador cadastrado.</td></tr>";
            return;
        }

        snapshot.forEach(doc => {
            const op = doc.data();
            const tr = document.createElement("tr");
            // Cria a linha da tabela com os dados e os bot√µes de a√ß√£o
            tr.innerHTML = `<td>...</td><td>...</td>`;
            tbody.appendChild(tr);
        });
    } catch (error) {
        console.error("Erro ao buscar operadores:", error);
    }
}

/**
 * Deleta um operador do Firebase ap√≥s pedir uma senha de confirma√ß√£o.
 * @param {string} docId - O ID do operador a ser deletado.
 */
async function deletarOperador(docId) {
    const senhaCorreta = "pb2025";
    const senhaDigitada = prompt("Para confirmar a exclus√£o, digite a senha:");

    if (senhaDigitada === senhaCorreta) {
        if (confirm("Tem certeza que deseja deletar este operador?")) {
            try {
                await window.deleteDoc(window.doc(db, "operadores", docId));
                alert("Operador deletado com sucesso!");
                atualizarTabelaOperadores();
            } catch (error) {
                // ... tratamento de erro
            }
        }
    } else {
        alert("Senha incorreta.");
    }
}

/**
 * Carrega a lista de operadores no <select> do formul√°rio de lan√ßamento,
 * filtrando pelo setor selecionado.
 */
async function carregarOperadores() {
    // ... l√≥gica para buscar operadores do setor e preencher o <select>
}

// ---- Fun√ß√µes do Lan√ßamento de Produ√ß√£o ----
// "Ouvinte" para o envio do formul√°rio de produ√ß√£o
document.getElementById("formProducao").addEventListener("submit", async (e)=>{
    e.preventDefault();
    // Coleta os dados do formul√°rio
    const data = {
        data: document.getElementById("data").value,
        // ... coleta todos os outros campos
        timestamp: new Date().toISOString() // Adiciona um timestamp para ordena√ß√£o
    };
    try {
        await window.addDoc(producoesCol, data); // Salva no Firebase
        alert("Lan√ßamento salvo com sucesso! ‚úÖ");
        limparFormulario();
    } catch (error) {
        console.error("Erro ao adicionar documento: ", error);
        alert("Erro ao salvar. ‚ùå");
    }
});

/**
 * Limpa o formul√°rio de lan√ßamento de produ√ß√£o.
 */
function limparFormulario(){
    document.getElementById("formProducao").reset();
    document.getElementById("operadorSelect").innerHTML = '<option value="">Selecione o setor</option>';
}

// ---- Fun√ß√µes do Hist√≥rico de Produ√ß√£o ----
/**
 * Deleta um registro de produ√ß√£o do Firebase.
 * @param {string} docId - O ID do registro a ser deletado.
 */
function deletarRegistro(docId) {
    // L√≥gica similar a `deletarOperador`, mas para a cole√ß√£o "producoes"
    // ...
}

/**
 * Fun√ß√£o principal que busca os dados no Firebase e atualiza a tabela de hist√≥rico.
 * @param {object} filtro - Objeto contendo os filtros a serem aplicados.
 * @param {string | null} direcao - 'proxima', 'anterior' ou null para controlar a pagina√ß√£o.
 */
async function atualizarTabela(filtro, direcao = null) {
    // ... l√≥gica complexa para construir a query do Firebase com filtros e pagina√ß√£o
    // ... busca os dados, renderiza as linhas da tabela e atualiza os bot√µes de pagina√ß√£o
}

// Fun√ß√µes de controle da pagina√ß√£o
function proximaPagina() {
    paginaAtual++;
    atualizarTabela(filtroAtual, 'proxima');
}
function paginaAnterior() {
    if (paginaAtual > 1) {
        paginaAtual--;
        atualizarTabela(filtroAtual, 'anterior');
    }
}

/**
 * Coleta os valores dos campos de filtro e inicia uma nova busca na tabela.
 */
function filtrarHistorico(){
    // Monta o objeto `filtroAtual` com os valores dos inputs
    // Reseta a pagina√ß√£o e chama `atualizarTabela`
}

/**
 * Limpa todos os filtros e busca todos os registros.
 */
function buscarTodos(){
    // Limpa os campos de filtro e chama `atualizarTabela` sem filtro
}

/**
 * Exporta os dados filtrados do hist√≥rico para um arquivo Excel (.xlsx).
 */
async function exportarExcel() {
    // ... busca todos os dados que correspondem ao filtro atual (sem pagina√ß√£o)
    // ... formata os dados para o formato que a biblioteca `xlsx` espera
    // ... gera e baixa o arquivo Excel
}

// ---- Fun√ß√µes do Dashboard ----
/**
 * Filtra localmente um array de dados com base nos filtros do dashboard.
 * @param {Array} dados - O array de dados vindo do Firebase.
 * @param {object} filtro - O objeto de filtros.
 * @returns {Array} O array de dados filtrados.
 */
function filtrarDadosDashboardLocal(dados, filtro) {
    // ... l√≥gica de `filter` para aplicar os filtros ao array
}

/**
 * Calcula os KPIs (previsto, realizado, quebras, %) e atualiza os elementos na tela.
 * @param {Array} dados - O array de dados para calcular as estat√≠sticas.
 * @param {string} prefixo - O prefixo do ID dos elementos a serem atualizados ('kpi' ou 'kpiOperador').
 */
function calcularKPIsEstatistica(dados, prefixo) {
    // ... itera sobre os dados, soma os totais
    // ... calcula as porcentagens
    // ... atualiza o `textContent` dos elementos HTML do dashboard
}

/**
 * Fun√ß√£o principal do dashboard. Busca os dados do Firebase e atualiza os KPIs.
 */
async function atualizarDashboard(){
    // ... busca os dados do Firebase com base no filtro de data
    // ... chama `filtrarDadosDashboardLocal` para aplicar os outros filtros
    // ... chama `calcularKPIsEstatistica` para atualizar os cart√µes de KPI
}

// ---- Exposi√ß√£o de Fun√ß√µes Globais ----
// Torna as fun√ß√µes acess√≠veis para os atributos `onclick` no HTML
window.deletarRegistro = deletarRegistro;
window.deletarOperador = deletarOperador;
// ... (e todas as outras fun√ß√µes chamadas pelo HTML)
window.abrirModalEdicao = abrirModalEdicao;
window.abrirModalOperador = abrirModalOperador;
window.fecharModal = fecharModal;
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js?v=2.0.2")
    .then(() => console.log("Service Worker registrado com sucesso."))
    .catch(err => console.log("Erro ao registrar o Service Worker:", err));
}
</script>

<script>
let deferredPrompt;
const installBtn = document.createElement("button");
installBtn.textContent = "üì• Instalar Aplicativo";
// ... (estilos do bot√£o)
document.body.appendChild(installBtn);

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = "block"; // Mostra o bot√£o

  installBtn.addEventListener("click", () => {
    installBtn.style.display = "none";
    deferredPrompt.prompt(); // Mostra o prompt de instala√ß√£o nativo do navegador
    // ... (l√≥gica para tratar a escolha do usu√°rio)
  });
});
</script>

</body>
</html>
