<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Lan√ßamento - F√°brica de Massa</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <style>
/* ================================================================ */
/* =========== LAYOUT MODERNO PARA A F√ÅBRICA DE MASSA =========== */
/* ================================================================ */

        /* ================================================================ */
/* =========== ESTILO PLANILHA PARA TABELAS DA P√ÅGINA =========== */
/* ================================================================ */

/* Remove a borda inferior do estilo moderno para estas tabelas */
#tabProducao table th, #tabProducao table td,
#tabPesagem table th, #tabPesagem table td,
#tabMoagem table th, #tabMoagem table td, /* Adicionado Moagem */
#tabOperadores table th, #tabOperadores table td /* Adicionado Operadores */
{
    border-bottom: none;
}

/* Aplica o estilo de borda e centraliza√ß√£o nas tabelas de hist√≥rico e pesagem */
#tabProducao table th, #tabProducao table td,
#tabPesagem table th, #tabPesagem table td,
#tabMoagem table th, #tabMoagem table td, /* Adicionado Moagem */
#tabOperadores table th, #tabOperadores table td /* Adicionado Operadores */
{
    border: 1px solid var(--border-color);
    text-align: center;
    white-space: normal; /* Permite que o texto quebre a linha */
    padding: 0.5rem;
}

/* Estiliza o cabe√ßalho para ter fundo azul e texto branco */
#tabProducao table th,
#tabPesagem table th,
#tabMoagem table th, /* Adicionado Moagem */
#tabOperadores table th /* Adicionado Operadores */
{
    background-color: var(--primary);
    color: white;
    font-weight: bold;
}

/* Adiciona o efeito de "zebra" (linhas alternadas) no corpo da tabela */
#tabProducao tbody tr:nth-child(2n),
#tabPesagem tbody tr:nth-child(2n),
#tabMoagem tbody tr:nth-child(2n), /* Adicionado Moagem */
#tabOperadores tbody tr:nth-child(2n) /* Adicionado Operadores */
{
    background-color: var(--bg-color);
}

/* Mant√©m o efeito hover, exceto na linha de detalhes */
#tabProducao tbody tr:not(.linha-detalhes):hover,
#tabPesagem tbody tr:hover,
#tabMoagem tbody tr:not(.linha-detalhes):hover, /* Adicionado Moagem */
#tabOperadores tbody tr:hover /* Adicionado Operadores */
{
    background-color: hsl(var(--primary-hue), 80%, 90%);
}

:root {
    --primary-hue: 210; /* Tom de azul */
    --primary: hsl(var(--primary-hue), 80%, 55%);
    --primary-light: hsl(var(--primary-hue), 80%, 97%);
    --primary-dark: hsl(var(--primary-hue), 80%, 45%);
    --accent: #ff9900;
    --danger: #dc3545;
    --success: #28a745;
    --text-dark: #2c3e50;
    --text-light: #7f8c8d;
    --bg-color: #f8f9fa;
    --card-bg: #ffffff;
    --border-color: #e0e6ef;
    --shadow-color: rgba(149, 157, 165, 0.2);
}

* { box-sizing: border-box; }

body {
    font-family: 'Inter', sans-serif; /* <-- NOVA FONTE */
    margin: 0;
    background: var(--bg-color);
    color: var(--text-dark);
    line-height: 1.6;
}

header {
    background: var(--primary);
    color: white;
    padding: 1rem 1.25rem;
    text-align: center;
    border-bottom: 4px solid var(--primary-dark);
}

h1, h2, h3 { margin: 0 0 1rem; }
h1 { font-size: 1.75rem; }
h2 { font-size: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
h3 { font-size: 1.1rem; color: var(--text-light); }

.container {
    max-width: 1100px;
    margin: 2rem auto;
    padding: 2rem;
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 8px 24px var(--shadow-color);
    position: relative;
}

/* --- NAVEGA√á√ÉO SUPERIOR E ABAS --- */
.nav-container {
    max-width: 1100px; margin: 1rem auto; padding: 0 2rem;
}
.back-link {
    display: inline-block;
    background: var(--success);
    color: white;
    text-decoration: none;
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    font-weight: 700;
    transition: all 0.2s ease-in-out;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.back-link:hover {
    background: #218838;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}
.tab-nav {
    display: flex; gap: 1rem; margin-bottom: 2rem;
    border-bottom: 1px solid var(--border-color);
    flex-wrap: wrap; /* Permite que as abas quebrem a linha */
}
.tab-link {
    color: var(--text-light);
    cursor: pointer;
    background: none; border: none;
    font-size: 1rem; font-weight: 500;
    padding: 0.75rem 0.25rem;
    border-bottom: 3px solid transparent;
    transition: all 0.2s ease-in-out;
}
.tab-link:hover { color: var(--primary); }
.tab-link.active {
    color: var(--primary); font-weight: 700;
    border-bottom-color: var(--primary);
}
.tab-content { display: none; }
.tab-content.active { display: block; }

/* --- FORMUL√ÅRIOS E BOT√ïES --- */
form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}
/* ================================================================ */
/* ============= NOVO: AJUSTE PARA 2 COLUNAS NOS FORMS ============ */
/* ================================================================ */

  #formMassa, #formPesagem, #formMoagem, #formCadastroOperador {
    grid-template-columns: repeat(2, 1fr);
  }
  
  /* Ajuste espec√≠fico para 3 colunas no formul√°rio de Moagem (Operador) */
  #formMoagem .operador-fieldset {
      grid-template-columns: repeat(3, 1fr);
  }
        
label {
    font-size: 0.8rem; font-weight: 700; margin-bottom: 0.5rem;
    display: block; color: var(--text-light); text-transform: uppercase;
}
input, select, textarea {
    width: 100%; padding: 0.8rem; border: 1px solid var(--border-color);
    border-radius: 8px; font-size: 1rem; background-color: var(--bg-color);
    transition: border-color 0.2s, box-shadow 0.2s;
}
input:focus, select:focus, textarea:focus {
    outline: none; border-color: var(--primary); background-color: var(--card-bg);
    box-shadow: 0 0 0 3px hsla(var(--primary-hue), 80%, 55%, 0.2);
}
textarea { min-height: 80px; resize: vertical; }
.full-width { grid-column: 1 / -1; }
.form-actions {
    grid-column: 1 / -1; display: flex;
    justify-content: flex-end; gap: 0.75rem; margin-top: 1rem;
}
button {
    background: var(--primary); color: white; border: none;
    padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer;
    font-weight: 700; font-size: 0.9rem;
    transition: all 0.2s ease-in-out;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
button:hover {
    filter: none; background: var(--primary-dark);
    transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}
button:active { transform: translateY(0); }
button.secondary { background: #e0e6ef; color: var(--text-dark); }
button.secondary:hover { background: #cfd8e3; }
button.delete-btn { background: var(--danger); }
button.edit-btn { background: var(--accent); margin-right: 5px; }
button.excel-btn { background: var(--success); }

/* --- TABELAS --- */
.history-section { margin-top: 2.5rem; }
.filters, .dashboard-filters {
    display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: flex-end;
    margin-bottom: 1.5rem; padding: 1rem;
    background-color: var(--primary-light); border-radius: 12px;
}
table {
    width: 100%; border-collapse: collapse; margin-top: 1.5rem;
}
th, td {
    padding: 1rem; text-align: left; font-size: 0.9rem;
    border: none; border-bottom: 1px solid var(--border-color);
}
th {
    background: none; color: var(--text-light); font-weight: 700;
    text-transform: uppercase; font-size: 0.75rem;
}
tbody tr:not(.linha-detalhes):hover { background-color: var(--primary-light); }
.efficiency-good { color: var(--success); font-weight: bold; }
.efficiency-ok { color: var(--accent); font-weight: bold; }
.efficiency-bad { color: var(--danger); font-weight: bold; }

/* --- SE√á√ÉO DE PALETES (FILTRO PRENSA) --- */
.paletes-fieldset {
    grid-column: 1 / -1; border: 1px solid var(--border-color);
    border-radius: 12px; padding: 1.5rem; margin-top: 1rem;
}
.paletes-fieldset legend {
    font-weight: 700; color: var(--primary);
    padding: 0 0.5rem; font-size: 1rem; text-transform: uppercase;
}
.palete-entry-row {
    display: grid; grid-template-columns: 2fr 1fr auto;
    gap: 1rem; align-items: center; margin-bottom: 1rem;
}
#kgPalete {
    background-color: var(--primary-light); font-weight: bold; color: var(--primary);
}

/* --- SE√á√ÉO DE MOAGEM --- */
.moagem-fieldset {
    grid-column: 1 / -1;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 1rem;
    display: grid;
    gap: 1.5rem;
}
.moagem-fieldset legend {
    font-weight: 700;
    color: var(--primary);
    padding: 0 0.5rem;
    font-size: 1rem;
    text-transform: uppercase;
}
/* Grid de 3 colunas para campos de sim/n√£o */
.radio-group-grid {
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
}
/* Estilo para grupo de r√°dio (Sim/N√£o) */
.radio-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.6rem 0.8rem;
    background-color: var(--bg-color);
}
.radio-group label {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-dark);
    text-transform: none;
}
.radio-group input[type="radio"] {
    width: auto;
    margin-right: 0.25rem;
    accent-color: var(--primary);
}
/* Container para campos condicionais (Ex: Quantidade) */
.conditional-field {
    display: none; /* Come√ßa escondido */
    margin-top: 0.75rem;
    padding-left: 1.5rem; /* Indenta√ß√£o */
}

/* Campos de Carga Din√¢micos (Moagem) */
#cargas-dinamicas-container {
    grid-column: 1 / -1;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px dashed var(--border-color);
}
.carga-dinamica-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    align-items: center;
}
.carga-dinamica-row label {
    font-size: 0.9rem;
    font-weight: 700;
    margin: 0;
    color: var(--text-dark);
    text-transform: none;
}


/* --- DETALHES EXPANS√çVEIS --- */
.linha-detalhes { display: none; background-color: var(--primary-light); }
.linha-detalhes td { padding: 1rem 1.5rem; text-align: left !important; }
.detalhe-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1rem;
}
.detalhe-grid span {
    font-weight: bold; color: var(--primary);
    display: block; margin-bottom: 0.25rem;
}
/* --- NOVO ESTILO PARA O BOT√ÉO EXPANDIR --- */
.expand-btn {
    background: transparent;
    border: none;
    padding: 4px;
    cursor: pointer;
    display: flex; /* Essencial para alinhar o √≠cone SVG */
    align-items: center;
    justify-content: center;
    margin: 0 auto; /* Centraliza o bot√£o na c√©lula da tabela */
    transition: transform 0.2s ease-in-out; /* Anima√ß√£o de rota√ß√£o */
}
.expand-btn svg {
    width: 14px; /* Tamanho do √≠cone (voc√™ pode diminuir aqui se quiser) */
    height: 14px;
    color: var(--text-light); /* Cor padr√£o do √≠cone */
}
.expand-btn:hover svg {
    color: var(--primary); /* Cor do √≠cone ao passar o mouse */
}
.expand-btn.open {
    transform: rotate(90deg); /* Gira o √≠cone 90 graus quando a classe 'open' √© adicionada */
}

/* --- DASHBOARD E GR√ÅFICOS --- */
.kpi-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.25rem; margin-bottom: 2.5rem;
}
.kpi-card {
    background: var(--card-bg); padding: 1.5rem; border-radius: 12px;
    border: 1px solid var(--border-color);
    transition: all 0.2s ease-in-out;
}
.kpi-card:hover {
    transform: translateY(-4px); box-shadow: 0 8px 24px var(--shadow-color);
}
.kpi-card h3 {
    font-size: 0.9rem; color: var(--text-light); margin: 0 0 0.5rem;
    font-weight: 500;
}
.kpi-card .value {
    font-size: 2.25rem; font-weight: 700; color: var(--text-dark);
}
.kpi-card.efficiency .value.good { color: var(--success); }
.kpi-card.efficiency .value.bad { color: var(--danger); }
.chart-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
}
.chart-container {
    background-color: var(--card-bg); padding: 1.5rem;
    border-radius: 12px; border: 1px solid var(--border-color);
}
.chart-container h3 { margin-top: 0; text-align: center; }

/* --- MODAL DE CONFIGURA√á√ÉO --- */
.config-btn { /* Classe gen√©rica para bot√µes de config */
    background: none; border: none; color: var(--text-light); font-size: 1.5rem;
    padding: 0.4rem 0.7rem; cursor: pointer; transition: all 0.2s;
    position: absolute; top: 1.5rem; right: 1.5rem;
}
.config-btn:hover { color: var(--primary); transform: rotate(15deg); }
/* Bot√£o de config da Moagem fica dentro da aba, relativo a ela */
#tabMoagem { position: relative; }
#openConfigMoagemBtn {
     position: absolute; top: 0.5rem; right: 0.5rem;
}

.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); display: none;
    justify-content: center; align-items: center; z-index: 1000;
}
.modal-content {
    background: white; padding: 2rem; border-radius: 16px;
    width: 90%; max-width: 700px;
}
/* Grid para inputs do modal */
.config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.25rem;
    margin-bottom: 1.5rem;
}
.modal-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
    border-top: 1px solid var(--border-color);
    padding-top: 1.5rem;
}


/* --- Estilos de Impress√£o (Mantidos) --- */
@page { size: landscape; margin: 15mm; }
@media print {
    body { background: #fff !important; font-size: 10pt; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    /* Esconde tudo que n√£o √© o dashboard */
    body > header, .nav-container, .config-btn, .tab-nav,
    #tabProducao, #tabPesagem, #tabMoagem, #tabOperadores, /* Esconde outras abas */
    .dashboard-filters, .expand-btn, .delete-btn, .edit-btn, .excel-btn,
    .form-actions, #printDashboardBtn,
    #openConfigBtn, #openConfigMoagemBtn /* Esconde bot√µes de config */
    {
        display: none !important;
    }
    
    .tab-content, #tabDashboard { display: block !important; } /* Garante que o dashboard seja vis√≠vel */
    .container {
        box-shadow: none !important; border: none !important; padding: 0 !important;
        margin: 0 !important; width: 100% !important; max-width: 100% !important;
    }
    #tabDashboard::before {
        content: 'Relat√≥rio de Produ√ß√£o - F√°brica de Massa';
        display: block; text-align: center; font-size: 1.4rem; font-weight: bold;
        margin-bottom: 1.5rem; border-bottom: 2px solid #333; padding-bottom: 1rem;
    }
    h2 { display: none; }
    .kpi-grid { margin-bottom: 1rem; gap: 1rem; }
    .kpi-card { padding: 0.8rem; border: 1px solid var(--border-color) !important; box-shadow: none !important; }
    .kpi-card h3 { font-size: 0.8rem; margin-bottom: 0.2rem; }
    .kpi-card .value { font-size: 1.8rem; }
    .chart-grid { grid-template-columns: 1fr 1fr; gap: 1rem; }
    .chart-container { padding: 1rem; page-break-inside: avoid; box-shadow: none !important; border: 1px solid var(--border-color) !important;}
    .chart-container h3 { font-size: 1rem; margin-bottom: 0.5rem; }
}
        /* ================================================================ */
/* ============== REDU√á√ÉO DE TAMANHO BOT√ïES DE A√á√ÉO =============== */
/* ================================================================ */

/* Alvo: Bot√µes de Editar e Excluir */
.edit-btn, .delete-btn {
    padding: 0.3rem 0.8rem; /* Padding vertical e horizontal reduzido */
    font-size: 0.75rem;     /* Tamanho da fonte um pouco menor */
}

/* --- NOVO ESTILO PARA O BOT√ÉO EXPANDIR --- */
.expand-btn {
    background: transparent;
    border: none;
    padding: 4px;
    cursor: pointer;
    display: flex; /* Essencial para alinhar o √≠cone SVG */
    align-items: center;
    justify-content: center;
    margin: 0 auto; /* Centraliza o bot√£o na c√©lula da tabela */
    transition: transform 0.2s ease-in-out; /* Anima√ß√£o de rota√ß√£o */
}
.expand-btn svg {
    width: 14px; /* Tamanho do √≠cone (voc√™ pode diminuir aqui se quiser) */
    height: 14px;
    color: var(--text-light); /* Cor padr√£o do √≠cone */
}
.expand-btn:hover svg {
    color: var(--primary); /* Cor do √≠cone ao passar o mouse */
}
.expand-btn.open {
    transform: rotate(90deg); /* Gira o √≠cone 90 graus quando a classe 'open' √© adicionada */
}
</style>
</head>
<body>
    <header>
        <h1>F√°brica de Massa - Lan√ßamento</h1>
    </header>

    <div class="nav-container">
        <a href="index.html" class="back-link">‚ùÆ Voltar para Produ√ß√£o Cer√¢mica</a>
    </div>

    <div class="container">
        <!-- Bot√£o de Configura√ß√£o Principal (Filtro Prensa) -->
        <button id="openConfigBtn" class="config-btn" title="Configura√ß√µes de Pesos e Metas (Filtro Prensa)" onclick="openConfigModal()">‚öôÔ∏è</button>
        
        <div class="tab-nav">
            <!-- ABA 1: Filtro Prensa (Antigo Lan√ßamentos) -->
            <button class="tab-link active" onclick="showTab('producao')">Filtro Prensa</button>
            <!-- ABA 2: Moagem -->
            <button class="tab-link" onclick="showTab('moagem')">Moagem</button>
            <!-- ABA 3: Pesagem -->
            <button class="tab-link" onclick="showTab('pesagem')">Pesagem</button>
            <!-- ABA 4: Dashboard -->
            <button class="tab-link" onclick="showTab('dashboard')">Dashboard</button>
            <!-- ABA 5: Operadores -->
            <button class="tab-link" onclick="showTab('operadores')">Operadores</button>
        </div>

        <!-- ================================================================ -->
        <!-- ============ CONTE√öDO ABA 1: FILTRO PRENSA (PRODU√á√ÉO) ========== -->
        <!-- ================================================================ -->
        <div id="tabProducao" class="tab-content active">
            <section>
                <h2>Lan√ßar Produ√ß√£o (Filtro Prensa)</h2>
                <form id="formMassa">
                    <div> <label for="data">Data</label> <input type="date" id="data" required> </div>
                    <div> <label for="turno">Turno</label> <select id="turno" required> <option value="">Selecione um turno</option> <option>Comercial</option> <option>Turno 1 (6x2)</option> <option>Turno 2 (6x2)</option> <option>Turno 3 (6x2)</option> <option>Turno 4 (6x2)</option> <option>Turno 1 (5x2)</option> <option>Turno 2 (5x2)</option> </select> </div>
                    <div> <label for="qtdFT">Quantidade de Filtro-prensagem (FT)</label> <input type="number" id="qtdFT" min="0" required> </div>
                    <div> <label for="qtdPlacas">Quantidade de Placas</label> <input type="number" id="qtdPlacas" min="0" value="0" required> </div>
                    
                    <fieldset class="paletes-fieldset">
                        <legend>Lan√ßamento de Paletes</legend>
                        <div class="palete-entry-row">
                            <select id="paleteSelect_1" class="palete-select"></select>
                            <input type="number" id="paleteQtd_1" class="palete-qtd" min="0" value="0" placeholder="Qtd.">
                            <div class="palete-peso-total">Peso: <output id="paletePesoTotal_1">0.00</output> kg</div>
                        </div>
                        <div class="palete-entry-row">
                            <select id="paleteSelect_2" class="palete-select"></select>
                            <input type="number" id="paleteQtd_2" class="palete-qtd" min="0" value="0" placeholder="Qtd.">
                            <div class="palete-peso-total">Peso: <output id="paletePesoTotal_2">0.00</output> kg</div>
                        </div>
                        <div class="palete-entry-row">
                             <select id="paleteSelect_3" class="palete-select"></select>
                            <input type="number" id="paleteQtd_3" class="palete-qtd" min="0" value="0" placeholder="Qtd.">
                            <div class="palete-peso-total">Peso: <output id="paletePesoTotal_3">0.00</output> kg</div>
                        </div>
                    </fieldset>
                    
                    <div class="full-width">
                        <label for="kgPalete">KG Total de Paletes (Calculado)</label>
                        <input type="number" id="kgPalete" step="0.1" min="0" readonly required>
                    </div>

                    <div class="full-width"> <label for="observacao">Observa√ß√£o</label> <textarea id="observacao" placeholder="Alguma observa√ß√£o sobre a produ√ß√£o..."></textarea> </div>
                    <div class="form-actions"> <button type="button" class="secondary" onclick="limparFormMassa()">Limpar</button> <button type="submit">Lan√ßar Produ√ß√£o</button> </div>
                </form>
            </section>
            <section class="history-section">
                <h2>Hist√≥rico de Produ√ß√£o (Filtro Prensa)</h2>
                <div class="filters">
                    <div> <label for="filtroDataInicio">Data In√≠cio</label> <input type="date" id="filtroDataInicio"> </div> <div> <label for="filtroDataFim">Data Fim</label> <input type="date" id="filtroDataFim"> </div> <div> <label for="filtroTurno">Turno</label> <select id="filtroTurno"> <option value="">Todos os Turnos</option> <option>Comercial</option> <option>Turno 1 (6x2)</option> <option>Turno 2 (6x2)</option> <option>Turno 3 (6x2)</option> <option>Turno 4 (6x2)</option> <option>Turno 1 (5x2)</option> <option>Turno 2 (5x2)</option> </select> </div>
                    <button class="excel-btn" onclick="exportarExcel()">Exportar Excel</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th></th> <th>Data</th> <th>Turno</th> <th>% FT</th> <th>% Palete</th> <th>Retrabalho (kg)</th> <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaHistoricoBody"></tbody>
                </table>
            </section>
        </div>

        <!-- ================================================================ -->
        <!-- ================== CONTE√öDO ABA 2: MOAGEM ================== -->
        <!-- ================================================================ -->
        <div id="tabMoagem" class="tab-content">
            <!-- Bot√£o de Configura√ß√£o da Moagem -->
            <button id="openConfigMoagemBtn" class="config-btn" title="Configura√ß√µes de Pontua√ß√£o (Moagem)" onclick="openConfigMoagemModal()">‚öôÔ∏è</button>
            
            <section>
                <h2>Lan√ßar Atividades (Moagem)</h2>
                <form id="formMoagem" onsubmit="handleFormMoagemSubmit(event)">
                    <!-- Campos Iniciais -->
                    <div>
                        <label for="dataMoagem">Data</label>
                        <input type="date" id="dataMoagem" required>
                    </div>
                    <div>
                        <label for="turnoMoagem">Turno</label>
                        <select id="turnoMoagem" required>
                            <option value="">Selecione um turno</option>
                            <option>Turno 1 (6x2)</option>
                            <option>Turno 2 (6x2)</option>
                            <option>Turno 3 (6x2)</option>
                            <option>Turno 4 (6x2)</option>
                        </select>
                    </div>
                    <div class="full-width">
                        <label for="operadorMoagem">Operador</label>
                        <select id="operadorMoagem" required>
                            <option value="">Carregando operadores...</option>
                        </select>
                    </div>

                    <!-- Fieldset Operador -->
                    <fieldset class="moagem-fieldset operador-fieldset">
                        <legend>Operador</legend>
                        
                        <!-- Coluna 1 -->
                        <div>
                            <label for="qtdCargasMoagem">Quantidade de Cargas</label>
                            <input type="number" id="qtdCargasMoagem" min="0" value="0" required>
                        </div>
                        <div>
                            <label for="qtdDescarga">Descargas (Qtd)</label>
                            <input type="number" id="qtdDescarga" min="0" value="0">
                        </div>
                        <div>
                            <label for="qtdCargasSubidas">Cargas Subidas (Qtd)</label> <!-- NOVO CAMPO -->
                            <input type="number" id="qtdCargasSubidas" min="0" value="0">
                        </div>
                        
                        <!-- Coluna 2 (Sim/N√£o) -->
                        <div>
                            <label>Guardou Mat√©ria?</label>
                            <div class="radio-group">
                                <input type="radio" id="guardouMateriaNao" name="guardouMateria" value="nao" checked onchange="toggleConditionalField('guardouMateria', false)">
                                <label for="guardouMateriaNao">N√£o</label>
                                <input type="radio" id="guardouMateriaSim" name="guardouMateria" value="sim" onchange="toggleConditionalField('guardouMateria', true)">
                                <label for="guardouMateriaSim">Sim</label>
                            </div>
                            <div id="conditional-guardouMateria" class="conditional-field">
                                <label for="qtdGuardouMateria">Quantas?</label>
                                <input type="number" id="qtdGuardouMateria" min="0" value="0">
                            </div>
                        </div>
                        <div>
                            <label>Subiu Massa?</label>
                            <div class="radio-group">
                                <input type="radio" id="subiuMassaNao" name="subiuMassa" value="nao" checked onchange="toggleConditionalField('subiuMassa', false)">
                                <label for="subiuMassaNao">N√£o</label>
                                <input type="radio" id="subiuMassaSim" name="subiuMassa" value="sim" onchange="toggleConditionalField('subiuMassa', true)">
                                <label for="subiuMassaSim">Sim</label>
                            </div>
                            <div id="conditional-subiuMassa" class="conditional-field">
                                <label for="qtdSubiuMassa">Quantas?</label>
                                <input type="number" id="qtdSubiuMassa" min="0" value="0">
                            </div>
                        </div>
                        <div>
                            <label>Virou Ca√ßamba?</label>
                            <div class="radio-group">
                                <input type="radio" id="virouCacambaNao" name="virouCacamba" value="nao" checked onchange="toggleConditionalField('virouCacamba', false)">
                                <label for="virouCacambaNao">N√£o</label>
                                <input type="radio" id="virouCacambaSim" name="virouCacamba" value="sim" onchange="toggleConditionalField('virouCacamba', true)">
                                <label for="virouCacambaSim">Sim</label>
                            </div>
                            <div id="conditional-virouCacamba" class="conditional-field">
                                <label for="qtdVirouCacamba">Quantas?</label>
                                <input type="number" id="qtdVirouCacamba" min="0" value="0">
                            </div>
                        </div>

                        <!-- Coluna 3 (Sim/N√£o) -->
                        <div>
                            <label>Arrumou o Box?</label>
                            <div class="radio-group">
                                <input type="radio" id="arrumouBoxNao" name="arrumouBox" value="nao" checked>
                                <label for="arrumouBoxNao">N√£o</label>
                                <input type="radio" id="arrumouBoxSim" name="arrumouBox" value="sim">
                                <label for="arrumouBoxSim">Sim</label>
                            </div>
                        </div>
                        <div>
                            <label>Desceu Ca√ßamba?</label>
                            <div class="radio-group">
                                <input type="radio" id="desceuCacambaNao" name="desceuCacamba" value="nao" checked onchange="toggleConditionalField('desceuCacamba', false)">
                                <label for="desceuCacambaNao">N√£o</label>
                                <input type="radio" id="desceuCacambaSim" name="desceuCacamba" value="sim" onchange="toggleConditionalField('desceuCacamba', true)">
                                <label for="desceuCacambaSim">Sim</label>
                            </div>
                             <div id="conditional-desceuCacamba" class="conditional-field">
                                <label for="qtdDesceuCacamba">Quantas?</label>
                                <input type="number" id="qtdDesceuCacamba" min="0" value="0">
                            </div>
                        </div>
                         <div>
                            <label>Carregou Caco?</label>
                            <div class="radio-group">
                                <input type="radio" id="carregouCacoNao" name="carregouCaco" value="nao" checked>
                                <label for="carregouCacoNao">N√£o</label>
                                <input type="radio" id="carregouCacoSim" name="carregouCaco" value="sim">
                                <label for="carregouCacoSim">Sim</label>
                            </div>
                        </div>
                        
                    </fieldset>
                    
                    <!-- Container para Cargas Din√¢micas -->
                    <div id="cargas-dinamicas-container">
                        <!-- Campos de Moinho/Peso ser√£o injetados aqui -->
                    </div>

                    <!-- Fieldset Auxiliar -->
                    <fieldset class="moagem-fieldset radio-group-grid">
                        <legend>Auxiliar</legend>
                        <div>
                            <label>Lavou a Peneira?</label>
                            <div class="radio-group">
                                <input type="radio" id="lavouPeneiraNao" name="lavouPeneira" value="nao" checked>
                                <label for="lavouPeneiraNao">N√£o</label>
                                <input type="radio" id="lavouPeneiraSim" name="lavouPeneira" value="sim">
                                <label for="lavouPeneiraSim">Sim</label>
                            </div>
                        </div>
                        <div>
                            <label>Limpou o Moinho?</label>
                            <div class="radio-group">
                                <input type="radio" id="limpouMoinhoNao" name="limpouMoinho" value="nao" checked>
                                <label for="limpouMoinhoNao">N√£o</label>
                                <input type="radio" id="limpouMoinhoSim" name="limpouMoinho" value="sim">
                                <label for="limpouMoinhoSim">Sim</label>
                            </div>
                        </div>
                        <div>
                            <label>Lavou Peneira/Dosador?</label>
                            <div class="radio-group">
                                <input type="radio" id="lavouPeneiraDosadorNao" name="lavouPeneiraDosador" value="nao" checked>
                                <label for="lavouPeneiraDosadorNao">N√£o</label>
                                <input type="radio" id="lavouPeneiraDosadorSim" name="lavouPeneiraDosador" value="sim">
                                <label for="lavouPeneiraDosadorSim">Sim</label>
                            </div>
                        </div>
                    </fieldset>
                    
                    <div class="full-width">
                        <label for="observacaoMoagem">Observa√ß√£o</label>
                        <textarea id="observacaoMoagem" placeholder="Alguma observa√ß√£o sobre a moagem..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="secondary" onclick="limparFormMoagem()">Limpar</button>
                        <button type="submit">Lan√ßar Atividade</button>
                    </div>
                </form>
            </section>
            
            <section class="history-section">
                <h2>Hist√≥rico de Moagem</h2>
                <!-- FILTROS ADICIONADOS -->
                <div class="filters">
                    <div> <label for="filtroDataInicioMoagem">Data In√≠cio</label> <input type="date" id="filtroDataInicioMoagem"> </div>
                    <div> <label for="filtroDataFimMoagem">Data Fim</label> <input type="date" id="filtroDataFimMoagem"> </div>
                    <div> <label for="filtroTurnoMoagem">Turno</label> 
                        <select id="filtroTurnoMoagem">
                            <option value="">Todos os Turnos</option>
                            <option>Turno 1 (6x2)</option>
                            <option>Turno 2 (6x2)</option>
                            <option>Turno 3 (6x2)</option>
                            <option>Turno 4 (6x2)</option>
                        </select>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th></th> <!-- Para expandir -->
                            <th>Data</th>
                            <th>Turno</th>
                            <th>Operador</th>
                            <th>Cargas (Qtd)</th>
                            <th>Peso Total (kg)</th>
                            <th>Pontos</th>
                            <th>% Meta</th> <!-- COLUNA ADICIONADA -->
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaHistoricoMoagem">
                         <tr><td colspan="9">Nenhum lan√ßamento de moagem ainda.</td></tr> <!-- COLSPAN ATUALIZADO (8->9) -->
                    </tbody>
                </table>
            </section>
        </div>

        <!-- ================================================================ -->
        <!-- ================== CONTE√öDO ABA 3: PESAGEM ================= -->
        <!-- ================================================================ -->
        <div id="tabPesagem" class="tab-content">
            <section>
                <h2>Lan√ßar Peso de Palete/Mesa</h2>
                <form id="formPesagem">
                    <div>
                        <label for="dataPesagem">Data</label>
                        <input type="date" id="dataPesagem" required>
                    </div>
                    <div>
                        <label for="codigoPalete">C√≥digo do Palete/Mesa</label>
                        <input type="text" id="codigoPalete" required placeholder="Ex: P01, MESA-A">
                    </div>
                    <div>
                        <label for="pesoTotalPalete">Peso Total (kg)</label>
                        <input type="number" id="pesoTotalPalete" step="0.1" min="0" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="secondary" onclick="document.getElementById('formPesagem').reset(); document.getElementById('dataPesagem').value = obterDataLocalFormatada();">Limpar</button>
                        <button type="submit">Lan√ßar Peso</button>
                    </div>
                </form>
            </section>
            <section class="history-section">
                <h2>Hist√≥rico de Pesagem</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Data</th> <th>C√≥digo</th> <th>Peso Total (kg)</th> <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaPesagemBody"></tbody>
                </table>
            </section>
        </div>

        <!-- ================================================================ -->
        <!-- ================== CONTE√öDO ABA 4: DASHBOARD ================ -->
        <!-- ================================================================ -->
        <div id="tabDashboard" class="tab-content">
            <h2>Dashboard de Produ√ß√£o (Filtro Prensa)</h2>
            <div class="dashboard-filters">
                <div>
                    <label for="dashFiltroDataInicio">Data In√≠cio</label>
                    <input type="date" id="dashFiltroDataInicio">
                </div>
                 <div>
                    <label for="dashFiltroDataFim">Data Fim</label>
                    <input type="date" id="dashFiltroDataFim">
                </div>
                 <div>
                    <label for="dashFiltroTurno">Turno</label>
                    <select id="dashFiltroTurno">
                        <option value="">Todos os Turnos</option>
                        <option>Comercial</option> <option>Turno 1 (6x2)</option> <option>Turno 2 (6x2)</option> <option>Turno 3 (6x2)</option> <option>Turno 4 (6x2)</option> <option>Turno 1 (5x2)</option> <option>Turno 2 (5x2)</option>
                    </select>
                </div>
                <button id="printDashboardBtn" onclick="window.print()" style="background-color: var(--accent);">üñ®Ô∏è Imprimir Dashboard</button>
            </div>

            <div class="kpi-grid">
                 <div class="kpi-card">
                    <h3>Meta FT (kg)</h3> <div class="value" id="kpiTotalMeta">---</div>
                </div>
                 <div class="kpi-card">
                    <h3>Realizado FT (kg)</h3> <div class="value" id="kpiTotalRealizado">---</div>
                </div>
                 <div class="kpi-card efficiency">
                    <h3>Efici√™ncia</h3> <div class="value" id="kpiEficiencia">---</div>
                </div>
                 <div class="kpi-card">
                    <h3>Retrabalho (kg)</h3> <div class="value" id="kpiRetrabalho">---</div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-container">
                     <h3>Produ√ß√£o por Turno (%)</h3>
                     <canvas id="pieChartTurnos"></canvas>
                </div>
                 <div class="chart-container">
                    <h3>Produ√ß√£o Mensal (√öltimos 12 Meses)</h3>
                    <select id="filtroTurnoGraficoMes" style="width: 100%; margin-bottom: 1rem;">
                        <option value="">Todos os Turnos</option>
                        <option>Comercial</option> <option>Turno 1 (6x2)</option> <option>Turno 2 (6x2)</option> <option>Turno 3 (6x2)</option> <option>Turno 4 (6x2)</option> <option>Turno 1 (5x2)</option> <option>Turno 2 (5x2)</option>
                    </select>
                    <canvas id="barChartMensal"></canvas>
                </div>
            </div>
        </div>
        
        <!-- ================================================================ -->
        <!-- ================= CONTE√öDO ABA 5: OPERADORES ================= -->
        <!-- ================================================================ -->
        <div id="tabOperadores" class="tab-content">
            <section>
                <h2>Cadastrar Novo Operador (Moagem)</h2>
                <form id="formCadastroOperador" onsubmit="handleCadastroOperadorSubmit(event)">
                    <div>
                        <label for="dataCadastroOperador">Data de In√≠cio</label>
                        <input type="date" id="dataCadastroOperador" required>
                    </div>
                    <div>
                        <label for="nomeOperador">Nome do Operador</label>
                        <input type="text" id="nomeOperador" required placeholder="Nome completo">
                    </div>
                    <div>
                        <label for="turnoOperador">Turno</label>
                        <select id="turnoOperador" required>
                            <option value="">Selecione o turno</option>
                            <option>Turno 1 (6x2)</option>
                            <option>Turno 2 (6x2)</option>
                            <option>Turno 3 (6x2)</option>
                            <option>Turno 4 (6x2)</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="secondary" onclick="limparFormOperador()">Limpar</button>
                        <button type="submit">Cadastrar Operador</button>
                    </div>
                </form>
            </section>
            
            <section class="history-section">
                <h2>Operadores Cadastrados</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Data In√≠cio</th>
                            <th>Nome</th>
                            <th>Turno</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaOperadoresBody">
                        <tr><td colspan="4">Nenhum operador cadastrado.</td></tr>
                    </tbody>
                </table>
            </section>
        </div>
    </div>

    <!-- ================================================================ -->
    <!-- ======================= MODAIS DE CONFIGURA√á√ÉO ===================== -->
    <!-- ================================================================ -->
    
    <!-- MODAL 1: Configura√ß√£o Filtro Prensa -->
    <div id="configModal" class="modal-overlay" onclick="closeConfigModal(event)">
        <div class="modal-content">
            <h3>Configura√ß√µes de Pesos e Metas (Filtro Prensa)</h3>
            <div class="config-grid">
                <div> <label for="pesoFiltro">Peso por Filtro Prensa (kg)</label> <input type="number" id="pesoFiltro" step="0.1"> </div>
                <div> <label for="pesoPlaca">Peso por Placa (kg)</label> <input type="number" id="pesoPlaca" step="0.1"> </div>
                <div> <label for="metaKgFT">Meta KG (Filtro Prensa)</label> <input type="number" id="metaKgFT" step="100"> </div>
                <div> <label for="metaKgPalete">Meta KG (Paletes)</label> <input type="number" id="metaKgPalete" step="100"> </div>
            </div>
            <div class="modal-actions">
                <input type="password" id="configSenha" placeholder="Senha para salvar" style="flex-grow: 1;">
                <button type="button" class="secondary" onclick="closeConfigModal(event, true)">Cancelar</button>
                <button onclick="salvarConfiguracoes()">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL 2: Configura√ß√£o Moagem (Pontua√ß√£o) -->
    <div id="configMoagemModal" class="modal-overlay" onclick="closeConfigMoagemModal(event)">
        <div class="modal-content">
            <h3>Configura√ß√µes de Pontua√ß√£o (Moagem)</h3>
            <div class="config-grid">
                <!-- Coluna 1: Pontos por Atividade -->
                <div> <label for="pontosDescarga">Pontos por Descarga (un)</label> <input type="number" id="pontosDescarga" step="0.1"> </div>
                <div> <label for="pontosCargasSubidas">Pontos por Carga Subida (un)</label> <input type="number" id="pontosCargasSubidas" step="0.1"> </div>
                <div> <label for="pontosGuardouMateria">Pontos por Guardou Mat√©ria (un)</label> <input type="number" id="pontosGuardouMateria" step="0.1"> </div>
                <div> <label for="pontosArrumouBox">Pontos por Arrumou o Box (sim)</label> <input type="number" id="pontosArrumouBox" step="0.1"> </div>
                <div> <label for="pontosCarregouCaco">Pontos por Carregou Caco (sim)</label> <input type="number" id="pontosCarregouCaco" step="0.1"> </div>
                <div> <label for="pontosSubiuMassa">Pontos por Subiu Massa (un)</label> <input type="number" id="pontosSubiuMassa" step="0.1"> </div>
                <div> <label for="pontosDesceuCacamba">Pontos por Desceu Ca√ßamba (un)</label> <input type="number" id="pontosDesceuCacamba" step="0.1"> </div>
                <div> <label for="pontosVirouCacamba">Pontos por Virou Ca√ßamba (un)</label> <input type="number" id="pontosVirouCacamba" step="0.1"> </div>
                
                <!-- Coluna 2: Auxiliar e Cargas -->
                <div> <label for="pontosLavouPeneira">Pontos (Aux) Lavou Peneira (sim)</label> <input type="number" id="pontosLavouPeneira" step="0.1"> </div>
                <div> <label for="pontosLimpouMoinho">Pontos (Aux) Limpou Moinho (sim)</label> <input type="number" id="pontosLimpouMoinho" step="0.1"> </div>
                <div> <label for="pontosLavouPeneiraDosador">Pontos (Aux) Lavou Peneira/Dosador (sim)</label> <input type="number" id="pontosLavouPeneiraDosador" step="0.1"> </div>
                <hr style="grid-column: 1 / -1; border-color: var(--border-color);">
                <div>
                    <!-- L√ìGICA ATUALIZADA AQUI -->
                    <label for="pontosKgMoagem">Pontos a cada 1000 kg</label>
                    <input type="number" id="pontosKgMoagem" step="0.01">
                </div>
                <div>
                    <label for="metaPontosMoagem">Meta de Pontos (por dia)</label>
                    <input type="number" id="metaPontosMoagem" step="1">
                </div>
            </div>
            <div class="modal-actions">
                <input type="password" id="configSenhaMoagem" placeholder="Senha para salvar" style="flex-grow: 1;">
                <button type="button" class="secondary" onclick="closeConfigMoagemModal(event, true)">Cancelar</button>
                <button onclick="salvarConfigPontosMoagem()">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- ================================================================ -->
    <!-- ======================= SCRIPTS ================================ -->
    <!-- ================================================================ -->
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, deleteDoc, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB2z4mFj5qVtb59uocKK8JXhMTfi8MGSTo",
            authDomain: "acompanhamento-de-produc-b68b0.firebaseapp.com",
            projectId: "acompanhamento-de-produc-b68b0",
            storageBucket: "acompanhamento-de-produc-b68b0.firebasestorage.app",
            messagingSenderId: "891709449679",
            appId: "1:891709449679:web:43e83e076f5fb3201e1eba"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- Expondo fun√ß√µes e cole√ß√µes globalmente ---
        window.db = db;
        // Cole√ß√µes
        window.massaCol = collection(db, "producao_massa");
        window.pesagemCol = collection(db, "pesagem_paletes");
        window.moagemCol = collection(db, "producao_moagem"); // Nova cole√ß√£o Moagem
        window.operadoresCol = collection(db, "operadores_moagem"); // Nova cole√ß√£o Operadores
        
        // Fun√ß√µes do Firestore
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        
        console.log("Firebase conectado para a F√°brica de Massa!");
    </script>
    
    <script>
    // --- Configura√ß√µes Globais (Defaults) ---
    
    // Config Filtro Prensa
    let appConfig = {
        pesoFiltro: 4100, pesoPlaca: 39.1,
        metaKgFT: 12300, metaKgPalete: 12500
    };
    let paletesDisponiveis = new Map();

    // Config Moagem (Pontua√ß√£o)
    let appConfigMoagem = {
        pontosKgMoagem: 1,
        pontosDescarga: 1,
        pontosCargasSubidas: 1, // Novo campo
        pontosGuardouMateria: 1,
        pontosArrumouBox: 1,
        pontosCarregouCaco: 1,
        pontosSubiuMassa: 1,
        pontosDesceuCacamba: 1,
        pontosVirouCacamba: 1,
        pontosLavouPeneira: 1,
        pontosLimpouMoinho: 1,
        pontosLavouPeneiraDosador: 1,
        metaPontosMoagem: 50 // Nova meta
    };

    // ### REGISTRO DO PLUGIN DE R√ìTULOS (DATALABELS) ###
    Chart.register(ChartDataLabels);

    // --- Fun√ß√µes Auxiliares ---
    
    function showTab(tabName) {
        // Esconde todos os conte√∫dos
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        // Remove 'active' de todos os links
        document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
        
        // Monta o ID do conte√∫do da aba (ex: 'tabProducao', 'tabMoagem')
        const tabContentId = `tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`;
        const tabContentElement = document.getElementById(tabContentId);
        
        // Mostra o conte√∫do da aba clicada
        if (tabContentElement) {
            tabContentElement.classList.add('active');
        }
        
        // Adiciona 'active' ao link clicado
        // Precisamos encontrar o bot√£o correto, pois event.target pode n√£o estar dispon√≠vel se chamado de outro lugar
        const links = document.querySelectorAll('.tab-link');
        for (let link of links) {
            if (link.onclick.toString().includes(`showTab('${tabName}')`)) {
                link.classList.add('active');
                break;
            }
        }
        
        // Controla a visibilidade do bot√£o de config principal (s√≥ aparece na aba Filtro Prensa)
        const configBtnPrincipal = document.getElementById('openConfigBtn');
        if (configBtnPrincipal) {
            configBtnPrincipal.style.display = (tabName === 'producao') ? 'block' : 'none';
        }
    }
    
    // Fun√ß√£o global para classes de efici√™ncia
    const getEficClass = (perc) => {
        if (perc >= 98) return 'efficiency-good';
        if (perc >= 90) return 'efficiency-ok';
        return 'efficiency-bad';
    };

    function obterDataLocalFormatada() {
        const data = new Date();
        const ano = data.getFullYear();
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const dia = String(data.getDate()).padStart(2, '0');
        return `${ano}-${mes}-${dia}`;
    }

    // --- MODAL 1: Config Filtro Prensa ---
    function openConfigModal() {
        document.getElementById('pesoFiltro').value = appConfig.pesoFiltro;
        document.getElementById('pesoPlaca').value = appConfig.pesoPlaca;
        document.getElementById('metaKgFT').value = appConfig.metaKgFT;
        document.getElementById('metaKgPalete').value = appConfig.metaKgPalete;
        document.getElementById('configModal').style.display = 'flex';
    }
    function closeConfigModal(event, force = false) {
        if (force || event.target.id === 'configModal') {
            document.getElementById('configModal').style.display = 'none';
            document.getElementById('configSenha').value = ''; // Limpa senha
        }
    }
    async function salvarConfiguracoes() {
        if (document.getElementById('configSenha').value !== 'pb2025') {
            alert('Senha incorreta!'); return;
        }
        const newConfig = {
            pesoFiltro: parseFloat(document.getElementById('pesoFiltro').value) || 0,
            pesoPlaca: parseFloat(document.getElementById('pesoPlaca').value) || 0,
            metaKgFT: parseFloat(document.getElementById('metaKgFT').value) || 0,
            metaKgPalete: parseFloat(document.getElementById('metaKgPalete').value) || 0
        };
        try {
            const configDocRef = window.doc(db, "configuracoes", "massaConfig");
            await window.setDoc(configDocRef, newConfig, { merge: true });
            appConfig = newConfig;
            alert('Configura√ß√µes (Filtro Prensa) salvas com sucesso!');
            closeConfigModal({target: {id: 'configModal'}}, true);
            renderizarHistorico(); // Atualiza hist√≥rico para refletir novas metas
        } catch (error) {
            console.error("Erro ao salvar configura√ß√µes:", error);
            alert("Erro ao salvar configura√ß√µes.");
        }
    }
    async function carregarConfiguracoes() {
        try {
            const configDocRef = window.doc(db, "configuracoes", "massaConfig");
            const docSnap = await window.getDoc(configDocRef);
            if (docSnap.exists()) {
                appConfig = { ...appConfig, ...docSnap.data() }; // Mescla com defaults
            }
        } catch(error) {
            console.error("Erro ao carregar configura√ß√µes (Filtro Prensa):", error);
        }
    }

    // --- L√ìGICA ABA 1: Filtro Prensa ---
    
    async function carregarOpcoesPaletes() {
        try {
            const q = query(window.pesagemCol, orderBy("codigo"));
            const querySnapshot = await getDocs(q);
            paletesDisponiveis.clear();
            querySnapshot.forEach(doc => {
                const data = doc.data();
                if(data.codigo && data.peso) {
                    paletesDisponiveis.set(data.codigo, data.peso);
                }
            });
            const selects = document.querySelectorAll('.palete-select');
            selects.forEach(select => {
                select.innerHTML = '<option value="">Selecione...</option>';
                paletesDisponiveis.forEach((peso, codigo) => {
                    const option = document.createElement('option');
                    option.value = codigo;
                    option.textContent = `${codigo} (${peso.toFixed(2)} kg)`;
                    option.dataset.peso = peso;
                    select.appendChild(option);
                });
            });
        } catch (error) {
            console.error("Erro ao carregar op√ß√µes de paletes:", error);
        }
    }

    function calcularPesoTotalPaletes() {
        let grandTotal = 0;
        for (let i = 1; i <= 3; i++) {
            const select = document.getElementById(`paleteSelect_${i}`);
            const qtdInput = document.getElementById(`paleteQtd_${i}`);
            const pesoOutput = document.getElementById(`paletePesoTotal_${i}`);
            const selectedOption = select.options[select.selectedIndex];
            const pesoUnitario = parseFloat(selectedOption?.dataset.peso) || 0;
            const quantidade = parseInt(qtdInput.value) || 0;
            const subTotal = pesoUnitario * quantidade;
            pesoOutput.textContent = subTotal.toFixed(2);
            grandTotal += subTotal;
        }
        document.getElementById('kgPalete').value = grandTotal.toFixed(2);
    }
    
    function limparFormMassa() {
        document.getElementById('formMassa').reset();
        document.getElementById('data').value = obterDataLocalFormatada();
        calcularPesoTotalPaletes();
    }

   document.getElementById('formMassa').addEventListener('submit', async function(event) {
        event.preventDefault();
        const kgPaleteReal = parseFloat(document.getElementById('kgPalete').value);
        if (kgPaleteReal <= 0) {
            alert("O KG Total de Paletes deve ser maior que zero. Lance ao menos um palete.");
            return;
        }
        const qtdFT = parseInt(document.getElementById('qtdFT').value);
        const qtdPlacas = parseInt(document.getElementById('qtdPlacas').value);
        const kgCalculado = (qtdFT * appConfig.pesoFiltro) + (qtdPlacas * appConfig.pesoPlaca);
        
        const retrabalhoCalculado = kgPaleteReal - kgCalculado;
        const retrabalhoKg = Math.max(0, retrabalhoCalculado); // Garante que n√£o seja negativo

        const novoRegistro = {
            data: document.getElementById('data').value,
            turno: document.getElementById('turno').value,
            qtdFT,
            qtdPlacas,
            kgPalete: kgPaleteReal,
            observacao: document.getElementById('observacao').value,
            kgCalculado,
            retrabalhoKg, 
            timestamp: new Date().toISOString(),
            metaKgFT: appConfig.metaKgFT,
            metaKgPalete: appConfig.metaKgPalete
        };
        try {
            await window.addDoc(window.massaCol, novoRegistro);
            alert('Produ√ß√£o (Filtro Prensa) lan√ßada com sucesso! ‚úÖ');
            renderizarHistorico();
            limparFormMassa();
        } catch (error) {
            console.error("Erro ao salvar no Firebase: ", error);
            alert("Erro ao salvar. Verifique o console. ‚ùå");
        }
    });
    
    async function renderizarHistorico() {
        const tbody = document.getElementById('tabelaHistoricoBody');
        tbody.innerHTML = `<tr><td colspan="7">Carregando...</td></tr>`;
        const filtroDataInicio = document.getElementById('filtroDataInicio').value;
        const filtroDataFim = document.getElementById('filtroDataFim').value;
        const filtroTurno = document.getElementById('filtroTurno').value;
        let queryConstraints = [orderBy("data", "desc"), orderBy("timestamp", "desc")];
        if (filtroDataInicio) queryConstraints.push(where("data", ">=", filtroDataInicio));
        if (filtroDataFim) queryConstraints.push(where("data", "<=", filtroDataFim));
        if (filtroTurno) queryConstraints.push(where("turno", "==", filtroTurno));
        try {
            const q = query(window.massaCol, ...queryConstraints);
            const querySnapshot = await getDocs(q);
            const dadosFiltrados = querySnapshot.docs;
            tbody.innerHTML = '';
            if (dadosFiltrados.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7">Nenhum registro encontrado.</td></tr>`;
                return;
            }
            dadosFiltrados.forEach(doc => {
                const reg = doc.data();
                const docId = doc.id;
                const metaFTDoRegistro = reg.metaKgFT || appConfig.metaKgFT;
                const metaPaleteDoRegistro = reg.metaKgPalete || appConfig.metaKgPalete;
                const eficFT = (reg.kgCalculado / (metaFTDoRegistro || 1)) * 100;
                const eficPalete = (reg.kgPalete / (metaPaleteDoRegistro || 1)) * 100;
                
                let retrabalhoValor = reg.retrabalhoKg;
                let retrabalhoClasse = '';
                if (retrabalhoValor != null) {
                    if (retrabalhoValor > 0) retrabalhoClasse = 'efficiency-good';
                    if (retrabalhoValor < 0) retrabalhoClasse = 'efficiency-bad';
                    retrabalhoValor = `${retrabalhoValor.toFixed(2)}`;
                } else {
                    retrabalhoValor = 'N/A';
                }
                const trPrincipal = document.createElement('tr');
                trPrincipal.innerHTML = `
    <td><button class="expand-btn" onclick="toggleDetalhes('detalhes-fp-${docId}', this)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></button></td>
    <td>${new Date(reg.data + 'T03:00:00').toLocaleDateString('pt-BR')}</td>
                    <td>${reg.turno}</td>
                    <td class="${getEficClass(eficFT)}">${eficFT.toFixed(2)}%</td>
                    <td class="${getEficClass(eficPalete)}">${eficPalete.toFixed(2)}%</td>
                    <td class="${retrabalhoClasse}">${retrabalhoValor}</td>
                    <td>
                        <button class="delete-btn" onclick="deletarRegistro('${docId}')">Excluir</button>
                    </td>
                `;
                const trDetalhes = document.createElement('tr');
                trDetalhes.id = `detalhes-fp-${docId}`;
                trDetalhes.className = 'linha-detalhes';
                trDetalhes.innerHTML = `
                    <td colspan="7">
                        <div class="detalhe-grid">
                            <div><span>Filtro Prensa (kg):</span> ${reg.kgCalculado.toFixed(2)} kg</div>
                            <div><span>Palete (kg):</span> ${reg.kgPalete.toFixed(2)} kg</div>
                            <div><span>Retrabalho (kg):</span> ${reg.retrabalhoKg ? reg.retrabalhoKg.toFixed(2) + ' kg' : 'N/A'}</div>
                            <div><span>Qtd. Filtros (FT):</span> ${reg.qtdFT}</div>
                            <div><span>Qtd. Placas:</span> ${reg.qtdPlacas}</div>
                            <div><span>Meta FT (kg):</span> ${reg.metaKgFT ? reg.metaKgFT.toFixed(2) + ' kg' : 'N/A'}</div>
                            <div><span>Meta Palete (kg):</span> ${reg.metaKgPalete ? reg.metaKgPalete.toFixed(2) + ' kg' : 'N/A'}</div>
                            <div style="grid-column: 1 / -1;"><span>Observa√ß√£o:</span> ${reg.observacao || 'Nenhuma'}</div>
                        </div>
                    </td>
                `;
                tbody.appendChild(trPrincipal);
                tbody.appendChild(trDetalhes);
            });
        } catch (error) {
            console.error("Erro ao buscar dados (Filtro Prensa):", error);
            tbody.innerHTML = `<tr><td colspan="7">Erro ao carregar dados.</td></tr>`;
        }
    }

    // --- L√ìGICA ABA 2: Moagem ---

    // Lida com os campos Sim/N√£o que mostram/escondem inputs de quantidade
    window.toggleConditionalField = function(fieldName, isSim) {
        const field = document.getElementById(`conditional-${fieldName}`);
        if (field) {
            field.style.display = isSim ? 'block' : 'none';
        }
        // Se for "N√£o", zera o valor do input filho
        if (!isSim) {
            const input = field.querySelector('input');
            if (input) input.value = 0;
        }
    }

    // Atualiza os campos din√¢micos de carga (moinho/peso)
    window.atualizarCamposCargaMoagem = function() {
        const qtd = parseInt(document.getElementById('qtdCargasMoagem').value) || 0;
        const container = document.getElementById('cargas-dinamicas-container');
        container.innerHTML = ''; // Limpa

        if (qtd > 0) {
             container.innerHTML = `<label class="full-width" style="font-weight: 700; color: var(--primary);">Detalhes das Cargas</label>`;
        }

        for (let i = 1; i <= qtd; i++) {
            const div = document.createElement('div');
            div.className = 'carga-dinamica-row';
            div.innerHTML = `
                <div>
                    <label for="moinho_${i}">Carga ${i} - Moinho</label>
                    <select id="moinho_${i}" required>
                        <option value="">Moinho...</option>
                        <option value="1">Moinho 1</option>
                        <option value="2">Moinho 2</option>
                        <option value="3">Moinho 3</option>
                    </select>
                </div>
                <div>
                    <label for="peso_${i}">Peso (kg)</label>
                    <input type="number" id="peso_${i}" min="0" step="0.1" required placeholder="Peso ${i}">
                </div>
            `;
            container.appendChild(div);
        }
    }
    
    // Limpa o formul√°rio de Moagem
    function limparFormMoagem() {
        document.getElementById('formMoagem').reset();
        document.getElementById('dataMoagem').value = obterDataLocalFormatada();
        // Esconde todos os campos condicionais
        document.querySelectorAll('.conditional-field').forEach(el => el.style.display = 'none');
        // Limpa os campos de carga din√¢micos
        document.getElementById('cargas-dinamicas-container').innerHTML = '';
    }

    // Submit do formul√°rio de Moagem
    window.handleFormMoagemSubmit = async function(event) {
        event.preventDefault();

        // 1. Coletar Dados do Formul√°rio
        const form = event.target;
        const data = form.dataMoagem.value;
        const turno = form.turnoMoagem.value;
        const operador = form.operadorMoagem.value;

        // a. Cargas Din√¢micas
        let cargas = [];
        let pesoTotalCargas = 0;
        const qtdCargas = parseInt(form.qtdCargasMoagem.value) || 0;
        for (let i = 1; i <= qtdCargas; i++) {
            const moinho = document.getElementById(`moinho_${i}`).value;
            const peso = parseFloat(document.getElementById(`peso_${i}`).value) || 0;
            cargas.push({ moinho, peso });
            pesoTotalCargas += peso;
        }

        // b. Atividades Operador
        const qtdDescarga = parseInt(form.qtdDescarga.value) || 0;
        const qtdCargasSubidas = parseInt(form.qtdCargasSubidas.value) || 0; // Novo
        const guardouMateria = form.guardouMateria.value === 'sim';
        const qtdGuardouMateria = guardouMateria ? (parseInt(form.qtdGuardouMateria.value) || 0) : 0;
        const arrumouBox = form.arrumouBox.value === 'sim';
        const carregouCaminhaoCaco = form.carregouCaco.value === 'sim'; // Corrigido 'carregouCaco'
        const subiuMassa = form.subiuMassa.value === 'sim';
        const qtdSubiuMassa = subiuMassa ? (parseInt(form.qtdSubiuMassa.value) || 0) : 0;
        const desceuCacamba = form.desceuCacamba.value === 'sim';
        const qtdDesceuCacamba = desceuCacamba ? (parseInt(form.qtdDesceuCacamba.value) || 0) : 0;
        const virouCacamba = form.virouCacamba.value === 'sim';
        const qtdVirouCacamba = virouCacamba ? (parseInt(form.qtdVirouCacamba.value) || 0) : 0;
        
        // c. Atividades Auxiliar
        const lavouPeneira = form.lavouPeneira.value === 'sim';
        const limpouMoinho = form.limpouMoinho.value === 'sim';
        const lavouPeneiraDosador = form.lavouPeneiraDosador.value === 'sim';
        
        // d. Observa√ß√£o
        const observacao = form.observacaoMoagem.value;
        
        // 2. Calcular Pontos
        // a. Pontos por Carga (Peso) - L√ìGICA ATUALIZADA AQUI
        const pontosCargas = (pesoTotalCargas / 1000) * appConfigMoagem.pontosKgMoagem;

        // b. Pontos por Atividades
        let pontosAtividades = 0;
        pontosAtividades += qtdDescarga * appConfigMoagem.pontosDescarga;
        pontosAtividades += qtdCargasSubidas * appConfigMoagem.pontosCargasSubidas; // Novo
        pontosAtividades += qtdGuardouMateria * appConfigMoagem.pontosGuardouMateria;
        pontosAtividades += qtdSubiuMassa * appConfigMoagem.pontosSubiuMassa;
        pontosAtividades += qtdDesceuCacamba * appConfigMoagem.pontosDesceuCacamba;
        pontosAtividades += qtdVirouCacamba * appConfigMoagem.pontosVirouCacamba;
        if (arrumouBox) pontosAtividades += appConfigMoagem.pontosArrumouBox;
        if (carregouCaminhaoCaco) pontosAtividades += appConfigMoagem.pontosCarregouCaco;
        if (lavouPeneira) pontosAtividades += appConfigMoagem.pontosLavouPeneira;
        if (limpouMoinho) pontosAtividades += appConfigMoagem.pontosLimpouMoinho;
        if (lavouPeneiraDosador) pontosAtividades += appConfigMoagem.pontosLavouPeneiraDosador;

        const pontosTotal = pontosCargas + pontosAtividades;

        // 3. Montar Objeto para Salvar
        const novoRegistroMoagem = {
            data, turno, operador,
            cargas, pesoTotalCargas,
            qtdDescarga, qtdCargasSubidas, // Novo
            guardouMateria, qtdGuardouMateria,
            arrumouBox,
            carregouCaminhaoCaco,
            subiuMassa, qtdSubiuMassa,
            desceuCacamba, qtdDesceuCacamba,
            virouCacamba, qtdVirouCacamba,
            lavouPeneira, limpouMoinho, lavouPeneiraDosador,
            observacao,
            pontosCargas, pontosAtividades, pontosTotal,
            configuracaoPontosUsada: appConfigMoagem, // Salva a config usada no dia
            timestamp: new Date().toISOString()
        };

        // 4. Salvar no Firebase
        try {
            await window.addDoc(window.moagemCol, novoRegistroMoagem);
            alert('Atividade de Moagem lan√ßada com sucesso! ‚úÖ');
            renderizarHistoricoMoagem();
            limparFormMoagem();
        } catch (error) {
            console.error("Erro ao salvar atividade de moagem:", error);
            alert("Erro ao salvar. Verifique o console. ‚ùå");
        }
    }
    
    // --- MODAL 2: Config Moagem (Pontua√ß√£o) ---
    function openConfigMoagemModal() {
        // Carrega os valores atuais para o modal
        document.getElementById('pontosKgMoagem').value = appConfigMoagem.pontosKgMoagem;
        document.getElementById('pontosDescarga').value = appConfigMoagem.pontosDescarga;
        document.getElementById('pontosCargasSubidas').value = appConfigMoagem.pontosCargasSubidas; // Novo
        document.getElementById('pontosGuardouMateria').value = appConfigMoagem.pontosGuardouMateria;
        document.getElementById('pontosArrumouBox').value = appConfigMoagem.pontosArrumouBox;
        document.getElementById('pontosCarregouCaco').value = appConfigMoagem.pontosCarregouCaco;
        document.getElementById('pontosSubiuMassa').value = appConfigMoagem.pontosSubiuMassa;
        document.getElementById('pontosDesceuCacamba').value = appConfigMoagem.pontosDesceuCacamba;
        document.getElementById('pontosVirouCacamba').value = appConfigMoagem.pontosVirouCacamba;
        document.getElementById('pontosLavouPeneira').value = appConfigMoagem.pontosLavouPeneira;
        document.getElementById('pontosLimpouMoinho').value = appConfigMoagem.pontosLimpouMoinho;
        document.getElementById('pontosLavouPeneiraDosador').value = appConfigMoagem.pontosLavouPeneiraDosador;
        document.getElementById('metaPontosMoagem').value = appConfigMoagem.metaPontosMoagem; // Meta
        
        document.getElementById('configMoagemModal').style.display = 'flex';
    }
    function closeConfigMoagemModal(event, force = false) {
        if (force || event.target.id === 'configMoagemModal') {
            document.getElementById('configMoagemModal').style.display = 'none';
            document.getElementById('configSenhaMoagem').value = ''; // Limpa senha
        }
    }
    async function salvarConfigPontosMoagem() {
        if (document.getElementById('configSenhaMoagem').value !== 'pb2025') {
            alert('Senha incorreta!'); return;
        }
        
        const newConfig = {
            pontosKgMoagem: parseFloat(document.getElementById('pontosKgMoagem').value) || 0,
            pontosDescarga: parseFloat(document.getElementById('pontosDescarga').value) || 0,
            pontosCargasSubidas: parseFloat(document.getElementById('pontosCargasSubidas').value) || 0, // Novo
            pontosGuardouMateria: parseFloat(document.getElementById('pontosGuardouMateria').value) || 0,
            pontosArrumouBox: parseFloat(document.getElementById('pontosArrumouBox').value) || 0,
            pontosCarregouCaco: parseFloat(document.getElementById('pontosCarregouCaco').value) || 0,
            pontosSubiuMassa: parseFloat(document.getElementById('pontosSubiuMassa').value) || 0,
            pontosDesceuCacamba: parseFloat(document.getElementById('pontosDesceuCacamba').value) || 0,
            pontosVirouCacamba: parseFloat(document.getElementById('pontosVirouCacamba').value) || 0,
            pontosLavouPeneira: parseFloat(document.getElementById('pontosLavouPeneira').value) || 0,
            pontosLimpouMoinho: parseFloat(document.getElementById('pontosLimpouMoinho').value) || 0,
            pontosLavouPeneiraDosador: parseFloat(document.getElementById('pontosLavouPeneiraDosador').value) || 0,
            metaPontosMoagem: parseFloat(document.getElementById('metaPontosMoagem').value) || 0 // Meta
        };
        
        try {
            const configDocRef = window.doc(db, "configuracoes", "moagemConfig");
            await window.setDoc(configDocRef, newConfig, { merge: true });
            appConfigMoagem = newConfig; // Atualiza a vari√°vel global
            alert('Configura√ß√µes de Pontua√ß√£o (Moagem) salvas com sucesso!');
            closeConfigMoagemModal({target: {id: 'configMoagemModal'}}, true);
            renderizarHistoricoMoagem(); // Atualiza hist√≥rico para refletir novas metas
        } catch (error) {
            console.error("Erro ao salvar configura√ß√µes de pontua√ß√£o:", error);
            alert("Erro ao salvar configura√ß√µes.");
        }
    }
    async function carregarConfigPontosMoagem() {
        try {
            const configDocRef = window.doc(db, "configuracoes", "moagemConfig");
            const docSnap = await window.getDoc(configDocRef);
            if (docSnap.exists()) {
                // Mescla o salvo com os defaults, garantindo que novos campos existam
                appConfigMoagem = { ...appConfigMoagem, ...docSnap.data() };
            }
        } catch(error) {
            console.error("Erro ao carregar configura√ß√µes de pontua√ß√£o:", error);
        }
    }
    
    // Renderizar Hist√≥rico de Moagem
    async function renderizarHistoricoMoagem() {
        const tbody = document.getElementById('tabelaHistoricoMoagem');
        tbody.innerHTML = `<tr><td colspan="9">Carregando...</td></tr>`; // <!-- COLSPAN ATUALIZADO -->
        try {
            // L√≥gica de filtro (que j√° existia)
            const filtroDataInicio = document.getElementById('filtroDataInicioMoagem').value;
            const filtroDataFim = document.getElementById('filtroDataFimMoagem').value;
            const filtroTurno = document.getElementById('filtroTurnoMoagem').value;
            let queryConstraints = [orderBy("data", "desc"), orderBy("timestamp", "desc")];
            if (filtroDataInicio) queryConstraints.push(where("data", ">=", filtroDataInicio));
            if (filtroDataFim) queryConstraints.push(where("data", "<=", filtroDataFim));
            if (filtroTurno) queryConstraints.push(where("turno", "==", filtroTurno));

            const q = query(window.moagemCol, ...queryConstraints); // Aplicando filtros
            const querySnapshot = await getDocs(q);
            tbody.innerHTML = '';
            if (querySnapshot.empty) {
                 tbody.innerHTML = `<tr><td colspan="9">Nenhum lan√ßamento de moagem encontrado.</td></tr>`; // <!-- COLSPAN ATUALIZADO -->
                 return;
            }
            querySnapshot.forEach(doc => {
                const reg = doc.data();
                const docId = doc.id;
                
                // --- C√ÅLCULO % META ---
                // Pega a meta que estava configurada NO MOMENTO do lan√ßamento
                const configUsada = reg.configuracaoPontosUsada || appConfigMoagem; // Fallback
                const metaUsada = configUsada.metaPontosMoagem || appConfigMoagem.metaPontosMoagem;
                const pontos = reg.pontosTotal || 0;
                const percMeta = (metaUsada > 0) ? (pontos / metaUsada) * 100 : 0;
                const metaClass = getEficClass(percMeta); // Reusa a fun√ß√£o de classe global
                // --- FIM C√ÅLCULO ---

                const trPrincipal = document.createElement('tr');
                trPrincipal.innerHTML = `
                    <td><button class="expand-btn" onclick="toggleDetalhes('detalhes-moagem-${docId}', this)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></button></td>
                    <td>${new Date(reg.data + 'T03:00:00').toLocaleDateString('pt-BR')}</td>
                    <td>${reg.turno}</td>
                    <td>${reg.operador}</td>
                    <td>${reg.cargas ? reg.cargas.length : 0}</td>
                    <td>${reg.pesoTotalCargas ? reg.pesoTotalCargas.toFixed(2) : '0.00'} kg</td>
                    <td style="font-weight: bold; color: var(--primary);">${pontos.toFixed(2)}</td>
                    <td class="${metaClass}">${percMeta.toFixed(2)}%</td> <!-- C√âLULA 8: % Meta -->
                    <td>
                        <button class="delete-btn" onclick="deletarRegistroMoagem('${docId}')">Excluir</button>
                    </td> <!-- C√âLULA 9: A√ß√µes -->
                `;
                
                // --- Detalhes ---
                const trDetalhes = document.createElement('tr');
                trDetalhes.id = `detalhes-moagem-${docId}`; // ID √∫nico
                trDetalhes.className = 'linha-detalhes';
                
                // Formatar Cargas
                let cargasHtml = 'Nenhuma';
                if (reg.cargas && reg.cargas.length > 0) {
                    cargasHtml = reg.cargas.map(c => `Moinho ${c.moinho}: ${c.peso} kg`).join('<br>');
                }
                
                // Formatar Atividades
                const simNao = (val) => val ? 'Sim' : 'N√£o';
                const qtd = (val) => val || 0;
                
                trDetalhes.innerHTML = `
                    <td colspan="9"> <!-- COLSPAN ATUALIZADO -->
                        <div class="detalhe-grid">
                            <div><span>Pontos (Cargas):</span> ${reg.pontosCargas ? reg.pontosCargas.toFixed(2) : '0.00'}</div>
                            <div><span>Pontos (Ativ.):</span> ${reg.pontosAtividades ? reg.pontosAtividades.toFixed(2) : '0.00'}</div>
                            <div><span>Meta (no dia):</span> ${metaUsada.toFixed(0)} pts</div>
                            <div><span>Descargas:</span> ${qtd(reg.qtdDescarga)}</div>
                            <div><span>Cargas Subidas:</span> ${qtd(reg.qtdCargasSubidas)}</div> <!-- CAMPO ADICIONADO -->
                            <div><span>Guardou Mat√©ria:</span> ${simNao(reg.guardouMateria)} (${qtd(reg.qtdGuardouMateria)} un)</div>
                            <div><span>Arrumou Box:</span> ${simNao(reg.arrumouBox)}</div>
                            <div><span>Carregou Caco:</span> ${simNao(reg.carregouCaminhaoCaco)}</div>
                            <div><span>Subiu Massa:</span> ${simNao(reg.subiuMassa)} (${qtd(reg.qtdSubiuMassa)} un)</div>
                            <div><span>Desceu Ca√ßamba:</span> ${simNao(reg.desceuCacamba)} (${qtd(reg.qtdDesceuCacamba)} un)</div>
                            <div><span>Virou Ca√ßamba:</span> ${simNao(reg.virouCacamba)} (${qtd(reg.qtdVirouCacamba)} un)</div>
                            <div><span>Lavou Peneira:</span> ${simNao(reg.lavouPeneira)}</div>
                            <div><span>Limpou Moinho:</span> ${simNao(reg.limpouMoinho)}</div>
                            <div><span>Lavou Peneira/Dosador:</span> ${simNao(reg.lavouPeneiraDosador)}</div>
                        </div>
                        <div class="detalhe-grid" style="margin-top: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                            <div style="grid-column: 1 / 2;"><span>Cargas:</span> ${cargasHtml}</div>
                            <div style="grid-column: 2 / -1;"><span>Observa√ß√£o:</span> ${reg.observacao || 'Nenhuma'}</div>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(trPrincipal);
                tbody.appendChild(trDetalhes);
            });
        } catch(error) {
             console.error("Erro ao carregar hist√≥rico de moagem:", error);
             tbody.innerHTML = `<tr><td colspan="9">Erro ao carregar dados.</td></tr>`; // <!-- COLSPAN ATUALIZADO -->
        }
    }
    
    window.deletarRegistroMoagem = async function(docId) {
        const t=prompt("Para confirmar a exclus√£o, digite a senha:");
        if(null!==t&&"pb2025"!==t) alert("Senha incorreta. Exclus√£o cancelada.");
        else if(confirm("Tem certeza que deseja excluir este lan√ßamento (MOAGEM) do banco de dados?")) {
            try{
                await window.deleteDoc(window.doc(db,"producao_moagem", docId));
                alert("Registro exclu√≠do com sucesso!");
                renderizarHistoricoMoagem(); // Atualiza a tabela de moagem
            } catch(d) {
                console.error("Erro ao deletar do Firebase: ",d);
                alert("Erro ao excluir. Verifique o console.");
            }
        }
    };

    // --- L√ìGICA ABA 3: Pesagem ---
    
    document.getElementById('formPesagem').addEventListener('submit', async function(event) {
        event.preventDefault();
        const novoRegistro = {
            data: document.getElementById('dataPesagem').value,
            codigo: document.getElementById('codigoPalete').value.trim().toUpperCase(),
            peso: parseFloat(document.getElementById('pesoTotalPalete').value),
            timestamp: new Date().toISOString()
        };
        if(!novoRegistro.codigo) {
            alert("O c√≥digo do palete n√£o pode estar em branco.");
            return;
        }
        try {
            await window.addDoc(window.pesagemCol, novoRegistro);
            alert('Pesagem lan√ßada com sucesso! ‚úÖ');
            renderizarHistoricoPesagem();
            carregarOpcoesPaletes();
            this.reset();
            document.getElementById('dataPesagem').value = obterDataLocalFormatada();
        } catch (error) {
            console.error("Erro ao salvar pesagem:", error);
            alert("Erro ao salvar a pesagem. ‚ùå");
        }
    });
    
    // --- L√ìGICA ABA 5: Operadores ---
    
    function limparFormOperador() {
        document.getElementById('formCadastroOperador').reset();
        document.getElementById('dataCadastroOperador').value = obterDataLocalFormatada();
    }
    
    // Salvar novo operador
    window.handleCadastroOperadorSubmit = async function(event) {
        event.preventDefault();
        const novoOperador = {
            dataInicio: document.getElementById('dataCadastroOperador').value,
            nome: document.getElementById('nomeOperador').value.trim(),
            turno: document.getElementById('turnoOperador').value,
            timestamp: new Date().toISOString()
        };
        
        if (!novoOperador.nome || !novoOperador.turno) {
            alert("Nome e Turno s√£o obrigat√≥rios.");
            return;
        }
        
        try {
            await window.addDoc(window.operadoresCol, novoOperador);
            alert('Operador cadastrado com sucesso! ‚úÖ');
            renderizarHistoricoOperadores();
            carregarOperadoresDropdown(); // Atualiza o dropdown na aba Moagem
            limparFormOperador();
        } catch (error) {
            console.error("Erro ao cadastrar operador:", error);
            alert("Erro ao salvar. Verifique o console. ‚ùå");
        }
    }
    
    // Carregar operadores na tabela
    async function renderizarHistoricoOperadores() {
        const tbody = document.getElementById('tabelaOperadoresBody');
        tbody.innerHTML = `<tr><td colspan="4">Carregando...</td></tr>`;
        try {
            const q = query(window.operadoresCol, orderBy("nome", "asc"));
            const querySnapshot = await getDocs(q);
            tbody.innerHTML = '';
            if (querySnapshot.empty) {
                 tbody.innerHTML = `<tr><td colspan="4">Nenhum operador cadastrado.</td></tr>`;
                 return;
            }
            querySnapshot.forEach(doc => {
                const reg = doc.data();
                const docId = doc.id;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(reg.dataInicio + 'T03:00:00').toLocaleDateString('pt-BR')}</td>
                    <td>${reg.nome}</td>
                    <td>${reg.turno}</td>
                    <td>
                        <button class="delete-btn" onclick="deletarOperador('${docId}')">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch(error) {
             console.error("Erro ao carregar hist√≥rico de operadores:", error);
             tbody.innerHTML = `<tr><td colspan="4">Erro ao carregar dados.</td></tr>`;
        }
    }
    
    // Deletar operador
    window.deletarOperador = async function(docId) {
        const t=prompt("Para confirmar a exclus√£o, digite a senha:");
        if(null!==t&&"pb2025"!==t) alert("Senha incorreta. Exclus√£o cancelada.");
        else if(confirm("Tem certeza que deseja excluir este OPERADOR do banco de dados?")) {
            try{
                await window.deleteDoc(window.doc(db, "operadores_moagem", docId));
                alert("Operador exclu√≠do com sucesso!");
                renderizarHistoricoOperadores();
                carregarOperadoresDropdown(); // Atualiza o dropdown
            } catch(d) {
                console.error("Erro ao deletar operador: ",d);
                alert("Erro ao excluir. Verifique o console.");
            }
        }
    };
    
    // Carregar operadores no dropdown da aba Moagem
    async function carregarOperadoresDropdown() {
        const select = document.getElementById('operadorMoagem');
        select.innerHTML = '<option value="">Carregando...</option>';
        try {
            const q = query(window.operadoresCol, orderBy("nome", "asc"));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                select.innerHTML = '<option value="">Nenhum operador cadastrado</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Selecione um operador</option>';
            querySnapshot.forEach(doc => {
                const op = doc.data();
                const option = document.createElement('option');
                option.value = op.nome;
                option.textContent = `${op.nome} (${op.turno})`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error("Erro ao carregar dropdown de operadores:", error);
            select.innerHTML = '<option value="">Erro ao carregar</option>';
        }
    }


    // --- L√ìGICA ABA 4: Dashboard (Filtro Prensa) ---
    let pieChartTurnosInstance, barChartMensalInstance;

    async function atualizarDashboard() {
        const dataInicio = document.getElementById('dashFiltroDataInicio').value;
        const dataFim = document.getElementById('dashFiltroDataFim').value;
        const turno = document.getElementById('dashFiltroTurno').value;
        if (!dataInicio || !dataFim) {
            console.warn("Dashboard: Datas de in√≠cio e fim s√£o necess√°rias.");
            return;
        }
        ['kpiTotalMeta', 'kpiTotalRealizado', 'kpiEficiencia', 'kpiRetrabalho'].forEach(id => document.getElementById(id).textContent = '...');
        try {
            let qConstraints = [where("data", ">=", dataInicio), where("data", "<=", dataFim)];
            if (turno) qConstraints.push(where("turno", "==", turno));
            const q = query(window.massaCol, ...qConstraints);
            const querySnapshot = await getDocs(q);
            const dados = querySnapshot.docs.map(doc => doc.data());
            calcularKPIs(dados);
            gerarGraficoPizzaTurnos(dados);
        } catch (error) {
            console.error("Erro ao atualizar dashboard:", error);
            alert("N√£o foi poss√≠vel carregar os dados do dashboard.");
        }
    }

    function calcularKPIs(dados) {
        const totais = dados.reduce((acc, reg) => {
            acc.meta += reg.metaKgFT || 0;
            acc.realizado += reg.kgCalculado || 0;
            acc.retrabalho += reg.retrabalhoKg || 0;
            return acc;
        }, { meta: 0, realizado: 0, retrabalho: 0 });
        const eficiencia = totais.meta > 0 ? (totais.realizado / totais.meta) * 100 : 0;
        document.getElementById('kpiTotalMeta').textContent = totais.meta.toLocaleString('pt-BR', { maximumFractionDigits: 0 });
        document.getElementById('kpiTotalRealizado').textContent = totais.realizado.toLocaleString('pt-BR', { maximumFractionDigits: 0 });
        const eficienciaEl = document.getElementById('kpiEficiencia');
        eficienciaEl.textContent = `${eficiencia.toFixed(2)}%`;
        eficienciaEl.className = 'value';
        if (eficiencia >= 98) eficienciaEl.classList.add('good'); else eficienciaEl.classList.add('bad');
        document.getElementById('kpiRetrabalho').textContent = totais.retrabalho.toLocaleString('pt-BR', { maximumFractionDigits: 0 });
    }

    function gerarGraficoPizzaTurnos(dados) {
        const producaoPorTurno = dados.reduce((acc, reg) => {
            if (!acc[reg.turno]) acc[reg.turno] = 0;
            acc[reg.turno] += reg.kgPalete || 0;
            return acc;
        }, {});
        if (pieChartTurnosInstance) pieChartTurnosInstance.destroy();
        const ctx = document.getElementById('pieChartTurnos').getContext('2d');
        pieChartTurnosInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(producaoPorTurno),
                datasets: [{
                    label: 'Produ√ß√£o (kg)',
                    data: Object.values(producaoPorTurno),
                    backgroundColor: ['#0077cc', '#28a745', '#ff9900', '#dc3545', '#6c757d', '#17a2b8', '#f012be'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    datalabels: {
                        formatter: (value, ctx) => {
                            const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            if (sum === 0) return '0.00%';
                            const percentage = (value * 100 / sum).toFixed(2) + '%';
                            return percentage;
                        },
                        color: '#fff',
                        font: { weight: 'bold', size: 14 }
                    }
                }
            }
        });
    }

    async function gerarGraficoProducaoMensal() {
        const turnoFiltro = document.getElementById('filtroTurnoGraficoMes').value;
        const hoje = new Date();
        const dozeMesesAtras = new Date(hoje.getFullYear() - 1, hoje.getMonth(), 1);
        const dataInicioStr = dozeMesesAtras.toISOString().split('T')[0];
        try {
            let qConstraints = [where("data", ">=", dataInicioStr)];
            if (turnoFiltro) qConstraints.push(where("turno", "==", turnoFiltro));
            const q = query(window.massaCol, ...qConstraints);
            const querySnapshot = await getDocs(q);
            const dados = querySnapshot.docs.map(doc => doc.data());
            const producaoPorMes = {};
            for(let i=0; i<12; i++) {
                const d = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                producaoPorMes[`${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`] = 0;
            }
            dados.forEach(reg => {
                const mesAno = reg.data.substring(0, 7);
                if (producaoPorMes[mesAno] !== undefined) producaoPorMes[mesAno] += reg.kgPalete;
            });
            const labels = Object.keys(producaoPorMes).reverse();
            const data = Object.values(producaoPorMes).reverse();
            const labelsFormatados = labels.map(l => `${l.substring(5, 7)}/${l.substring(2, 4)}`);
            if (barChartMensalInstance) barChartMensalInstance.destroy();
            const ctx = document.getElementById('barChartMensal').getContext('2d');
            barChartMensalInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labelsFormatados,
                    datasets: [{
                        label: 'Produ√ß√£o Total (kg)',
                        data: data,
                        backgroundColor: 'rgba(0, 119, 204, 0.7)',
                        borderColor: 'rgba(0, 119, 204, 1)',
                        borderWidth: 1
                    }]
                },
                options: { 
                    scales: { y: { beginAtZero: true } },
                    plugins: {
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#444',
                            font: { weight: 'bold' },
                            formatter: (value) => {
                                return value > 0 ? value.toLocaleString('pt-BR') : '';
                            }
                        }
                    }
                }
            });
        } catch (error) { console.error("Erro ao gerar gr√°fico mensal:", error); }
    }

    // --- FUN√á√ÉO GLOBAL DE EXPANDIR/RECOLHER ---
    // rowId √© o ID da TR de detalhes (ex: 'detalhes-fp-123' ou 'detalhes-moagem-456')
    // btn √© o elemento <button> clicado (passado com 'this')
    window.toggleDetalhes = function(rowId, btn) {
        const detalhesRow = document.getElementById(rowId);
        if (!detalhesRow || !btn) return;
        
        if (detalhesRow.style.display === "table-row") {
            detalhesRow.style.display = "none";
            btn.classList.remove('open'); // Remove a classe que gira o √≠cone
        } else {
            detalhesRow.style.display = "table-row";
            btn.classList.add('open'); // Adiciona a classe que gira o √≠cone
        }
    };
    
    // --- FUN√á√ïES DE DELE√á√ÉO (ESPEC√çFICAS) ---
    
    // Deletar Filtro Prensa
    window.deletarRegistro = async function(docId) { // 'd' renomeado para 'docId'
        const t=prompt("Para confirmar a exclus√£o, digite a senha:");
        if(null!==t&&"pb2025"!==t) alert("Senha incorreta. Exclus√£o cancelada.");
        else if(confirm("Tem certeza que deseja excluir este lan√ßamento (FILTRO PRENSA) do banco de dados?")) {
            try{
                await window.deleteDoc(window.doc(db,"producao_massa", docId)); // Usando docId
                alert("Registro exclu√≠do com sucesso!");
                renderizarHistorico();
            } catch(d) {
                console.error("Erro ao deletar do Firebase: ",d);
                alert("Erro ao excluir. Verifique o console.");
            }
        }
    };
    
    // Deletar Pesagem (j√° estava na lista de fun√ß√µes duplicadas)
    async function renderizarHistoricoPesagem(){
        const d=document.getElementById("tabelaPesagemBody");
        d.innerHTML='<tr><td colspan="4">Carregando dados...</td></tr>';
        try{
            const t=await window.getDocs(window.query(window.pesagemCol,window.orderBy("codigo")));
            if(d.innerHTML="",t.empty){
                d.innerHTML='<tr><td colspan="4">Nenhum registro de pesagem encontrado.</td></tr>';
                return;
            }
            t.forEach(t=>{
                const o=t.data(),e=t.id,n=document.createElement("tr");
                n.innerHTML=`
 <td>${new Date(o.data+"T03:00:00").toLocaleDateString("pt-BR")}</td>
 <td>${o.codigo}</td>
 <td>${o.peso.toFixed(2)} kg</td>
 <td>
 <button class="edit-btn" onclick='editarRegistroPesagem("${e}", ${JSON.stringify(o)})'>Editar</button>
 <button class="delete-btn" onclick="deletarRegistroPesagem('${e}')">Excluir</button>
 </td>
 `,d.appendChild(n)
            });
        } catch(t) {
            console.error("Erro ao buscar hist√≥rico de pesagem: ",t);
            d.innerHTML='<tr><td colspan="4">Erro ao carregar dados.</td></tr>';
        }
    };
    
    window.editarRegistroPesagem=async function(d,t){
        const o=prompt("Para editar, por favor, insira a senha:");
        if("pb2025"!==o)return void alert("Senha incorreta. Opera√ß√£o cancelada.");
        const e=prompt("Editar Data (AAAA-MM-DD):",t.data);
        if(null===e)return;
        const n=prompt("Editar C√≥digo:",t.codigo);
        if(null===n)return;
        const a=prompt("Editar Peso (kg):",t.peso);
        if(null===a)return;
        const r={...t,data:e,codigo:n.trim().toUpperCase(),peso:parseFloat(a)};
        if(isNaN(r.peso)||!r.codigo)return void alert("Dados inv√°lidos. A edi√ß√£o foi cancelada.");
        try{
            await window.setDoc(window.doc(db,"pesagem_paletes",d),r),alert("Registro atualizado com sucesso!"),renderizarHistoricoPesagem(),carregarOpcoesPaletes()
        } catch(d) {
            console.error("Erro ao atualizar registro: ",d),alert("Falha ao atualizar o registro.")
        }
    };
    
    window.deletarRegistroPesagem=async function(d){
        const t=prompt("Para excluir, por favor, insira a senha:");
        if("pb2025"!==t)return void alert("Senha incorreta. Opera√ß√£o cancelada.");
        if(confirm("Tem certeza que deseja excluir este registro de pesagem?"))
        try{
            await window.deleteDoc(window.doc(db,"pesagem_paletes",d)),alert("Registro exclu√≠do com sucesso!"),renderizarHistoricoPesagem(),carregarOpcoesPaletes()
        } catch(d) {
            console.error("Erro ao excluir registro de pesagem:",d),alert("Falha ao excluir o registro.")
        }
    };
    
    // Exportar Excel (Filtro Prensa)
    async function exportarExcel(){
        alert("Preparando o arquivo Excel com dados do Firebase (Filtro Prensa)...");
        const d=document.getElementById("filtroDataInicio").value,t=document.getElementById("filtroDataFim").value,o=document.getElementById("filtroTurno").value;
        let e=[window.orderBy("data","desc"),window.orderBy("timestamp","desc")];
        d&&e.push(window.where("data",">=",d)),t&&e.push(window.where("data","<=",t)),o&&e.push(window.where("turno","==",o));
        try{
            const d=await window.getDocs(window.query(window.massaCol,...e)),t=d.docs.map(d=>d.data());
            if(0===t.length)return void alert("Nenhum dado encontrado para exportar.");
            const o=t.map(d=>{
                var t;
                const o=d.metaKgFT||appConfig.metaKgFT,e=d.metaKgPalete||appConfig.metaKgPalete,n=(null!==(t=d.retrabalhoKg)?t:d.kgPalete-d.kgCalculado);
                return{
                    'Data':new Date(d.data+"T03:00:00").toLocaleDateString("pt-BR"),
                    'Turno':d.turno,
                    'Qtd Filtros (FT)':d.qtdFT,
                    'Qtd Placas':d.qtdPlacas,
                    'KG Calculado':d.kgCalculado.toFixed(2),
                    'KG Palete (Real)':d.kgPalete.toFixed(2),
                    'Retrabalho (kg)':n.toFixed(2),
                    'Meta FT (kg)':o.toFixed(2),
                    'Meta Palete (kg)':e.toFixed(2),
                    '% Efici√™ncia FT':(d.kgCalculado/(o||1)*100).toFixed(2)+"%",
                    '% Efici√™ncia Palete':(d.kgPalete/(e||1)*100).toFixed(2)+"%",
                    'Observa√ß√£o':d.observacao
                }
            }),n=XLSX.utils.json_to_sheet(o),a=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(a,n,"Hist√≥rico de Massa"),XLSX.writeFile(a,`Historico_Massa_${obterDataLocalFormatada()}.xlsx`)
        } catch(d) {
            console.error("Erro ao exportar dados do Firebase: ",d),
            alert("Ocorreu um erro ao preparar o arquivo.")
        }
    };
    
    // --- INICIALIZA√á√ÉO DA P√ÅGINA ---
    document.addEventListener('DOMContentLoaded', async () => {
        const hojeStr = obterDataLocalFormatada();
        // Adicionado 'dataCadastroOperador' e filtros de moagem √† lista de campos de data
        ['data', 'filtroDataInicio', 'filtroDataFim', 'dataPesagem', 'dashFiltroDataInicio', 'dashFiltroDataFim', 'dataMoagem', 'dataCadastroOperador', 'filtroDataInicioMoagem', 'filtroDataFimMoagem'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = hojeStr;
        });
        
        // Listeners Filtro Prensa
        document.querySelectorAll('.palete-select, .palete-qtd').forEach(el => el.addEventListener('input', calcularPesoTotalPaletes));
        ['filtroDataInicio', 'filtroDataFim', 'filtroTurno'].forEach(id => document.getElementById(id).addEventListener('change', renderizarHistorico));
        
        // Listeners Moagem
        document.getElementById('qtdCargasMoagem').addEventListener('input', atualizarCamposCargaMoagem);
        // Listeners para NOVOS FILTROS da Moagem
        ['filtroDataInicioMoagem', 'filtroDataFimMoagem', 'filtroTurnoMoagem'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('change', renderizarHistoricoMoagem);
        });
        
        // Listeners Dashboard
        ['dashFiltroDataInicio', 'dashFiltroDataFim', 'dashFiltroTurno'].forEach(id => document.getElementById(id).addEventListener('change', atualizarDashboard));
        document.getElementById('filtroTurnoGraficoMes').addEventListener('change', gerarGraficoProducaoMensal);
        
        // --- Carregamentos Iniciais ---
        await carregarConfiguracoes(); // Config Filtro Prensa
        await carregarConfigPontosMoagem(); // Config Moagem
        
        await carregarOpcoesPaletes(); // Dropdown paletes (Filtro Prensa)
        await carregarOperadoresDropdown(); // Dropdown operadores (Moagem)
        
        // Renderizar tabelas/hist√≥ricos
        renderizarHistorico();
        renderizarHistoricoPesagem();
        renderizarHistoricoMoagem();
        renderizarHistoricoOperadores();
        
        calcularPesoTotalPaletes(); // Calcular peso inicial (Filtro Prensa)
        
        // Renderizar Dashboard
        await atualizarDashboard();
        await gerarGraficoProducaoMensal();
        
        // Mostrar a primeira aba (Filtro Prensa) e esconder o bot√£o de config principal
        showTab('producao');
    });
    
    </script>
</body>
</html>
